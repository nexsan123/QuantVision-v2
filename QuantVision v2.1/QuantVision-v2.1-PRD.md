# QuantVision v2.1 产品需求文档 (PRD)

> **文档版本**: 1.0  
> **创建日期**: 2025-01-04  
> **项目阶段**: 功能完善与优化  
> **基于版本**: QuantVision v2.0 (Phase 8-14 已完成)

---

## 目录

1. [产品概述](#1-产品概述)
2. [用户痛点与需求来源](#2-用户痛点与需求来源)
3. [功能需求清单](#3-功能需求清单)
4. [详细功能设计](#4-详细功能设计)
5. [技术架构补充](#5-技术架构补充)
6. [优先级排序](#6-优先级排序)
7. [里程碑规划](#7-里程碑规划)

---

## 1. 产品概述

### 1.1 产品定位

QuantVision 是一款面向**专业量化交易者、机构投资者、日内交易者**的美股量化交易平台，提供从因子研究、策略构建、回测验证到实盘执行的完整工作流。

### 1.2 目标用户

| 用户类型 | 特征 | 核心需求 |
|----------|------|----------|
| 初学者 | 了解基础投资概念 | 引导式策略创建、教育内容 |
| 进阶投资者 | 有交易经验 | 自定义因子、回测分析 |
| 专业量化交易者 | 编程能力强 | 高级因子、API接口 |
| 日内交易者 | 高频交易需求 | 低延迟执行、实时监控 |
| 小型机构 | 团队协作需求 | 多用户权限、审计日志 |

### 1.3 v2.1 核心目标

基于 v2.0 已完成的基础功能，v2.1 聚焦于：

1. **提升用户体验** - 解决实际使用痛点
2. **增强专业功能** - 因子验证、交易归因、税务计算
3. **保障交易安全** - 冲突检测、风险预警、备用通道
4. **扩展数据能力** - MCP新闻、多模型AI、更多数据源

---

## 2. 用户痛点与需求来源

### 2.1 已识别的用户痛点

| # | 痛点描述 | 来源 | 影响程度 |
|---|----------|------|:--------:|
| 1 | 保存策略后不知道在哪里查看 | 用户反馈 | 高 |
| 2 | 不知道AI助手是否已连接 | 用户反馈 | 中 |
| 3 | 运行回测后流程不清晰 | 用户反馈 | 中 |
| 4 | 初学者不知道如何配置策略 | 用户反馈 | 高 |
| 5 | 无法验证因子在历史上是否有效 | 专业需求 | 高 |
| 6 | 实盘亏损后不知道原因 | 专业需求 | 高 |
| 7 | 多策略同时运行可能冲突 | 专业需求 | 高 |
| 8 | 美股税务计算复杂 | 合规需求 | 中 |
| 9 | PDT规则限制日内交易 | 监管要求 | 高 |
| 10 | 系统故障时无备用方案 | 安全需求 | 高 |

---

## 3. 功能需求清单

### 3.1 功能模块总览

```
QuantVision v2.1
├── 📁 策略管理增强
│   ├── 我的策略列表
│   ├── 策略版本管理
│   └── 策略模板库 (含日内交易)
│
├── 🤖 AI助手升级
│   ├── 连接状态指示
│   ├── MCP多模型支持
│   ├── 引导式对话模式
│   └── 自动填写表单
│
├── 🔬 因子研究中心
│   ├── 因子有效性验证
│   ├── 因子历史统计
│   └── 因子对比分析
│
├── 💰 交易成本系统
│   ├── 成本配置面板
│   ├── 最低成本限制
│   └── Almgren-Chriss模型
│
├── 📊 交易归因系统
│   ├── 每笔交易记录
│   ├── 自动归因分析
│   ├── AI诊断建议
│   └── 历史数据保留
│
├── ⚠️ 风险控制系统
│   ├── 策略冲突检测
│   ├── 实盘vs回测监控
│   ├── 风险预警通知
│   └── PDT规则管理
│
├── 💵 税务合规系统
│   ├── 税务估算器
│   ├── Wash Sale检测
│   ├── 提现税务计算
│   └── 报表导出
│
├── 🔌 数据源扩展
│   ├── MCP新闻捕捉
│   ├── Interactive Brokers
│   └── 更多数据源
│
├── 📱 移动端App
│   ├── 策略监控
│   ├── 预警推送
│   └── 紧急操作
│
└── 🛡️ 系统保障
    ├── 企业级备份
    ├── 备用交易通道
    └── 99.9%可用性
```

### 3.2 功能优先级矩阵

| 功能 | 用户价值 | 开发复杂度 | 优先级 |
|------|:--------:|:----------:|:------:|
| 我的策略列表 | 高 | 低 | P0 |
| AI连接状态 | 中 | 低 | P0 |
| 回测流程优化 | 中 | 低 | P0 |
| 因子有效性验证 | 高 | 中 | P0 |
| 交易归因系统 | 高 | 高 | P0 |
| 策略冲突检测 | 高 | 中 | P0 |
| PDT规则管理 | 高 | 低 | P0 |
| 实盘vs回测监控 | 高 | 中 | P1 |
| 税务计算系统 | 中 | 中 | P1 |
| 风险预警通知 | 高 | 中 | P1 |
| MCP多模型支持 | 中 | 高 | P1 |
| MCP新闻捕捉 | 中 | 高 | P1 |
| 策略版本管理 | 中 | 中 | P1 |
| 引导式对话 | 高 | 高 | P1 |
| 移动端App | 中 | 高 | P2 |
| 备用交易通道 | 高 | 中 | P2 |
| 教育内容 | 低 | 低 | P3 |
| 多用户权限 | 低 | 高 | P3 |

---

## 4. 详细功能设计

### 4.1 我的策略列表

**需求描述**: 用户保存策略后，需要有明确的入口查看和管理已保存的策略。

**UI设计**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│  📋 我的策略                                    [+ 新建策略] [导入]     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  🔍 搜索策略...                    筛选: [全部 ▼] [运行中 ▼]            │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ ⭐ 价值投资策略 v1.2                                    运行中 🟢 │   │
│  │    类型: 长线 | 持仓: 12只 | 今日: +0.8% | 总收益: +15.3%        │   │
│  │    上次修改: 2025-01-02                                          │   │
│  │    [编辑] [回测] [暂停] [复制] [删除]                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │   动量突破策略                                          已暂停 🟡 │   │
│  │    类型: 短线 | 持仓: 0只 | 累计收益: +8.2%                      │   │
│  │    上次修改: 2024-12-28                                          │   │
│  │    [编辑] [回测] [启动] [复制] [删除]                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │   日内交易测试                                          草稿 ⚪   │   │
│  │    类型: 日内 | 未回测                                           │   │
│  │    上次修改: 2025-01-03                                          │   │
│  │    [编辑] [回测] [删除]                                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**功能要点**:
- 策略状态: 运行中/已暂停/草稿/回测中
- 快速操作: 编辑/回测/启停/复制/删除
- 关键指标: 持仓数、今日收益、总收益
- 版本标记: 显示当前版本号

---

### 4.2 AI连接状态指示

**需求描述**: 用户需要明确知道AI助手是否已连接并可用。

**UI设计**:

```
┌─────────────────────────────────────────────┐
│  策略助手                        ⚙️ 设置    │
├─────────────────────────────────────────────┤
│  🟢 AI已连接                                 │
│  当前模型: Claude 4.5 Sonnet                │
│  当前步骤: 投资池                            │
├─────────────────────────────────────────────┤
│                                             │
│  您现在进入了**投资池**步骤。                │
│                                             │
│  专业投资者不会随便买股票，他们首            │
│  先确定一个"可投资范围"...                  │
│                                             │
```

**状态定义**:
| 状态 | 图标 | 含义 |
|------|:----:|------|
| 已连接 | 🟢 | API正常，可以对话 |
| 连接中 | 🟡 | 正在建立连接 |
| 未连接 | 🔴 | 连接失败，点击重试 |
| 离线模式 | ⚪ | 使用本地功能 |

---

### 4.3 因子有效性验证系统

**需求描述**: 用户在选择因子前，需要了解该因子在历史上的表现。

**数据模型**:

```python
class FactorValidation(BaseModel):
    """因子验证结果"""
    factor_id: str                    # 因子ID
    factor_name: str                  # 因子名称
    factor_description: str           # 大白话描述
    
    # 统计指标
    ic_mean: float                    # IC均值 (信息系数)
    ic_ir: float                      # IC_IR (信息比率)
    long_annual_return: float         # 多头年化收益
    short_annual_return: float        # 空头年化收益
    long_short_spread: float          # 多空收益差
    
    # 有效性判定
    is_effective: bool                # 是否有效
    effectiveness_level: str          # 强/中/弱
    
    # 适用场景
    best_market_condition: str        # 最佳市场环境
    worst_market_condition: str       # 最差市场环境
    suggested_combination: list[str]  # 建议搭配因子
    
    # 元数据
    backtest_period: str              # 回测周期
    universe: str                     # 回测股票池
    updated_at: datetime              # 更新时间
```

**UI设计**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│  🔬 因子研究中心 - PE_TTM (市盈率)                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  📖 因子说明 (大白话)                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ PE越低，说明股价相对于公司盈利越便宜。                             │   │
│  │ 理论上：买入低PE股票，长期能获得超额收益（价值投资逻辑）            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  📊 历史回测验证 (2010-2024, S&P 500)                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ IC均值 (预测能力)：    0.045  ⭐⭐⭐ 中等偏弱                      │   │
│  │ IC_IR (稳定性)：       0.38   ⭐⭐⭐ 较稳定                        │   │
│  │ 多头年化收益：         12.3%                                       │   │
│  │ 空头年化收益：         6.1%                                        │   │
│  │ 多空收益差：           6.2%   ✅ 因子有效                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  🎯 实测结论                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ ✅ 该因子在美股市场【长期有效】                                    │   │
│  │ ⚠️ 在牛市后期表现较弱（成长股跑赢价值股）                          │   │
│  │ 💡 建议：配合质量因子(ROE)一起使用效果更佳                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  [查看详细报告]  [添加到策略]  [对比其他因子]                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 4.4 交易成本配置系统

**需求描述**: 专业用户需要自定义交易成本参数，但不能低于市场实际成本。

**成本参数**:

| 成本项 | 最低限制 | 默认值 | 说明 |
|--------|:--------:|:------:|------|
| 佣金 | $0.003/股 | $0.005/股 | 机构级别费率 |
| SEC费用 | $0.0000278/$ | $0.0000278/$ | 固定法规费用 |
| 滑点-大盘股 | 0.02% | 0.05% | 市值>100亿 |
| 滑点-中盘股 | 0.05% | 0.10% | 市值10-100亿 |
| 滑点-小盘股 | 0.15% | 0.25% | 市值<10亿 |
| 市场冲击 | 0.1×σ×√(V/ADV) | Almgren-Chriss | 基于波动率和成交量 |

**UI设计**:

```
┌─────────────────────────────────────────────────────────────────┐
│  💰 交易成本设置                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📊 成本模型：                                                   │
│     ○ 简单模式 (推荐新手)                                        │
│        固定滑点 0.1% + 佣金 $0.005/股                            │
│                                                                 │
│     ● 专业模式                                                   │
│        ┌───────────────────────────────────────────────────┐   │
│        │ 佣金         [  0.005  ] $/股      最低: 0.003    │   │
│        │ SEC费用      [0.0000278] $/交易额  (固定)         │   │
│        │ 滑点模型     [ Almgren-Chriss ▼ ]                 │   │
│        │   ├─ 大盘股  [  0.05  ] %          最低: 0.02%    │   │
│        │   ├─ 中盘股  [  0.10  ] %          最低: 0.05%    │   │
│        │   └─ 小盘股  [  0.25  ] %          最低: 0.15%    │   │
│        │ 市场冲击系数 [  0.1   ] × σ√(V/ADV)               │   │
│        └───────────────────────────────────────────────────┘   │
│                                                                 │
│  ⚠️ 提示：实际交易成本可能高于回测假设，建议预留20%成本缓冲       │
│                                                                 │
│  [恢复默认] [保存设置]                                           │
└─────────────────────────────────────────────────────────────────┘
```

---

### 4.5 交易归因与复盘系统

**需求描述**: 实盘/模拟盘运行时，自动记录每笔交易并定期生成归因分析报告。

**触发条件**:

| 策略类型 | 自动触发条件 | 异常触发 |
|----------|--------------|----------|
| 日内交易 | 每日收盘后 或 每50笔 | 单日亏损>2% |
| 短线(1-5天) | 每周 或 每20笔 | 连续3笔亏损 |
| 中线(1-4周) | 每月 或 每10笔 | 累计回撤>5% |
| 长线(>1月) | 每季度 或 每5笔 | 单笔亏损>3% |

**数据模型**:

```python
class TradeRecord(BaseModel):
    """交易记录"""
    trade_id: str
    strategy_id: str
    symbol: str
    
    # 交易信息
    entry_time: datetime
    entry_price: float
    entry_quantity: int
    exit_time: datetime | None
    exit_price: float | None
    
    # 入场时的因子值
    factor_values: dict[str, float]
    
    # 入场时的市场环境
    market_context: MarketContext
    
    # 盈亏
    pnl: float
    pnl_pct: float
    max_profit: float      # 持仓期间最大浮盈
    max_drawdown: float    # 持仓期间最大浮亏
    
    # 成本
    commission: float
    slippage: float
    total_cost: float

class AttributionReport(BaseModel):
    """归因报告"""
    report_id: str
    strategy_id: str
    period_start: date
    period_end: date
    
    # 整体表现
    total_return: float
    benchmark_return: float
    alpha: float
    win_rate: float
    profit_loss_ratio: float
    
    # 盈利交易分析
    winning_trades: list[TradeRecord]
    winning_patterns: list[str]     # 共同特征
    
    # 亏损交易分析
    losing_trades: list[TradeRecord]
    losing_patterns: list[str]      # 共同特征
    
    # AI诊断
    diagnosis: list[str]
    suggestions: list[str]
    
    # 元数据
    created_at: datetime
    is_saved: bool = True           # 永久保留
```

**UI设计**: (见前文详细设计)

---

### 4.6 策略冲突检测系统

**需求描述**: 多策略同时运行时，检测并处理信号冲突。

**冲突类型定义**:

| 冲突类型 | 定义 | 处理方式 |
|----------|------|----------|
| 逻辑冲突 | 同类型策略对同股票发出相反信号 | 必须人工决定 |
| 执行冲突 | 不同类型策略，同账户无法同时执行 | 智能建议顺序执行 |
| 无冲突 | 完全不同的股票 | 直接执行 |

**判定逻辑**:

```python
def detect_conflict(signal_a: Signal, signal_b: Signal) -> ConflictType:
    # 不同股票，无冲突
    if signal_a.symbol != signal_b.symbol:
        return ConflictType.NO_CONFLICT
    
    # 同方向，可合并执行
    if signal_a.direction == signal_b.direction:
        return ConflictType.NO_CONFLICT
    
    # 同策略类型，逻辑冲突
    if signal_a.strategy_type == signal_b.strategy_type:
        return ConflictType.LOGIC_CONFLICT
    
    # 不同策略类型，执行冲突
    return ConflictType.EXECUTION_CONFLICT
```

**超时设置**:

| 策略类型 | 超时时间 | 超时处理 |
|----------|:--------:|----------|
| 日内交易 | 1分钟 | 自动取消 |
| 短线策略 | 30分钟 | 自动取消 |
| 中长线策略 | 2小时 | 自动取消 |

**记录保留**: 所有冲突事件永久保留，供复盘分析。

---

### 4.7 PDT规则管理

**需求描述**: 美股日内交易受PDT规则限制，账户<$25,000每5天最多3次日内交易。

**功能设计**:

```
┌─────────────────────────────────────────────────────────────────┐
│  📊 账户交易限制                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  账户资金：$18,500                                               │
│  账户类型：现金账户 (< $25,000)                                   │
│                                                                 │
│  ⚠️ PDT限制生效中：                                              │
│  • 每5个交易日最多 3 次日内交易                                   │
│  • 本周已使用：2 次    剩余：1 次                                 │
│  • 重置时间：周三 (3天后)                                        │
│                                                                 │
│  功能限制：                                                      │
│  ├─ 盘前交易：❌ 不可用                                          │
│  ├─ 常规交易：✅ 9:30-16:00                                      │
│  └─ 盘后交易：❌ 不可用                                          │
│                                                                 │
│  💡 解锁完整功能：入金至 $25,000 以上                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**系统行为**:
- 日内交易次数达到限制时，阻止新的日内交易信号执行
- 提前预警：剩余1次时提醒用户
- 自动计算重置时间

---

### 4.8 实盘vs回测差异监控

**需求描述**: 监控策略漂移，当实盘表现与回测差异过大时预警。

**监控指标与阈值**:

| 监控项 | 预警阈值 | 严重阈值 |
|--------|:--------:|:--------:|
| 收益差异 | >10% | >20% |
| 胜率差异 | >5% | >10% |
| 换手率差异 | >20% | >35% |
| 滑点差异 | >30% | >50% |
| 最大回撤差异 | >15% | >25% |
| 持仓时间差异 | >25% | >40% |

**预警处理**:
- 黄色预警：发送邮件通知
- 红色预警：发送邮件 + 建议暂停策略

---

### 4.9 税务计算系统

**需求描述**: 帮助用户估算美股交易的税务负担。

**功能模块**:

1. **年度税务估算**
   - 短期/长期资本利得分类
   - 根据收入档位计算税率
   - 联邦税 + 州税估算

2. **Wash Sale检测**
   - 自动检测30天内买回的亏损股票
   - 标记不可抵税的损失

3. **提现税务计算**
   - 计算提现金额中的应税部分
   - 估算税后实际到手金额

4. **税务优化建议**
   - Tax Loss Harvesting机会
   - 长期持有税率优惠提醒

5. **报表导出**
   - PDF税务摘要
   - CSV交易明细
   - 1099-B格式辅助

**免责声明**: 系统估算仅供参考，实际税务请咨询专业会计师。

---

### 4.10 MCP多模型AI支持

**需求描述**: 通过MCP协议接入多个最新版本的大模型。

**架构设计**:

```
用户界面 (策略助手)
        │
        ▼
┌─────────────────────────────────────┐
│        MCP Gateway (中间层)          │
│   ┌─────────────────────────────┐   │
│   │  模型路由器                  │   │
│   │  - 根据任务类型选择最佳模型  │   │
│   │  - 自动切换到最新版本        │   │
│   └─────────────────────────────┘   │
└───────────────┬─────────────────────┘
                │
  ┌─────────────┼─────────────┬─────────────┐
  ▼             ▼             ▼             ▼
┌──────┐   ┌──────────┐   ┌────────┐   ┌─────────┐
│Claude│   │ GPT-4o   │   │Gemini  │   │ Llama   │
│ 4.5  │   │ Latest   │   │ 2.0    │   │ 3.3     │
└──────┘   └──────────┘   └────────┘   └─────────┘
```

**模型分工**:

| 任务类型 | 推荐模型 | 理由 |
|----------|----------|------|
| 策略对话/规划 | Claude 4.5 | 长上下文、逻辑推理强 |
| 代码生成 | GPT-4o | 代码能力强 |
| 数据分析 | Claude / Gemini | 表格理解好 |
| 新闻摘要 | GPT-4o-mini | 快速、低成本 |
| 本地部署 | Llama 3.3 | 隐私保护 |

---

### 4.11 MCP新闻捕捉

**需求描述**: 实时捕捉金融市场新闻，辅助交易决策。

**数据源**:
- Benzinga Pro (实时金融新闻)
- Alpha Vantage News
- FRED (宏观经济数据)

**功能**:
- 实时新闻推送
- AI自动摘要
- 影响分析（对持仓的潜在影响）
- 关键词订阅

---

### 4.12 系统可用性保障

**可用性目标**: 99.9% (每月停机 < 44分钟)

**故障处理**:
- 系统故障时自动取消所有挂单
- 发送紧急通知（邮件/短信）
- 提供备用交易通道指引

**数据备份**:
- 企业级备份策略
- 每日增量备份
- 每周全量备份
- 异地容灾

---

### 4.13 策略模板库

**预设模板**:

| 模板名 | 类型 | 难度 | 持仓周期 | 预期年化 |
|--------|------|:----:|:--------:|:--------:|
| 巴菲特价值 | 价值 | ⭐ | 长线 | 10-15% |
| 动量突破 | 趋势 | ⭐⭐ | 短线 | 15-25% |
| 低波红利 | 防守 | ⭐ | 长线 | 8-12% |
| 多因子增强 | 量化 | ⭐⭐⭐ | 中线 | 12-18% |
| 行业轮动 | 择时 | ⭐⭐⭐ | 中线 | 15-20% |
| 日内动量 | 日内 | ⭐⭐⭐ | 日内 | 20-40% |

---

### 4.14 风险预警通知

**通知渠道优先级**:
1. Phase 1: 邮件
2. Phase 2: 微信
3. Phase 3: App推送

**预警场景**:
- 单日亏损 > 3%
- 最大回撤触及阈值
- 持仓集中度过高
- 市场波动率异常 (VIX > 30)
- 策略冲突待决策
- 系统异常

---

### 4.15 移动端App

**核心功能**:

| 功能 | 优先级 | 说明 |
|------|:------:|------|
| 策略监控 | P0 | 查看运行中策略状态 |
| 收益查看 | P0 | 今日/累计收益 |
| 预警推送 | P0 | 接收风险预警 |
| 冲突决策 | P0 | 处理策略冲突 |
| 紧急止损 | P0 | 一键暂停策略 |
| 持仓查看 | P1 | 当前持仓明细 |
| 交易记录 | P1 | 历史交易查询 |

**不包含** (仅Web端):
- 策略创建/编辑
- 因子研究
- 回测配置

---

## 5. 技术架构补充

### 5.1 新增后端服务

```
backend/app/
├── services/
│   ├── factor_validation_service.py    # 因子验证服务
│   ├── trade_attribution_service.py    # 交易归因服务
│   ├── conflict_detection_service.py   # 冲突检测服务
│   ├── tax_calculation_service.py      # 税务计算服务
│   ├── pdt_rule_service.py             # PDT规则服务
│   └── strategy_drift_service.py       # 策略漂移监控
│
├── mcp/
│   ├── gateway.py                      # MCP网关
│   ├── model_router.py                 # 模型路由
│   └── news_connector.py               # 新闻连接器
│
└── api/v1/
    ├── factor_validation.py            # 因子验证API
    ├── trade_attribution.py            # 交易归因API
    ├── tax.py                          # 税务API
    └── notifications.py                # 通知API
```

### 5.2 新增前端页面

```
frontend/src/pages/
├── MyStrategies/                       # 我的策略
├── FactorResearch/                     # 因子研究中心
├── TradeAttribution/                   # 交易归因
└── TaxCenter/                          # 税务中心
```

### 5.3 数据库新增表

```sql
-- 因子验证结果
CREATE TABLE factor_validations (...);

-- 交易记录 (详细)
CREATE TABLE trade_records (...);

-- 归因报告
CREATE TABLE attribution_reports (...);

-- 策略版本
CREATE TABLE strategy_versions (...);

-- 冲突记录
CREATE TABLE conflict_events (...);

-- PDT交易计数
CREATE TABLE pdt_trade_counts (...);
```

---

## 6. 优先级排序

### P0 - 必须实现 (v2.1.0)

| # | 功能 | 开发周期 |
|---|------|:--------:|
| 1 | 我的策略列表 | 3天 |
| 2 | AI连接状态指示 | 1天 |
| 3 | 回测流程优化 | 2天 |
| 4 | 因子有效性验证 | 7天 |
| 5 | 交易归因系统 | 10天 |
| 6 | 策略冲突检测 | 5天 |
| 7 | PDT规则管理 | 3天 |
| 8 | 交易成本配置 | 3天 |

**P0 总计**: ~34天

### P1 - 重要功能 (v2.2.0)

| # | 功能 | 开发周期 |
|---|------|:--------:|
| 1 | 实盘vs回测监控 | 5天 |
| 2 | 税务计算系统 | 7天 |
| 3 | 风险预警通知 | 5天 |
| 4 | MCP多模型支持 | 10天 |
| 5 | MCP新闻捕捉 | 7天 |
| 6 | 策略版本管理 | 5天 |
| 7 | 引导式AI对话 | 10天 |
| 8 | 策略模板库 | 5天 |

**P1 总计**: ~54天

### P2 - 扩展功能 (v2.3.0)

| # | 功能 | 开发周期 |
|---|------|:--------:|
| 1 | 移动端App | 30天 |
| 2 | 备用交易通道 | 7天 |
| 3 | Interactive Brokers接入 | 14天 |

**P2 总计**: ~51天

### P3 - 未来规划 (v3.0.0)

| # | 功能 | 开发周期 |
|---|------|:--------:|
| 1 | 教育内容模块 | 14天 |
| 2 | 多用户权限 | 21天 |
| 3 | 审批流程 | 10天 |

---

## 7. 里程碑规划

```
2025 Q1
├── v2.1.0 (2月底) - 核心体验优化
│   ├── 我的策略列表
│   ├── AI连接状态指示
│   ├── 回测流程优化
│   ├── 因子有效性验证系统
│   ├── 交易归因与复盘系统
│   ├── 策略冲突检测
│   ├── PDT规则管理
│   └── 交易成本配置
│
└── v2.2.0 (4月中) - 专业交易功能
    ├── 📈 实时交易监控界面 (TradingView + Polygon.io)
    ├── 🔄 策略回放功能
    ├── 📊 分策略持仓管理
    ├── 📊 实盘vs回测差异监控
    ├── 💰 税务计算系统
    ├── ⚠️ 风险预警通知 (邮件)
    └── 📁 策略版本管理

2025 Q2
├── v2.3.0 (5月底) - AI与数据扩展
│   ├── 🤖 MCP多模型支持
│   ├── 📰 MCP新闻捕捉
│   ├── 💬 引导式AI对话
│   └── 📋 策略模板库 (含日内)
│
└── v2.4.0 (6月底) - 移动端与券商
    ├── 📱 移动端App
    ├── 🔌 备用交易通道
    └── 🏦 Interactive Brokers接入

2025 Q3+
└── v3.0.0 - 企业级功能
    ├── 📚 教育内容模块
    ├── 👥 多用户权限
    └── ✅ 审批流程
```

### 7.1 开发周期汇总

| 版本 | 功能数 | 开发周期 | 目标日期 |
|------|:------:|:--------:|:--------:|
| v2.1.0 | 8 | ~34天 | 2025-02-28 |
| v2.2.0 | 7 | ~56天 | 2025-04-15 |
| v2.3.0 | 4 | ~32天 | 2025-05-31 |
| v2.4.0 | 3 | ~51天 | 2025-06-30 |
| v3.0.0 | 3 | ~45天 | 2025-09-30 |

### 7.2 关键技术决策记录

| 决策项 | 选择 | 理由 |
|--------|------|------|
| 图表引擎 | TradingView Widget (免费版) | 专业、用户熟悉、零成本 |
| 实时数据 | Polygon.io WebSocket | 已有集成、<1秒延迟 |
| 历史数据 | 1分钟K线 (~50GB/年) | 够用、成本可控 |
| 持仓管理 | 分策略独立账本 | 专业标准、业绩归因清晰 |
| 系统可用性 | 99.9% | 平衡成本与可靠性 |
| 数据备份 | 企业级 | 策略资产保护 |

---

## 4.15 策略部署与环境管理

**需求描述**: 定义策略从回测通过到实际运行的完整部署流程，以及模拟盘/实盘环境的管理。

### 4.15.1 策略生命周期

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           策略完整生命周期                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐   │
│  │  创建    │ →  │  回测    │ →  │  模拟盘  │ →  │  实盘    │ →  │  监控    │   │
│  │ (Draft) │    │(Backtest)│    │ (Paper) │    │ (Live)  │    │(Monitor)│   │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘   │
│       │              │              │              │              │         │
│       ▼              ▼              ▼              ▼              ▼         │
│   策略工厂       回测中心       模拟交易        实盘交易       实时监控     │
│   编辑因子       验证逻辑       验证执行        真实资金       持续优化     │
│   设置规则       分析绩效       无风险测试      风控生效       绩效归因     │
│                                                                             │
│  状态标记: 📝草稿 → ✅回测通过 → 🔵模拟运行 → 🟢实盘运行 → ⏸️已暂停        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.15.2 策略部署向导

**从回测到运行的标准流程** (4步向导):

| 步骤 | 内容 | 配置项 |
|:----:|------|--------|
| 1 | 选择运行环境 | 模拟盘/实盘 |
| 2 | 资金配置 | 分配金额、单笔仓位、最大持仓数 |
| 3 | 股票池配置 | 监控范围 (指数/行业/自选) |
| 4 | 风控设置 | 止盈止损、策略级风控、执行方式 |

**Step 1: 选择运行环境**:
```
┌─────────────────────────────┐  ┌─────────────────────────────┐
│  🔵 模拟盘 (Paper Trading)  │  │  🟢 实盘 (Live Trading)     │
│  ─────────────────────────  │  │  ─────────────────────────  │
│  • 使用虚拟资金             │  │  • 使用真实资金             │
│  • 无真实交易风险           │  │  • 真实市场执行             │
│  • 验证策略执行效果         │  │  • 产生真实盈亏             │
│  • 建议新策略先跑2-4周      │  │  • 需绑定券商账户           │
│                             │  │  • 需模拟盘验证≥30天        │
│  [选择模拟盘] (推荐新策略)  │  │  [选择实盘]                 │
└─────────────────────────────┘  └─────────────────────────────┘
```

**Step 2: 资金配置**:
```
账户资金: $100,000 (模拟盘)

分配给此策略: [$50,000] (占账户 50%)
单笔最大仓位: [10%▼] (即 $5,000/笔)
最大持仓数量: [5 只▼]

💡 建议: 单策略不超过账户的30-50%
```

**Step 3: 股票池配置**:
```
☑ SP500 (503只)        ☐ Russell 2000
☑ NASDAQ 100 (100只)   ☐ 全市场
☐ DOW 30 (30只)

行业筛选: ☑科技 ☐金融 ☐医疗...
自选股: ☑我的自选 (12只)

合计监控: 515 只股票
```

**Step 4: 风控设置**:
```
止盈止损: 止损[-8%] 止盈[+15%] 盈亏比1:1.88

策略级风控:
• 单日最大亏损: [-3%] → 暂停策略
• 累计最大回撤: [-10%] → 暂停并通知
• 连续亏损次数: [3次] → 暂停并通知

信号执行方式:
○ 自动执行 (信号触发后自动下单)
● 人工确认 (信号触发后通知用户确认) ← 推荐新手
○ 仅通知 (只发送信号通知，不执行)
```

### 4.15.3 模拟盘/实盘环境管理

**环境定义**:
| 环境 | 图标 | 资金 | 执行 | 风险 | 用途 |
|------|:----:|------|------|------|------|
| 模拟盘 | 🔵 | 虚拟资金 | 模拟撮合 | 无 | 验证策略、学习交易 |
| 实盘 | 🟢 | 真实资金 | 券商执行 | 真实盈亏 | 正式交易 |

**模拟盘→实盘 前置条件**:
```
☑ 策略在模拟盘运行 ≥ 30天
☑ 模拟盘交易次数 ≥ 10次
☑ 模拟盘收益为正 或 用户确认风险
☑ 已绑定券商账户
☑ 用户完成风险确认书签署
```

**数据模型**:
```sql
-- 策略部署表
CREATE TABLE strategy_deployment (
    deployment_id UUID PRIMARY KEY,
    strategy_id UUID NOT NULL,
    user_id UUID NOT NULL,
    environment ENUM('paper', 'live') NOT NULL,
    status ENUM('running', 'paused', 'stopped') DEFAULT 'running',
    
    -- 资金配置
    allocated_capital DECIMAL(15,2),
    max_position_pct DECIMAL(5,2),
    max_positions INT,
    
    -- 风控配置
    stop_loss_pct DECIMAL(5,2),
    take_profit_pct DECIMAL(5,2),
    daily_loss_limit_pct DECIMAL(5,2),
    max_drawdown_pct DECIMAL(5,2),
    
    -- 执行配置
    execution_mode ENUM('auto', 'confirm', 'notify_only'),
    
    -- 统计
    paper_days INT DEFAULT 0,  -- 模拟盘运行天数
    paper_trades INT DEFAULT 0, -- 模拟盘交易次数
    
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- 股票池配置
CREATE TABLE deployment_universe (
    deployment_id UUID,
    universe_id UUID,
    PRIMARY KEY (deployment_id, universe_id)
);
```

### 4.15.4 策略管理中心

**界面设计**:
```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📋 我的策略                                          [+ 部署新策略]         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─ 🟢 实盘策略 ────────────────────────────────────────────────────────┐   │
│  │  策略名称        状态    资金      今日盈亏   累计收益   操作          │   │
│  │  价值投资v1.2   🟢运行  $50,000   +$385     +$2,450   [监控][暂停]  │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─ 🔵 模拟盘策略 ──────────────────────────────────────────────────────┐   │
│  │  日内动量v2.0   🔵运行  $30,000   +$180     +$850    [监控][转实盘] │   │
│  │  均值回归v1.0   🔵运行  $20,000   -$45      +$120    [监控][暂停]   │   │
│  │  趋势突破v1.5   ⏸️暂停  $0        -         -$320    [启动][删除]   │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─ 📝 待部署策略 (回测通过) ────────────────────────────────────────────┐   │
│  │  高股息策略v1.0  回测收益:+15.2%  夏普:1.28           [部署]         │   │
│  │  成长股策略v2.1  回测收益:+22.5%  夏普:1.65           [部署]         │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4.16 实时交易监控界面

**需求描述**: 提供专业的实时行情图表，用户可以观察策略信号并进行手动交易。

**技术方案**:
- 图表引擎: TradingView Widget (免费版)
- 实时数据: Polygon.io WebSocket (<1秒延迟)
- 覆盖层: 自定义Canvas/SVG绑制策略信号

**功能模块**:

1. **TradingView集成**
   - 实时K线图
   - 多时间周期切换 (1m/5m/15m/1H/4H/1D)
   - 技术指标叠加 (MA/RSI/MACD等)
   - 自定义布局 (单图/2×2/3×2)

2. **策略信号可视化**
   - 买入信号标记 (绿色上箭头)
   - 卖出信号标记 (红色下箭头)
   - 当前持仓位置 (蓝色圆点)
   - 止损线 (红色虚线)
   - 止盈线 (绿色虚线)
   - 等待中的信号 (黄色标记)

3. **手动交易面板**
   - 市价单/限价单/止损单
   - 快速数量选择 (100/500/1000/自定义)
   - 一键止损止盈设置
   - 手动交易独立统计

4. **分策略持仓管理**
   - 每个策略独立账本
   - 同股票不同策略分开显示
   - 策略汇总视图
   - 集中度风险提醒

5. **日内交易专用视图**
   - 1分钟主图 + 5分钟宏观副图
   - 快速交易按钮
   - PDT次数实时显示
   - 今日交易记录

6. **策略动态面板**
   - 实时信号通知
   - 等待确认的信号
   - 最近执行的交易
   - 快捷操作 (一键平仓/暂停策略)

**执行模式**:
| 模式 | 说明 |
|------|------|
| 全自动 | 信号自动执行，无需确认 |
| 半自动 | 信号需确认，超时自动执行/取消 |
| 纯监控 | 只产生信号，用户手动执行 |

**开发周期**: 14天

### 4.16.1 UI设计规格

#### 股票搜索与信号雷达

**核心概念**:
```
┌─────────────────────────────────────────────────────────────────┐
│  信号雷达 (Signal Radar) - 策略监控全景视图                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  策略: 价值投资 v1.2                                             │
│  监控范围: SP500 (503只) + 自选股 (12只)                         │
│                                                                 │
│  ┌─ 信号状态分布 ─────────────────────────────────────────────┐ │
│  │                                                             │ │
│  │  🔴 已持仓 (3)     → AAPL, NVDA, GOOGL                      │ │
│  │  🟢 买入信号 (2)   → TSLA, MSFT (等待确认)                  │ │
│  │  🟡 接近触发 (5)   → META, AMZN, AMD, CRM, NFLX            │ │
│  │  ⚪ 监控中 (505)   → 其余股票                               │ │
│  │                                                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**股票池 (Universe) 管理**:
| 股票池类型 | 说明 | 示例 |
|------------|------|------|
| 系统预设 | 主要指数成分股 | SP500, NASDAQ100, DOW30 |
| 行业板块 | 按GICS分类 | 科技、金融、医疗、能源 |
| 市值分类 | 按市值划分 | 大盘股(>100B)、中盘、小盘 |
| 自选股 | 用户自定义 | 我的关注、潜力股、观察列表 |
| 策略推荐 | AI推荐 | 适合当前策略的候选股 |

**信号状态定义**:
| 状态 | 颜色 | 图标 | 说明 |
|------|------|------|------|
| 已持仓 | 红色 | 🔴 | 当前策略持有的股票 |
| 买入信号 | 绿色 | 🟢 | 已触发买入，等待确认/执行 |
| 卖出信号 | 橙色 | 🟠 | 已触发卖出，等待确认/执行 |
| 接近触发 | 黄色 | 🟡 | 因子值接近阈值 (80-99%) |
| 监控中 | 灰色 | ⚪ | 正常监控，暂无信号 |
| 不符合 | 深灰 | ⚫ | 不满足基本筛选条件 |

**整体布局** (三栏式):
```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  顶部导航栏 (h=56px)                                                                 │
│  [Logo] [🔍搜索股票...] [策略:价值投资v1.2▼] [🟢运行中] [账户$98,450] [PDT:2/3] [⚙️]│
├───────────────┬─────────────────────────────────────────────────────┬───────────────┤
│               │                                                     │               │
│  📡 信号雷达   │  ┌─ 图表工具栏 ───────────────────────────────────┐ │  策略动态     │
│  (w=280px)    │  │ [AAPL▼] [1m][5m][15m][1H][4H][1D] [指标][画线] │ │  (w=288px)    │
│               │  └─────────────────────────────────────────────────┘ │               │
│  ┌──────────┐ │                                                     │  ┌──────────┐ │
│  │ 股票池   │ │  ┌─ TradingView 图表区域 ─────────────────────────┐ │  │ 信号通知 │ │
│  │ [SP500▼] │ │  │                                                │ │  │ 交易记录 │ │
│  └──────────┘ │  │  AAPL  $190.50 +$5.30 (+2.86%)                 │ │  │ 风险提醒 │ │
│               │  │                                                │ │  └──────────┘ │
│  ┌──────────┐ │  │  🎯止盈 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │ │               │
│  │ 信号分布 │ │  │                    K线图                       │ │  ┌──────────┐ │
│  │ 🔴 持仓 3│ │  │  ━━━━━━━━━ 当前价格 ━━━━━━━━━━━━━━━━━━━━━━━━  │ │  │ 快速交易 │ │
│  │ 🟢 买入 2│ │  │                                                │ │  │          │ │
│  │ 🟡 接近 5│ │  │  🛑止损 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │ │  │ [买入]   │ │
│  │ ⚪ 监控  │ │  │                                                │ │  │ [卖出]   │ │
│  └──────────┘ │  └────────────────────────────────────────────────┘ │  └──────────┘ │
│               │                                                     │               │
│  ┌──────────┐ ├─────────────────────────────────────────────────────┤  ┌──────────┐ │
│  │ 股票列表 │ │  ┌─ 持仓列表 ─────────────┐┌─ 策略信号 ──────────┐│  │一键平仓  │ │
│  │ (可滚动) │ │  │ AAPL 价值投资 +$530   ││ 🟡TSLA 买入 待确认  ││  │暂停策略  │ │
│  │          │ │  │ NVDA 日内动量 +$90    ││ ⏳NVDA 加仓 条件未满 ││  └──────────┘ │
│  │ 🔴AAPL   │ │  │ GOOGL 价值投资 -$24   ││ ✅AAPL 买入 已执行   ││               │
│  │ 🔴NVDA   │ │  └───────────────────────┘└─────────────────────┘│               │
│  │ 🔴GOOGL  │ │                                                     │               │
│  │ 🟢TSLA   │ └─────────────────────────────────────────────────────┘               │
│  │ 🟢MSFT   │                                                                       │
│  │ 🟡META   │                                                                       │
│  │ 🟡AMZN   │                                                                       │
│  │ ...      │                                                                       │
│  └──────────┘                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

**左侧信号雷达面板** (w=280px):
```
┌─ 📡 信号雷达 ──────────────────────────┐
│                                        │
│  ┌─ 🔍 快速搜索 ────────────────────┐  │
│  │ [搜索股票代码或名称...]     [🔍] │  │
│  └──────────────────────────────────┘  │
│                                        │
│  ┌─ 📂 股票池 ──────────────────────┐  │
│  │ [SP500 ▼]                        │  │
│  │  ├── SP500 (503)                 │  │
│  │  ├── NASDAQ100 (100)             │  │
│  │  ├── 科技股 (45)                 │  │
│  │  ├── 我的自选 (12)               │  │
│  │  └── + 新建股票池                │  │
│  └──────────────────────────────────┘  │
│                                        │
│  ┌─ 🚦 信号状态分布 ────────────────┐  │
│  │                                    │  │
│  │  🔴 已持仓      3   ████          │  │
│  │  🟢 买入信号    2   ███           │  │
│  │  🟠 卖出信号    0                 │  │
│  │  🟡 接近触发    5   █████         │  │
│  │  ⚪ 监控中    505   ██████████    │  │
│  │                                    │  │
│  │  [只看有信号] [只看持仓]          │  │
│  └──────────────────────────────────┘  │
│                                        │
│  ┌─ 📋 股票列表 ────────── [排序▼] ─┐  │
│  │                                    │  │
│  │  ── 🔴 已持仓 (3) ──────────────  │  │
│  │  │ AAPL  $190.50 +2.86% █████    │  │
│  │  │ NVDA  $142.80 +1.28% ████     │  │
│  │  │ GOOGL $141.50 -0.56% ███      │  │
│  │                                    │  │
│  │  ── 🟢 买入信号 (2) ────────────  │  │
│  │  │ TSLA  $248.00  待确认 85%     │  │
│  │  │ MSFT  $378.50  待确认 78%     │  │
│  │                                    │  │
│  │  ── 🟡 接近触发 (5) ────────────  │  │
│  │  │ META  $520.30  PE:21.2 (92%)  │  │
│  │  │ AMZN  $185.40  动量:0.48(96%) │  │
│  │  │ AMD   $142.00  RSI:32 (88%)   │  │
│  │  │ CRM   $285.60  PE:24.1 (85%)  │  │
│  │  │ NFLX  $495.00  ROE:19%(82%)   │  │
│  │                                    │  │
│  │  ── ⚪ 监控中 (505) ────────────  │  │
│  │  │ [展开查看更多...]              │  │
│  │                                    │  │
│  └──────────────────────────────────┘  │
│                                        │
└────────────────────────────────────────┘
```

**股票搜索功能**:
```
┌─ 🔍 搜索结果 ──────────────────────────┐
│  输入: "APP"                           │
│                                        │
│  📈 股票匹配:                          │
│  ┌────────────────────────────────────┐│
│  │ AAPL  Apple Inc.           $190.50 ││
│  │       🔴持仓中 | 科技 | 大盘       ││
│  ├────────────────────────────────────┤│
│  │ APP   AppLovin Corp.       $285.30 ││
│  │       ⚪监控中 | 科技 | 中盘       ││
│  ├────────────────────────────────────┤│
│  │ APPS  Digital Turbine      $2.45   ││
│  │       ⚫不在监控 | 科技 | 小盘     ││
│  └────────────────────────────────────┘│
│                                        │
│  💡 按 Enter 查看图表                   │
│  💡 按 + 添加到自选股                   │
│                                        │
└────────────────────────────────────────┘
```

**股票详情卡片** (点击股票后展开):
```
┌─ TSLA 特斯拉 ───────────── 🟢买入信号 ─┐
│                                        │
│  $248.00  +$5.30 (+2.18%)              │
│                                        │
│  ┌─ 因子条件 ────────────────────────┐ │
│  │ ✓ 动量得分    0.85   (>0.5)       │ │
│  │ ✓ 20日突破   Yes     触发         │ │
│  │ ✗ RSI        68.5    (<70)        │ │
│  │ ✓ 成交量     +45%    (>+20%)      │ │
│  │                                    │ │
│  │ 综合: 3/4满足 → 触发买入           │ │
│  └────────────────────────────────────┘ │
│                                        │
│  信号强度: ████████░░ 85%              │
│  触发时间: 10:32:15                     │
│                                        │
│  [查看图表] [执行买入] [添加自选]       │
│                                        │
└────────────────────────────────────────┘
```

**颜色规范**:
| 元素 | 颜色代码 | 用途 |
|------|----------|------|
| 背景-主区域 | `#0a0a1a` | 深蓝黑，减少视觉疲劳 |
| 背景-面板 | `#0d0d1f` | 略浅，区分层次 |
| 背景-工具栏 | `#12122a` | 导航和工具栏 |
| 边框 | `#2a2a4a` | 分隔线 |
| 买入/盈利 | `#22c55e` | 绿色 |
| 卖出/亏损 | `#ef4444` | 红色 |
| 当前价格 | `#3b82f6` | 蓝色 |
| 待处理 | `#eab308` | 黄色 |
| 文字-主要 | `#ffffff` | 白色 |
| 文字-次要 | `#9ca3af` | 灰色 |

**图表覆盖层元素**:
| 元素 | 样式 | 交互 |
|------|------|------|
| 止盈线 | 绿色虚线 2px | 可拖拽调整 |
| 止损线 | 红色虚线 2px | 可拖拽调整 |
| 入场价线 | 蓝色点线 1px | 仅显示 |
| 买入信号 | 绿色上三角 | 点击查看详情 |
| 卖出信号 | 红色下三角 | 点击查看详情 |
| 持仓标记 | 蓝色圆点 | 悬停显示信息 |

**右侧面板组件** (w=288px):
```
┌─ 策略动态 (flex-1, 可滚动) ────────────┐
│ 📋 策略动态                  [查看全部] │
│ ─────────────────────────────────────  │
│ │📊 买入信号: TSLA @$248.00           │
│ │   动量突破20日高点                   │
│ │   10:32:15                          │
│ │                                      │
│ │🔔 已买入: AAPL 100股                │
│ │   PE低于行业均值20%                  │
│ │   10:15:22                          │
└────────────────────────────────────────┘

┌─ 快速交易 (h=auto) ────────────────────┐
│ ⚡ 快速交易                             │
│ [AAPL▼]              $190.50 +2.86%   │
│                                        │
│ [███ 买入 ███][░░ 卖出 ░░]              │
│                                        │
│ 数量: [100] [500] [1000]               │
│                                        │
│ 预估金额: $19,050.00                   │
│                                        │
│ [     确认买入     ]                    │
└────────────────────────────────────────┘

┌─ 快捷操作 (固定底部) ──────────────────┐
│ [🛑 一键平仓]                          │
│ [⏸️ 暂停策略]                          │
└────────────────────────────────────────┘
```

**响应式断点**:
| 屏幕宽度 | 布局调整 |
|----------|----------|
| ≥1440px | 完整三栏布局 |
| 1200-1439px | 左侧面板收窄至220px，右侧面板收窄至240px |
| <1200px | 左侧/右侧面板可折叠 |

### 4.16.2 信号雷达与股票池管理

**需求描述**: 提供策略监控全景视图，让用户清晰了解策略正在监控哪些股票，哪些股票符合条件，信号触发状态如何。

**核心功能**:

1. **股票搜索**
   - 支持股票代码、公司名称搜索
   - 显示股票当前状态（持仓/信号/监控）
   - 快速添加到自选股
   - 键盘快捷键支持 (Ctrl+K 全局搜索)

2. **股票池管理**
   - 系统预设池: SP500, NASDAQ100, DOW30, Russell2000
   - 行业板块: 按GICS分类 (科技、金融、医疗等)
   - 市值分类: 大盘股(>100B)、中盘(10-100B)、小盘(<10B)
   - 自选股: 用户自定义关注列表
   - 策略推荐: AI根据策略特性推荐适合的股票

3. **信号状态监控**
   - 实时显示各状态股票数量
   - 按状态筛选股票列表
   - 排序选项: 信号强度、接近程度、价格变动、市值

4. **股票详情卡片**
   - 显示当前价格和涨跌幅
   - 展示各因子当前值与阈值对比
   - 综合判断结果
   - 快速操作按钮

**信号状态定义**:
| 状态 | 含义 | 视觉标识 | 排序优先级 |
|------|------|----------|:----------:|
| 🔴 已持仓 | 当前策略持有 | 红色圆点 | 1 |
| 🟢 买入信号 | 已触发买入条件 | 绿色圆点 | 2 |
| 🟠 卖出信号 | 已触发卖出条件 | 橙色圆点 | 3 |
| 🟡 接近触发 | 因子值达到阈值80-99% | 黄色圆点 | 4 |
| ⚪ 监控中 | 正常监控，暂无信号 | 灰色圆点 | 5 |
| ⚫ 不符合 | 不满足基本筛选条件 | 深灰圆点 | 6 |

**"接近触发"计算逻辑**:
```
接近程度 = min(各因子接近程度)

单因子接近程度:
- 如果 当前值 已满足阈值: 100%
- 如果 当前值 接近阈值: (当前值 - 起始值) / (阈值 - 起始值) × 100%

示例: PE 阈值 < 20
- 当前 PE = 21.5, 起始观察值 = 25
- 接近程度 = (25 - 21.5) / (25 - 20) × 100% = 70%

当接近程度 ≥ 80% 时，标记为 🟡 接近触发
```

**数据模型**:
```sql
-- 股票池表
CREATE TABLE stock_universe (
    universe_id UUID PRIMARY KEY,
    name VARCHAR(100),
    type ENUM('system', 'sector', 'market_cap', 'custom', 'ai_recommended'),
    user_id UUID,  -- NULL for system pools
    symbols TEXT[],
    created_at TIMESTAMP
);

-- 策略监控范围
CREATE TABLE strategy_universe (
    strategy_id UUID,
    universe_id UUID,
    PRIMARY KEY (strategy_id, universe_id)
);

-- 实时信号状态缓存
CREATE TABLE signal_status_cache (
    strategy_id UUID,
    symbol VARCHAR(10),
    status ENUM('holding', 'buy_signal', 'sell_signal', 'near_trigger', 'monitoring', 'excluded'),
    signal_strength DECIMAL(5,2),  -- 0-100%
    factor_values JSONB,
    updated_at TIMESTAMP,
    PRIMARY KEY (strategy_id, symbol)
);
```

**API设计**:
```typescript
// 获取信号雷达数据
GET /api/v1/strategies/{strategyId}/signal-radar
Response: {
  universeInfo: {
    name: "SP500 + 自选股",
    totalStocks: 515
  },
  statusSummary: {
    holding: 3,
    buySignal: 2,
    sellSignal: 0,
    nearTrigger: 5,
    monitoring: 505
  },
  stocks: [
    {
      symbol: "TSLA",
      name: "Tesla Inc.",
      price: 248.00,
      change: +2.18,
      status: "buy_signal",
      signalStrength: 85,
      factors: [
        { name: "动量得分", value: 0.85, threshold: ">0.5", passed: true },
        { name: "RSI", value: 68.5, threshold: "<70", passed: false }
      ],
      triggeredAt: "2024-01-04T10:32:15Z"
    }
  ]
}

// 搜索股票
GET /api/v1/stocks/search?q={query}&strategyId={strategyId}
Response: {
  results: [
    {
      symbol: "AAPL",
      name: "Apple Inc.",
      sector: "Technology",
      marketCap: "large",
      status: "holding",  // 在当前策略中的状态
      inUniverse: true    // 是否在监控范围内
    }
  ]
}

// 管理股票池
POST /api/v1/universes
GET /api/v1/universes
PUT /api/v1/universes/{universeId}
DELETE /api/v1/universes/{universeId}
```

---

### 4.17 策略回放功能

**需求描述**: 回放历史行情，观察策略在过去的信号和执行情况。

**数据需求**:
- 历史数据: 1分钟K线 (~50GB/年)
- 因子快照: 每日因子值存储
- 信号记录: 历史信号日志

**功能模块**:

1. **回放控制**
   - 日期范围选择
   - 播放/暂停/快进/后退
   - 速度调节 (0.5x/1x/2x/5x)
   - 跳转到下一个信号

2. **回放显示**
   - 历史K线动态显示
   - 因子值实时计算显示
   - 信号触发标记
   - 模拟持仓跟踪

3. **回放分析**
   - 回放期间收益统计
   - 信号准确率分析
   - 与基准对比
   - 信号事件日志导出

**使用场景**:
- 初学者理解策略逻辑
- 验证策略在特定事件中的表现
- Debug策略问题

**开发周期**: 7天

### 4.17.1 UI设计规格

**整体布局**:
```
┌─────────────────────────────────────────────────────────────────────────────┐
│  顶部导航栏 (h=56px)                                                         │
│  [Logo] [🔄策略回放] [策略选择▼] [🟣回放模式] [退出回放]                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  回放控制条 (h=80px)                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 日期:[2024-10-01] 至 [2024-12-31]  股票:[AAPL▼]                        ││
│  │                                                                         ││
│  │ [⏮️][⏪][▶️][⏩][⏭️]  速度:[1x▼]  [跳到下一信号]     2024-11-15 14:32:18 ││
│  │                                                                         ││
│  │ ●━━━━━━━━━━━●━━━━━━━━━━━━●━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ ││
│  │ 2024-10-01    🟢         🔴          ▲当前位置                2024-12-31││
│  └─────────────────────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────────────────────┤
│                                                              │              │
│  ┌─ 图表工具栏 ────────────────────────────────────────────┐ │ 📊 因子值   │
│  │ AAPL  $185.20 +$2.80 (+1.54%)  [1m][5m][15m][1H][4H][1D]│ │ (w=320px)   │
│  └──────────────────────────────────────────────────────────┘ │             │
│                                                              │ PE: 18.5 ✓  │
│  ┌─ 历史K线图 (TradingView回放模式) ──────────────────────┐  │ ROE: 25% ✓  │
│  │                                                        │  │ 股息: 0.8% ✗│
│  │  🎯止盈 $192.00 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │  │ 动量: 0.72✓ │
│  │                                                        │  │             │
│  │  ┃已回放K线┃当前┃░░未来(灰色)░░                        │  │ 综合: 买入  │
│  │      ▲      │紫线│                                     │  │ (3/4满足)   │
│  │     买入     ▼                                         │  ├─────────────┤
│  │  🛑止损 $180.00 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │  │ 📋 信号日志 │
│  │                                                        │  │             │
│  │  💡 信号触发提示 ─────────────────┐                    │  │ 🟢 买入触发 │
│  │  │ 🎯 买入信号触发!               │                    │  │ 🟡 条件检查 │
│  │  │ PE降至18.5，低于阈值20         │                    │  │ 🔴 卖出信号 │
│  │  └────────────────────────────────┘                    │  │             │
│  └────────────────────────────────────────────────────────┘  ├─────────────┤
│                                                              │ 🎯 回放洞察 │
├──────────────────────────────────────────────────────────────┤             │
│  ┌─ 模拟持仓 ─────────────────────────────────────────────┐  │ 信号数: 8   │
│  │ 股票  持仓   成本     现价     盈亏        │ 总资产     │  │ 胜率: 75%   │
│  │ AAPL  100股  $182.40  $185.20  +$280      │ $100,280   │  │ Alpha: +2.3%│
│  │                                           │ +0.28%     │  │             │
│  └───────────────────────────────────────────────────────────┘│ [详细报告]  │
│                                                              │ [保存回放]  │
└─────────────────────────────────────────────────────────────────────────────┘
```

**回放控制条设计**:
```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ┌─ 日期范围 ─────┐  ┌─ 股票 ───┐  │  ┌─ 播放控制 ─────────────────────┐   │
│  │ [📅] 至 [📅]   │  │ [AAPL▼]  │  │  │ [⏮️] [⏪] [▶️/⏸️] [⏩] [⏭️]   │   │
│  └─────────────────┘  └──────────┘  │  └──────────────────────────────────┘   │
│                                     │                                        │
│  ┌─ 速度 ────┐  ┌─ 快捷跳转 ──────────────┐  ┌─ 当前时间 ─────────────┐   │
│  │ [1x ▼]    │  │ [⏭️ 跳到下一信号]       │  │ 2024-11-15             │   │
│  │ 0.5x/1x/  │  │                         │  │ 14:32:18               │   │
│  │ 2x/5x     │  │                         │  │ (蓝色大字)             │   │
│  └────────────┘  └─────────────────────────┘  └─────────────────────────┘   │
├─────────────────────────────────────────────────────────────────────────────┤
│  进度条 (带信号标记)                                                         │
│  ●━━━━━━━━━━━●━━━━━━━━━━━━●━━━━━━━━━━●━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│  │           │            │          ▲                                    │ │
│  │          🟢           🔴         紫色当前位置指示                       │ │
│  │         买入         卖出                                               │ │
│  2024-10-01    2024-11-01    2024-12-01                          2024-12-31│
└─────────────────────────────────────────────────────────────────────────────┘
```

**K线区域分区显示**:
| 区域 | 显示样式 | 说明 |
|------|----------|------|
| 已回放K线 | 正常颜色显示 | 红绿蜡烛图 |
| 当前位置K线 | 蓝色高亮+边框 | 当前回放到的位置 |
| 未来K线 | 灰色半透明(30%) | 尚未回放到的数据 |
| 回放位置线 | 紫色虚线垂直线 | 标注当前时间点 |

**因子值面板**:
```
┌─ 📊 当前时刻因子值 ────────────────────┐
│                                        │
│  ● PE_TTM      18.5    (<20)    ✓     │
│  ● ROE         25.3%   (>15%)   ✓     │
│  ○ 股息率      0.8%    (>1%)    ✗     │
│  ● 动量得分    0.72    (>0.5)   ✓     │
│                                        │
│  ─────────────────────────────────────  │
│  综合信号:  买入 (3/4 条件满足)         │
│                                        │
└────────────────────────────────────────┘

图例:
● 绿色圆点 = 条件满足
○ 红色圆点 = 条件不满足
```

**信号事件日志**:
```
┌─ 📋 信号事件日志 ──────────── [导出] ──┐
│                                        │
│  ┌─ 🟢 买入信号触发 ──────── 14:32:18 ─┐│
│  │ PE降至18.5，低于阈值20              ││
│  │ AAPL @ $185.20                      ││
│  └──────────────────────────────────────┘│
│                                        │
│  ┌─ 🟡 条件检查 ─────────── 14:15:00 ─┐│
│  │ PE=19.2，接近阈值                   ││
│  └──────────────────────────────────────┘│
│                                        │
│  ┌─ 🔴 卖出信号 ─────────── 11:30:00 ─┐│
│  │ 止盈触发，收益+5.2%                 ││
│  └──────────────────────────────────────┘│
│                                        │
└────────────────────────────────────────┘
```

**回放洞察面板**:
```
┌─ 🎯 回放洞察 ──────────────────────────┐
│                                        │
│  ┌───────┐  ┌───────┐                  │
│  │信号数 │  │执行率 │                  │
│  │  8    │  │ 75%   │                  │
│  │买5/卖3│  │6执行  │                  │
│  └───────┘  └───────┘                  │
│                                        │
│  ┌───────┐  ┌───────┐                  │
│  │ 胜率  │  │ Alpha │                  │
│  │ 75%   │  │ +2.3% │                  │
│  │(绿色) │  │(绿色) │                  │
│  └───────┘  └───────┘                  │
│                                        │
│  收益对比:                              │
│  策略 ████████████░░░░ +8.5%           │
│  SPY  ██████████░░░░░░ +6.2%           │
│                                        │
│  ┌─ 💡 AI洞察 ────────────────────────┐│
│  │ 策略在财报发布后1-3天内的买入       ││
│  │ 信号准确率最高(83%)                 ││
│  └──────────────────────────────────────┘│
│                                        │
│  [📊 详细报告]  [💾 保存回放]           │
│                                        │
└────────────────────────────────────────┘
```

---

### 4.18 分策略持仓管理

**需求描述**: 同一股票在不同策略中独立计算，互不干扰。

**设计原则**:

1. **逻辑隔离**
   - 每个策略独立账本
   - 独立计算盈亏
   - 独立统计业绩

2. **物理合并**
   - 券商账户层面合并持有
   - 卖出时只卖对应策略的份额

3. **信号执行**
   - 策略A卖出信号 → 只卖策略A持仓
   - 不影响策略B和手动持仓

**数据模型**:
```
Position
├── position_id
├── account_id
├── strategy_id (关键：归属策略)
├── symbol
├── quantity
├── avg_cost
└── unrealized_pnl
```

**UI功能**:
- 按策略分组显示持仓
- 同股票汇总视图
- 集中度风险提醒

### 4.18.0 盘前扫描器 (Pre-market Scanner)

**需求描述**: 为日内交易提供盘前股票筛选功能，帮助用户从候选池中选择当日交易标的。

**设计原则**:
```
专业机构的日内交易股票选择流程:

开盘前 (Pre-market)          开盘后 (Trading Hours)
┌────────────────────┐       ┌────────────────────┐
│  盘前扫描器        │       │  交易执行界面       │
│  ───────────────   │       │  ───────────────   │
│  • 策略自动扫描    │  →    │  • 只显示已确认股票 │
│  • 生成候选列表    │       │  • 专注快速执行     │
│  • 用户选择/排除   │       │  • 无干扰信息       │
│  • 确认监控列表    │       │                    │
│                    │       │                    │
│  候选: 50-100只    │  →    │  监控: 5-20只      │
└────────────────────┘       └────────────────────┘

核心: 策略推荐 + 人工决策 = 最终监控列表
```

**界面设计**:
```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ⏰ 盘前扫描器 - 日内动量策略                          2025-01-04 08:45 EST │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─ 筛选条件 (策略定义 + 用户可调) ─────────────────────────────────────┐   │
│  │                                                                       │   │
│  │  ☑ Gap > [2%▼]        ☑ 盘前成交量 > [日均200%▼]                     │   │
│  │  ☑ 昨日波动率 > [3%▼]  ☑ 流动性 > [$5M/日▼]                          │   │
│  │  ☐ 有重大新闻          ☐ 财报日                                      │   │
│  │                                                                       │   │
│  │  [应用筛选]  [恢复默认]                            符合条件: 47 只    │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─ 候选股票列表 ──────────────────────────────────────────── [全选] ────┐   │
│  │                                                                       │   │
│  │  ☑  股票   Gap     盘前量   昨日波动  流动性   新闻   策略评分        │   │
│  │  ───────────────────────────────────────────────────────────────────  │   │
│  │  ☑  NVDA  +4.2%   385%    5.2%     $890M    📰    ⭐⭐⭐⭐⭐ 95      │   │
│  │  ☑  TSLA  -3.8%   420%    6.1%     $1.2B    📰    ⭐⭐⭐⭐⭐ 92      │   │
│  │  ☑  AMD   +2.5%   280%    4.3%     $320M          ⭐⭐⭐⭐  85       │   │
│  │  ☑  META  +2.1%   195%    3.8%     $580M          ⭐⭐⭐⭐  82       │   │
│  │  ☐  AAPL  +1.2%   150%    2.1%     $1.5B          ⭐⭐⭐   68       │   │
│  │  ☐  MSFT  +0.8%   120%    1.8%     $890M          ⭐⭐    52        │   │
│  │  ...                                                                  │   │
│  │                                                                       │   │
│  │  💡 AI建议: NVDA和TSLA今日有重大新闻催化，建议重点关注                  │   │
│  │                                                                       │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  已选择: 4 只  (建议: 5-15只，不超过20只)                                    │
│                                                                             │
│  ┌─ 快速添加 ───────────────────────────────────────────────────────────┐   │
│  │ [🔍 搜索添加其他股票...]    例如: 自选股、ETF、指数                    │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│                            [确认监控列表，进入交易界面 →]                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**筛选条件定义**:
| 条件 | 默认值 | 说明 | 可调范围 |
|------|--------|------|----------|
| Gap | >2% | 开盘跳空幅度 | 1%-10% |
| 盘前成交量 | >200% | 相对日均量 | 100%-500% |
| 昨日波动率 | >3% | 前一日ATR% | 2%-8% |
| 流动性 | >$5M/日 | 日均成交额 | $1M-$50M |
| 有新闻 | 可选 | 重大新闻 | 开/关 |
| 财报日 | 可选 | 财报发布日 | 开/关 |

**策略评分算法**:
```
评分 = w1×Gap得分 + w2×成交量得分 + w3×波动率得分 + w4×新闻加分

其中:
• Gap得分: |Gap%| × 10 (上限50分)
• 成交量得分: min(盘前量%, 500) / 10 (上限50分)
• 波动率得分: 波动率% × 5 (上限25分)
• 新闻加分: 有新闻+10分

示例: NVDA
• Gap: +4.2% → 42分
• 盘前量: 385% → 38.5分
• 波动率: 5.2% → 26分 (cap 25)
• 新闻: 有 → +10分
• 总分: 42×0.3 + 38.5×0.3 + 25×0.2 + 10 = 95分
```

**数据需求**:
- 盘前数据源: Polygon.io Pre-market API
- 新闻数据: News API / Alpha Vantage
- 刷新频率: 每5分钟自动刷新
- 可用时间: 美东时间 4:00-9:30 AM

**API设计**:
```typescript
// 获取盘前扫描结果
GET /api/v1/intraday/pre-market-scanner
Query: {
  strategyId: string,
  filters: {
    minGap: number,
    minPremarketVolume: number,
    minVolatility: number,
    minLiquidity: number,
    hasNews: boolean,
    isEarningsDay: boolean
  }
}
Response: {
  scanTime: "2025-01-04T08:45:00Z",
  totalMatched: 47,
  stocks: [
    {
      symbol: "NVDA",
      name: "NVIDIA Corporation",
      gap: 4.2,
      premarketVolume: 385,
      volatility: 5.2,
      liquidity: 890000000,
      hasNews: true,
      newsHeadline: "NVDA announces new AI chip...",
      score: 95
    }
  ]
}

// 确认监控列表
POST /api/v1/intraday/watchlist
Body: {
  strategyId: string,
  date: "2025-01-04",
  symbols: ["NVDA", "TSLA", "AMD", "META", "SPY", "QQQ"]
}
```

---

### 4.18.1 日内交易专用视图 UI设计规格

**设计原则**: 日内交易与长线策略的本质差异决定了UI设计的不同取向：

| 维度 | 长线策略 | 日内交易 |
|------|----------|----------|
| 监控范围 | 500+ 股票 | 5-20 只高流动性股票 |
| 信号持续时间 | 数小时/天 | 几秒到几分钟 |
| 决策方式 | 扫描发现机会 | 专注快速执行 |
| 屏幕需求 | 信息密度高 | 图表面积大 |
| 左侧面板 | 完整信号雷达 (280px) | 简化监控列表 (100px) |

**整体布局** (简化版三栏):
```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  顶部状态栏 (h=48px)                                                                 │
│  [⚡日内交易监控] [动量策略] [🔴LIVE] [PDT:2/3] [账户:$28,450] [今日:+$385]           │
├─────────┬───────────────────────────────────────────────────────────────┬───────────┤
│         │                                                               │           │
│ 今日    │  ┌─ 1分钟主图 (TradingView) ───────────────────────────────┐ │ ⚡快速    │
│ 监控    │  │                                                          │ │ 交易      │
│ (100px) │  │  NVDA  $142.52 +$0.15 (+0.11%)  [1分钟] ATR:$0.68       │ │ (320px)   │
│         │  │                                                          │ │           │
│ ┌─────┐ │  │  🎯止盈(策略) $145.00 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │ │ [NVDA▼]   │
│ │NVDA │ │  │  ─ ─ 阻力 $143.80 ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─    │ │ $142.52   │
│ │+0.11│ │  │  🎯止盈(用户) $143.20 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │ │           │
│ └─────┘ │  │                                                          │ │ 买入:     │
│ ┌─────┐ │  │  ━━━━━━━━━ 当前 $142.52 ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │ │ [100][500]│
│ │TSLA │ │  │                                                          │ │ [1000]    │
│ │🟢   │ │  │  ▲入场 $141.50  ●持仓                                   │ │ [市价买入]│
│ └─────┘ │  │  ─ ─ 支撑 $141.00 ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─    │ │           │
│ ┌─────┐ │  │  🛑止损 $140.50 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │ │ 卖出比例: │
│ │AMD  │ │  │                                                          │ │ [25%][50%]│
│ │🟠   │ │  └──────────────────────────────────────────────────────────┘ │ [100%]    │
│ └─────┘ │                                                               │ [市价卖出]│
│ ┌─────┐ │  ┌─ 5分钟副图 (宏观趋势) ──────────────────────────────────┐ │           │
│ │AAPL │ │  │  [5分钟] 宏观趋势: 上升 ▲                                │ │ ⏰时间止损│
│ │+0.45│ │  │  VIX: 18.2  SPY: +0.3%  QQQ: +0.5%  纳指期货: +0.4%     │ │ [15:55▼] │
│ └─────┘ │  └──────────────────────────────────────────────────────────┘ │           │
│ ┌─────┐ │                                                               │ ⚠️PDT警告 │
│ │SPY  │ │  ┌─ 今日交易记录 ──────────────────────────────────────────┐ │ 剩余:1次  │
│ │+0.28│ │  │ 时间  股票 方向 数量 价格   止损   止盈   盈亏           │ │           │
│ └─────┘ │  │ 09:32 AAPL 买入 100 $185.2 $183.5 $187.0  -            │ │ [🛑一键平]│
│         │  │ 09:45 AAPL 卖出 100 $185.8  -    止盈  +$60            │ │ [⏸️暂停]  │
│ 🟢买入  │  │ 10:15 NVDA 买入 200 $141.5 $140.5 $143.2 +$204🔴       │ │           │
│ 🟠卖出  │  └──────────────────────────────────────────────────────────┘ │           │
└─────────┴───────────────────────────────────────────────────────────────┴───────────┘
```

**左侧简化监控列表** (w=100px):
```
┌─ 今日监控 ──────────────┐
│ (点击切换股票)          │
├─────────────────────────┤
│ ┌───────────────────┐   │
│ │ NVDA      ← 当前  │   │  蓝色高亮 = 正在查看
│ │ +0.11%            │   │
│ └───────────────────┘   │
│ ┌───────────────────┐   │
│ │ TSLA         🟢   │   │  🟢 = 买入信号
│ │ +1.85%            │   │
│ └───────────────────┘   │
│ ┌───────────────────┐   │
│ │ AMD          🟠   │   │  🟠 = 卖出信号
│ │ -0.32%            │   │
│ └───────────────────┘   │
│ ┌───────────────────┐   │
│ │ AAPL              │   │  无标记 = 监控中
│ │ +0.45%            │   │
│ └───────────────────┘   │
│ ┌───────────────────┐   │
│ │ SPY               │   │
│ │ +0.28%            │   │
│ └───────────────────┘   │
├─────────────────────────┤
│ [+ 添加股票]            │
└─────────────────────────┘

特点:
- 宽度仅100px，最大化图表面积
- 点击即切换股票
- 信号状态实时显示
- 支持拖拽排序
```

**与信号雷达的对比**:
| 功能 | 信号雷达 (长线) | 简化监控列表 (日内) |
|------|----------------|---------------------|
| 宽度 | 280px | 100px |
| 搜索框 | ✅ 有 | ❌ 无 (开盘前选好) |
| 股票池选择 | ✅ 有 | ❌ 无 |
| 状态分布统计 | ✅ 有 | ❌ 无 |
| 接近触发 | ✅ 显示 | ❌ 不显示 |
| 因子详情 | ✅ 展开显示 | ❌ 无 |
| 信号标记 | ✅ 分组显示 | ✅ 简单标记 |

**日内交易股票选择流程**:
```
开盘前 (Pre-market)          开盘后 (Trading Hours)
┌────────────────────┐       ┌────────────────────┐
│  晨间扫描器        │       │  简化监控列表       │
│  ───────────────   │       │  ───────────────   │
│  筛选条件:         │       │  只显示已选股票     │
│  • Gap > 2%        │  →    │  专注快速执行       │
│  • 成交量 > 2倍    │       │  无干扰信息         │
│                    │       │                    │
│  [添加到今日监控]  │       │  [点击切换图表]     │
└────────────────────┘       └────────────────────┘
```

**止盈止损设置面板 (日内交易专属)**:
```
┌─ 🛡️ 止盈止损设置 ──────────────────────┐
│                                        │
│  当前持仓: NVDA 200股 @$141.50         │
│  浮盈: +$204 (+0.72%)                  │
│                                        │
│  ┌─ 🛑 止损 ─────────────────────────┐ │
│  │ 方式: [ATR动态▼] (固定/百分比/技术)│ │
│  │                                    │ │
│  │ ATR倍数: [1.5x▼]  当前ATR: $0.68  │ │
│  │                                    │ │
│  │ 止损价: [$140.50]  ← 可手动微调    │ │
│  │                                    │ │
│  │ 💡 支撑位: $141.00 (建议设在此下方) │ │
│  └────────────────────────────────────┘ │
│                                        │
│  ┌─ 🎯 止盈 ─────────────────────────┐ │
│  │ 方式: [ATR动态▼]                   │ │
│  │                                    │ │
│  │ ATR倍数: [2.5x▼]  盈亏比: 1:1.7   │ │
│  │                                    │ │
│  │ 止盈价: [$143.20]  ← 可手动微调    │ │
│  │                                    │ │
│  │ 💡 阻力位: $143.80                  │ │
│  └────────────────────────────────────┘ │
│                                        │
│  ┌─ ⏰ 时间止损 (日内专属) ───────────┐ │
│  │ ☑ 启用收盘前自动平仓               │ │
│  │                                    │ │
│  │ 平仓时间: [15:55▼] (收盘前5分钟)   │ │
│  │ 提醒时间: [15:45▼] (收盘前15分钟)  │ │
│  │                                    │ │
│  │ ⚠️ 到达时间后自动市价平仓          │ │
│  └────────────────────────────────────┘ │
│                                        │
│  ┌─ 📈 移动止损 (可选) ──────────────┐ │
│  │ ☐ 启用移动止损 (Trailing Stop)    │ │
│  │                                    │ │
│  │ 触发条件: 盈利达 [0.5]%            │ │
│  │ 跟踪距离: [0.3]%                   │ │
│  └────────────────────────────────────┘ │
│                                        │
│  [应用止盈止损设置]                     │
│                                        │
└────────────────────────────────────────┘
```

**止盈止损方式对比**:
| 方式 | 计算公式 | 适用场景 |
|------|----------|----------|
| ATR动态 | 入场价 ± N×ATR | 自动适应波动率 |
| 固定价格 | 用户指定价格 | 有明确价位目标 |
| 百分比 | 入场价 × (1±N%) | 固定比例风控 |
| 技术位 | 支撑/阻力位 | 技术分析派 |

**图表止盈止损线样式**:
| 线条 | 颜色 | 样式 | 说明 |
|------|------|------|------|
| 止盈(策略) | `#22c55e` 绿色 | 虚线 2px | 策略自动计算 |
| 止盈(用户) | `#4ade80` 亮绿 | 实线 2px | 用户调整后 |
| 止损(策略) | `#ef4444` 红色 | 虚线 2px | 策略自动计算 |
| 止损(用户) | `#f87171` 亮红 | 实线 2px | 用户调整后 |
| 阻力位 | `#f97316` 橙色 | 点线 1px | 参考线 |
| 支撑位 | `#06b6d4` 青色 | 点线 1px | 参考线 |
| 入场价 | `#3b82f6` 蓝色 | 点线 1px | 成本价 |

**快速交易面板设计**:
```
┌─ ⚡ 快速交易 ──────────────────────────┐
│                                        │
│  [NVDA▼]              $142.52 +0.11%  │
│                       ATR: $0.68       │
│                                        │
│  ┌─ 买入 ────────────────────────────┐ │
│  │ [100] [500] [1000] [____自定义___] │ │
│  │                                    │ │
│  │ [████ 市价买入 ████]  [142.40][限价]│ │
│  └────────────────────────────────────┘ │
│                                        │
│  ┌─ 卖出 (持仓: 200股) ──────────────┐ │
│  │ [25%] [50%] [100%] [____自定义___] │ │
│  │                                    │ │
│  │ [████ 市价卖出 ████]  [142.80][限价]│ │
│  └────────────────────────────────────┘ │
│                                        │
└────────────────────────────────────────┘
```

**PDT警告面板**:
```
┌─ ⚠️ PDT规则限制 ─────────────────────┐
│                                        │
│  今日剩余日内交易: 1 次               │
│                                        │
│  本周已用: 2 / 3                       │
│  ████████████░░░░░░                    │
│                                        │
│  重置时间: 周三 (3天后)                │
│                                        │
│  💡 入金至 $25,000 可解除限制          │
│                                        │
└────────────────────────────────────────┘
```

**今日交易记录表格**:
| 列名 | 宽度 | 说明 |
|------|------|------|
| 时间 | 60px | HH:mm格式 |
| 股票 | 60px | 股票代码 |
| 方向 | 50px | 买入(绿)/卖出(红) |
| 数量 | 60px | 交易数量 |
| 价格 | 70px | 成交价格 |
| 止损 | 70px | 止损价(买入时显示) |
| 止盈 | 70px | 止盈价(买入时显示) |
| 盈亏 | 80px | 已平仓显示盈亏，持仓中显示浮盈+🔴 |

---

## 附录

### A. 完整决策记录

以下是产品讨论过程中确认的所有关键决策：

| # | 决策项 | 用户决定 | 备注 |
|---|--------|----------|------|
| Q1 | 保存策略查看位置 | 新增"我的策略"页面 | P0优先级 |
| Q2 | AI连接状态 | 显示连接状态指示器 | 🟢已连接/🟡连接中/🔴未连接 |
| Q3 | 运行回测流程 | 弹出选择框，可选跳转或留在当前页 | - |
| Q4 | 初学者引导 | 引导式AI对话 + 自动填写表单 | P1优先级 |
| Q5 | 因子研究 | 需要因子有效性验证系统 | 包含IC、多空收益差等 |
| Q6 | 策略模板 | 6个模板(含日内交易) | 巴菲特/动量/红利/多因子/轮动/日内 |
| Q7 | 风险预警通知 | Phase1邮件 → Phase2微信 → Phase3 App | - |
| Q8 | 教育内容 | 需要，但优先级低 | P3 |
| Q9 | 策略版本管理 | 需要，支持对比和回滚 | P1优先级 |
| Q10 | 多策略冲突 | 不同类型策略≠逻辑冲突；超时取消；保留记录 | 详见4.6节 |
| Q11 | 实盘vs回测监控 | 需要，使用更严格阈值 | 收益差异>10%即预警 |
| Q12 | 交易执行时间 | 日内1分钟为主，5分钟看宏观；支持自定义 | PDT规则整合 |
| Q13 | 冲突超时时间 | 日内1分钟，其他可配置 | 不同策略类型同股票≠冲突 |
| Q14 | 系统可用性 | 99.9%；故障时取消挂单；需要备用通道 | - |
| Q15 | 多用户权限 | 未来需要，当前不实现 | P3 |
| Q16 | 税务功能 | 需要，含提现预估和Wash Sale检测 | P1优先级 |
| Q17 | 数据备份 | 企业级/机构级 | - |
| Q18 | 移动端 | 需要 | P2优先级 |
| Q19 | 定价模式 | 暂不考虑，盈利后再说 | - |
| Q20 | 项目名称 | 暂定QuantVision | 后续可改 |
| Q21 | 图表数据实时性 | 实时 (<1秒) | Polygon.io WebSocket |
| Q22 | 手动交易与策略 | 分策略独立计算；卖出只卖对应策略 | 专业标准 |
| Q23 | 策略回放 | 需要 | P1优先级 |
| Q24 | TradingView版本 | 免费版 | 数据实时性依赖Polygon.io |
| Q25 | 历史数据存储 | 1分钟K线 (~50GB/年) | 成本可控 |

### B. 交易成本默认配置

| 成本项 | 最低限制 | 默认值 | 说明 |
|--------|:--------:|:------:|------|
| 佣金 | $0.003/股 | $0.005/股 | 机构级别费率 |
| SEC费用 | $0.0000278/$ | $0.0000278/$ | 固定法规费用 |
| 滑点-大盘股 | 0.02% | 0.05% | 市值>100亿 |
| 滑点-中盘股 | 0.05% | 0.10% | 市值10-100亿 |
| 滑点-小盘股 | 0.15% | 0.25% | 市值<10亿 |
| 市场冲击 | 0.1×σ×√(V/ADV) | Almgren-Chriss | 基于波动率和成交量 |

### C. 实盘vs回测监控阈值

| 监控项 | 黄色预警 | 红色预警 |
|--------|:--------:|:--------:|
| 收益差异 | >10% | >20% |
| 胜率差异 | >5% | >10% |
| 换手率差异 | >20% | >35% |
| 滑点差异 | >30% | >50% |
| 最大回撤差异 | >15% | >25% |
| 持仓时间差异 | >25% | >40% |

### D. PDT规则配置

| 账户类型 | 盘前交易 | 常规交易 | 盘后交易 | 日内交易次数 |
|----------|:--------:|:--------:|:--------:|:------------:|
| < $25K | ❌ | ✅ 9:30-16:00 | ❌ | 3次/5天 |
| ≥ $25K | ✅ 4:00-9:30 | ✅ 9:30-16:00 | ✅ 16:00-20:00 | 无限制 |

### E. 冲突处理超时配置

| 策略类型 | 超时时间 | 超时处理 |
|----------|:--------:|----------|
| 日内交易 | 1分钟 | 自动取消 |
| 短线策略 | 30分钟 | 自动取消 |
| 中长线策略 | 2小时 | 自动取消 |

### F. 参考文档

- Phase 8-14 技术报告
- 用户访谈记录 (本文档)
- 竞品分析报告

### G. 术语表

| 术语 | 含义 |
|------|------|
| PDT | Pattern Day Trader，美股日内交易规则 |
| IC | Information Coefficient，信息系数 |
| Wash Sale | 洗售规则，30天内买回亏损股票不可抵税 |
| MCP | Model Context Protocol，模型上下文协议 |
| IBKR | Interactive Brokers，盈透证券 |
| ADV | Average Daily Volume，日均成交量 |
| σ | 波动率 (Volatility) |

### H. 变更记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | 2025-01-04 | 初始版本，包含Q1-Q16决策 |
| 1.1 | 2025-01-04 | 新增实时交易监控、策略回放、分策略持仓管理 |
| 1.2 | 2025-01-04 | 完善Q17-Q25决策，更新里程碑规划 |
| 1.3 | 2025-01-04 | 新增UI设计规格：实时交易监控界面、策略回放界面、日内交易专用视图完整UI设计 |
| 1.4 | 2025-01-04 | 新增信号雷达与股票池管理 (4.16.2节)：股票搜索、股票池管理、信号状态监控、接近触发计算逻辑 |
| 1.5 | 2025-01-04 | 信号雷达完善：添加卖出信号展示；日内交易优化：用简化版监控列表(100px)替代完整信号雷达(280px) |
| 1.6 | 2025-01-04 | **新增策略部署与环境管理** (4.15节)：策略生命周期、部署向导(4步)、模拟盘/实盘切换、策略管理中心；**新增盘前扫描器** (4.18.0节)：日内交易股票选择流程、筛选条件配置、策略评分算法 |

### I. UI设计资源

**设计稿文件**: `QuantVision-UI-Design-v2.4-professional.html`

**包含界面**:
1. 实时交易监控界面 - 三栏布局，含信号雷达面板、环境切换器
2. 策略回放界面 - 回放控制、因子显示、信号日志
3. 日内交易专用视图 - 盘前扫描器、简化监控列表、1分钟/5分钟双图、止盈止损面板、PDT管理

**技术实现说明**:
| 组件 | 实现方式 | 说明 |
|------|----------|------|
| K线图表 | TradingView Widget | 免费版，嵌入式集成 |
| 实时数据 | Polygon.io WebSocket | <1秒延迟 |
| 信号覆盖层 | Canvas/SVG | 自定义绑制在图表上 |
| 止盈止损线 | SVG Line | 可拖拽交互 |
| 右侧面板 | React组件 | 可滚动，自定义滚动条 |

**颜色系统**:
```
背景色系:
  主背景: #0a0a1a
  面板背景: #0d0d1f
  工具栏: #12122a
  输入框: #1a1a3a
  边框: #2a2a4a
  悬停: #3a3a5a

功能色:
  买入/盈利: #22c55e (绿)
  卖出/亏损: #ef4444 (红)
  当前价格: #3b82f6 (蓝)
  回放模式: #8b5cf6 (紫)
  待处理: #eab308 (黄)
  阻力位: #f97316 (橙)
  支撑位: #06b6d4 (青)
```

---

**文档结束**

---

## 快速参考卡片

```
┌─────────────────────────────────────────────────────────────────┐
│  QuantVision v2.1 - 快速参考                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  🎯 核心目标                                                     │
│  ────────────────────────────────────────────────────────────   │
│  • 解决用户痛点 (策略管理、AI状态、流程优化)                      │
│  • 增强专业功能 (因子验证、交易归因、实时监控)                    │
│  • 保障交易安全 (冲突检测、PDT管理、风险预警)                     │
│                                                                 │
│  📅 策略生命周期                                                 │
│  ────────────────────────────────────────────────────────────   │
│  📝创建 → ✅回测 → 🔵模拟盘 → 🟢实盘 → 📊监控                    │
│                                                                 │
│  🔄 环境管理                                                     │
│  ────────────────────────────────────────────────────────────   │
│  🔵 模拟盘: 虚拟资金、无风险、验证策略                            │
│  🟢 实盘: 真实资金、真实执行、需模拟盘验证≥30天                   │
│                                                                 │
│  🎨 UI设计规格 (v1.6更新)                                        │
│  ────────────────────────────────────────────────────────────   │
│  • 策略部署向导: 4.15节 (4步部署流程)                            │
│  • 信号雷达与股票池: 4.16.2节 (含卖出信号)                       │
│  • 实时交易监控: 4.16.1节 (三栏: 280px|图表|288px)               │
│  • 策略回放: 4.17.1节                                           │
│  • 盘前扫描器: 4.18.0节 (日内股票选择)                           │
│  • 日内交易视图: 4.18.1节 (三栏: 100px|图表|320px)               │
│  • 设计稿: QuantVision-UI-Design-v2.4-professional.html         │
│                                                                 │
│  📡 信号雷达功能                                                 │
│  ────────────────────────────────────────────────────────────   │
│  • 股票池管理: SP500/NASDAQ100/行业/自选                         │
│  • 信号状态: 🔴持仓 🟢买入 🟠卖出 🟡接近 ⚪监控                   │
│  • 接近触发: 因子值达阈值80%即显示                               │
│  • 快速搜索: Ctrl+K全局搜索股票                                  │
│                                                                 │
│  ⚡ 日内交易 vs 长线策略                                         │
│  ────────────────────────────────────────────────────────────   │
│  长线: 完整信号雷达(280px) - 扫描500+股票发现机会                 │
│  日内: 盘前扫描器→简化列表(100px) - 专注5-20只股票快速执行        │
│                                                                 │
│  ⚠️ 关键约束                                                     │
│  ────────────────────────────────────────────────────────────   │
│  • PDT: <$25K 账户每5天最多3次日内交易                           │
│  • 模拟盘验证: 新策略需模拟盘运行≥30天才能转实盘                  │
│  • 成本: 不可低于市场最低成本                                    │
│  • 可用性: 99.9% (月停机<44分钟)                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```
