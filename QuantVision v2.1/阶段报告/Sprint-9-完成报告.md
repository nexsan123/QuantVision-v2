# Sprint-9 å®ŒæˆæŠ¥å‘Š: ç­–ç•¥å›æ”¾åŠŸèƒ½

## æ¦‚è¿°

Sprint-9 å®ç°äº†ç­–ç•¥å›æ”¾åŠŸèƒ½ï¼Œè®©ç”¨æˆ·å¯ä»¥å›æ”¾å†å²è¡Œæƒ…ï¼Œè§‚å¯Ÿç­–ç•¥åœ¨è¿‡å»çš„ä¿¡å·å’Œæ‰§è¡Œæƒ…å†µã€‚

**ä½¿ç”¨åœºæ™¯**:
- åˆå­¦è€…ç†è§£ç­–ç•¥é€»è¾‘
- éªŒè¯ç­–ç•¥åœ¨ç‰¹å®šäº‹ä»¶ä¸­çš„è¡¨ç°
- Debugç­–ç•¥é—®é¢˜

## å®Œæˆå†…å®¹

### Part A: åç«¯æ•°æ®æœåŠ¡

#### 1. å›æ”¾Schema (`backend/app/schemas/replay.py`)

| æ¨¡å‹ | æè¿° |
|------|------|
| `ReplaySpeed` | å›æ”¾é€Ÿåº¦æšä¸¾ (0.5x/1x/2x/5x) |
| `ReplayStatus` | å›æ”¾çŠ¶æ€ (idle/playing/paused) |
| `ReplayConfig` | å›æ”¾é…ç½® (ç­–ç•¥/è‚¡ç¥¨/æ—¥æœŸ/é€Ÿåº¦) |
| `ReplayState` | å›æ”¾çŠ¶æ€ (è¿›åº¦/æŒä»“/ç»Ÿè®¡) |
| `HistoricalBar` | å†å²Kçº¿æ•°æ® |
| `FactorSnapshot` | å› å­å¿«ç…§ |
| `SignalEvent` | ä¿¡å·äº‹ä»¶ |
| `ReplayInsight` | å›æ”¾æ´å¯Ÿ |

#### 2. å†å²æ•°æ®æœåŠ¡ (`backend/app/services/historical_data_service.py`)

| æ–¹æ³• | æè¿° |
|------|------|
| `get_historical_bars()` | è·å–å†å²Kçº¿æ•°æ® |
| `get_factor_snapshots()` | è·å–å†å²å› å­å¿«ç…§ |
| `stream_bars()` | æµå¼è¿”å›Kçº¿ |
| `_calculate_factors()` | å®æ—¶è®¡ç®—å› å­å€¼ |

**å› å­è®¡ç®—æ”¯æŒ**:
- RSI (14å‘¨æœŸ)
- MACD (12/26/9)
- æ³¢åŠ¨ç‡ (20å‘¨æœŸ)
- æˆäº¤é‡æ¯”ç‡

#### 3. å›æ”¾å¼•æ“æœåŠ¡ (`backend/app/services/replay_engine_service.py`)

| æ–¹æ³• | æè¿° |
|------|------|
| `init_replay()` | åˆå§‹åŒ–å›æ”¾ä¼šè¯ |
| `play()` / `pause()` | æ’­æ”¾æ§åˆ¶ |
| `step_forward()` / `step_backward()` | å•æ­¥æ§åˆ¶ |
| `seek_to_time()` | è·³è½¬åˆ°æŒ‡å®šæ—¶é—´ |
| `seek_to_next_signal()` | è·³è½¬åˆ°ä¸‹ä¸€ä¿¡å· |
| `set_speed()` | è®¾ç½®å›æ”¾é€Ÿåº¦ |
| `get_insight()` | è·å–å›æ”¾æ´å¯Ÿ |

#### 4. å›æ”¾API (`backend/app/api/v1/replay.py`)

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| POST | `/api/v1/replay/init` | åˆå§‹åŒ–å›æ”¾ |
| POST | `/api/v1/replay/{id}/play` | å¼€å§‹æ’­æ”¾ |
| POST | `/api/v1/replay/{id}/pause` | æš‚åœ |
| POST | `/api/v1/replay/{id}/step-forward` | å‰è¿›ä¸€æ­¥ |
| POST | `/api/v1/replay/{id}/step-backward` | åé€€ä¸€æ­¥ |
| POST | `/api/v1/replay/{id}/seek` | è·³è½¬æ—¶é—´ |
| POST | `/api/v1/replay/{id}/next-signal` | ä¸‹ä¸€ä¿¡å· |
| PUT | `/api/v1/replay/{id}/speed` | è®¾ç½®é€Ÿåº¦ |
| GET | `/api/v1/replay/{id}/insight` | è·å–æ´å¯Ÿ |
| GET | `/api/v1/replay/{id}/export` | å¯¼å‡ºè®°å½• |
| WS | `/api/v1/replay/{id}/stream` | å®æ—¶æµ |

### Part B: å‰ç«¯å›æ”¾ç•Œé¢

#### 1. ç±»å‹å®šä¹‰ (`frontend/src/types/replay.ts`)

- ReplayState, ReplayConfig ç±»å‹
- FactorSnapshot, SignalEvent ç±»å‹
- REPLAY_COLORS é¢œè‰²é…ç½®
- REPLAY_SPEEDS é€Ÿåº¦é…ç½®
- è¾…åŠ©å‡½æ•° (formatReplayTime, formatPercentç­‰)

#### 2. å›æ”¾ç»„ä»¶ (`frontend/src/components/Replay/`)

| ç»„ä»¶ | æè¿° |
|------|------|
| `ReplayControlBar.tsx` | å›æ”¾æ§åˆ¶æ¡ (æ—¥æœŸé€‰æ‹©/æ’­æ”¾æŒ‰é’®/è¿›åº¦æ¡) |
| `FactorPanel.tsx` | å› å­å€¼é¢æ¿ (å®æ—¶æ˜¾ç¤ºå› å­çŠ¶æ€) |
| `SignalEventLog.tsx` | ä¿¡å·äº‹ä»¶æ—¥å¿— |
| `ReplayInsightPanel.tsx` | å›æ”¾æ´å¯Ÿé¢æ¿ |
| `index.ts` | ç»„ä»¶å¯¼å‡º |

#### 3. å›æ”¾é¡µé¢ (`frontend/src/pages/StrategyReplay/index.tsx`)

**é¡µé¢å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯¼èˆªæ   |  ç­–ç•¥åç§°  |  ğŸŸ£å›æ”¾æ¨¡å¼  |  é€€å‡ºå›æ”¾         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ—¥æœŸé€‰æ‹©  |  è‚¡ç¥¨  |  é€Ÿåº¦  |  â®âªâ–¶â©â­  |  è¿›åº¦æ¡     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                       â”‚   å› å­å€¼é¢æ¿     â”‚
â”‚         TradingView å›¾è¡¨              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                       â”‚   ä¿¡å·äº‹ä»¶æ—¥å¿—   â”‚
â”‚                                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                       â”‚   å›æ”¾æ´å¯Ÿé¢æ¿   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     æ¨¡æ‹ŸæŒä»“                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŠŸèƒ½ç‰¹æ€§**:
- æ’­æ”¾/æš‚åœ/å•æ­¥å‰è¿›åé€€
- å¿«è¿›10æ­¥/è·³è½¬åˆ°ä¸‹ä¸€ä¿¡å·
- é€Ÿåº¦è°ƒèŠ‚ (0.5x/1x/2x/5x)
- è¿›åº¦æ¡å¸¦ä¿¡å·æ ‡è®°ç‚¹
- å› å­å€¼å®æ—¶æ›´æ–°
- ä¿¡å·è§¦å‘è®°å½•
- å›æ”¾ç»“æŸç”Ÿæˆæ´å¯Ÿ

### è·¯ç”±æ³¨å†Œ

å·²åœ¨ `backend/app/main.py` æ³¨å†Œ:
```python
# v2.1 Sprint 9: ç­–ç•¥å›æ”¾ API (PRD 4.17)
app.include_router(
    replay.router,
    prefix=settings.API_V1_PREFIX,
    tags=["ç­–ç•¥å›æ”¾"],
)
```

## æ•°æ®ç»“æ„

### ReplayState
```typescript
interface ReplayState {
  sessionId: string
  config: ReplayConfig
  status: 'idle' | 'playing' | 'paused'
  currentTime: string
  currentBarIndex: number
  totalBars: number
  positionQuantity: number
  positionAvgCost: number
  cash: number
  totalSignals: number
  executedSignals: number
  totalReturnPct: number
  benchmarkReturnPct: number
}
```

### FactorSnapshot
```typescript
interface FactorSnapshot {
  timestamp: string
  factorValues: Record<string, number>
  thresholds: Record<string, ThresholdConfig>
  overallSignal: 'buy' | 'sell' | 'hold'
  conditionsMet: number
  conditionsTotal: number
}
```

## æ–°å¢æ–‡ä»¶æ¸…å•

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â””â”€â”€ replay.py                    # å›æ”¾Schema
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ historical_data_service.py   # å†å²æ•°æ®æœåŠ¡
â”‚   â”‚   â””â”€â”€ replay_engine_service.py     # å›æ”¾å¼•æ“æœåŠ¡
â”‚   â””â”€â”€ api/v1/
â”‚       â””â”€â”€ replay.py                    # å›æ”¾API

frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ replay.ts                    # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ Replay/
â”‚   â”‚       â”œâ”€â”€ index.ts
â”‚   â”‚       â”œâ”€â”€ ReplayControlBar.tsx
â”‚   â”‚       â”œâ”€â”€ FactorPanel.tsx
â”‚   â”‚       â”œâ”€â”€ SignalEventLog.tsx
â”‚   â”‚       â””â”€â”€ ReplayInsightPanel.tsx
â”‚   â””â”€â”€ pages/
â”‚       â””â”€â”€ StrategyReplay/
â”‚           â””â”€â”€ index.tsx                # å›æ”¾é¡µé¢
```

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `backend/app/main.py` | æ·»åŠ replayè·¯ç”±æ³¨å†Œ |

## æ ¸å¿ƒç®—æ³•

### å› å­è®¡ç®—
- **RSI**: 14å‘¨æœŸç›¸å¯¹å¼ºå¼±æŒ‡æ ‡
- **MACD**: 12/26/9å‚æ•°ï¼Œå¿«æ…¢çº¿å·®å€¼
- **æ³¢åŠ¨ç‡**: 20å‘¨æœŸæ”¶ç›Šç‡æ ‡å‡†å·®
- **æˆäº¤é‡æ¯”ç‡**: å½“å‰æˆäº¤é‡/20æ—¥å¹³å‡

### ä¿¡å·åˆ¤æ–­
- æ¡ä»¶æ»¡è¶³æ•° >= 3: ä¹°å…¥ä¿¡å·
- æ¡ä»¶æ»¡è¶³æ•° <= 1: å–å‡ºä¿¡å·
- å…¶ä»–: æŒæœ‰

### AIæ´å¯Ÿç”Ÿæˆ
- ç­–ç•¥vsåŸºå‡†æ”¶ç›Šå¯¹æ¯”
- ä¿¡å·æ‰§è¡Œç‡åˆ†æ
- ä¿¡å·é¢‘ç‡å»ºè®®

## æµ‹è¯•å»ºè®®

1. **åˆå§‹åŒ–æµ‹è¯•**: æ—¥æœŸèŒƒå›´é€‰æ‹©åæ­£ç¡®åŠ è½½æ•°æ®
2. **æ’­æ”¾æ§åˆ¶æµ‹è¯•**: æ’­æ”¾/æš‚åœ/å•æ­¥/å¿«è¿›æ­£å¸¸
3. **å› å­è®¡ç®—æµ‹è¯•**: å› å­å€¼å®æ—¶æ›´æ–°
4. **ä¿¡å·è§¦å‘æµ‹è¯•**: ä¿¡å·æ­£ç¡®è§¦å‘å¹¶è®°å½•
5. **æ´å¯Ÿç”Ÿæˆæµ‹è¯•**: å›æ”¾ç»“æŸåç”Ÿæˆæ´å¯Ÿ

## å®Œæˆæ—¶é—´

2025å¹´1æœˆ5æ—¥
