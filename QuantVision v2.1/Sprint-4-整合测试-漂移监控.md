# Sprint 4: æ•´åˆæµ‹è¯• + ç­–ç•¥æ¼‚ç§»ç›‘æ§ (6å¤©)

> **æ–‡æ¡£ç‰ˆæœ¬**: 2.0  
> **é¢„è®¡æ—¶é•¿**: 6å¤© (åŸ3å¤© + æ–°å¢3å¤©)  
> **å‰ç½®ä¾èµ–**: Sprint 1-3 å…¨éƒ¨å®Œæˆ  
> **PRDå‚è€ƒ**: 4.8 å®ç›˜vså›æµ‹å·®å¼‚ç›‘æ§  
> **äº¤ä»˜ç‰©**: Sprint 1-3åŠŸèƒ½å®Œæ•´æµ‹è¯•ã€Bugä¿®å¤ã€ç­–ç•¥æ¼‚ç§»ç›‘æ§ç³»ç»Ÿ

---

## ç›®æ ‡

1. å¯¹Sprint 1-3çš„åŠŸèƒ½è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼Œä¿®å¤Bug
2. **æ–°å¢**: å®ç°å®ç›˜vså›æµ‹å·®å¼‚ç›‘æ§ (ç­–ç•¥æ¼‚ç§»ç›‘æ§)

---

## Part A: æ•´åˆæµ‹è¯• (3å¤©)

### Task 4.1: ç«¯åˆ°ç«¯æµ‹è¯•åœºæ™¯

#### åœºæ™¯1: ç­–ç•¥åˆ›å»ºåˆ°éƒ¨ç½²

```
æ­¥éª¤:
1. è¿›å…¥ StrategyBuilder é¡µé¢
2. åˆ›å»ºä¸€ä¸ªæ–°ç­–ç•¥ (é€‰æ‹©å› å­ã€è®¾ç½®è§„åˆ™)
3. è¿è¡Œå›æµ‹éªŒè¯
4. ä¿å­˜ç­–ç•¥
5. è¿›å…¥ "æˆ‘çš„ç­–ç•¥" é¡µé¢
6. æ‰¾åˆ°æ–°åˆ›å»ºçš„ç­–ç•¥
7. ç‚¹å‡» "éƒ¨ç½²" æŒ‰é’®
8. å®Œæˆ4æ­¥éƒ¨ç½²å‘å¯¼
9. ç¡®è®¤ç­–ç•¥åœ¨æ¨¡æ‹Ÿç›˜å¯åŠ¨

éªŒæ”¶æ ‡å‡†:
- [ ] ç­–ç•¥åˆ›å»ºæµç¨‹é¡ºç•…
- [ ] ç­–ç•¥åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤º
- [ ] éƒ¨ç½²å‘å¯¼4æ­¥å®Œæ•´
- [ ] æ¨¡æ‹Ÿç›˜å¯åŠ¨æˆåŠŸ
```

#### åœºæ™¯2: æ¨¡æ‹Ÿç›˜åˆ°å®ç›˜åˆ‡æ¢

```
æ­¥éª¤:
1. å‡†å¤‡ä¸€ä¸ªè¿è¡Œä¸­çš„æ¨¡æ‹Ÿç›˜ç­–ç•¥
2. ç¡®è®¤è¿è¡Œæ»¡30å¤© (æˆ–ä½¿ç”¨æµ‹è¯•æ•°æ®)
3. ç¡®è®¤èƒœç‡ > 40%
4. ç‚¹å‡» "åˆ‡æ¢ç¯å¢ƒ"
5. é€‰æ‹© "å®ç›˜"
6. ç¡®è®¤é£é™©æç¤º
7. å®Œæˆåˆ‡æ¢

éªŒæ”¶æ ‡å‡†:
- [ ] æœªæ»¡è¶³æ¡ä»¶æ—¶æ˜¾ç¤ºé”™è¯¯
- [ ] æ»¡è¶³æ¡ä»¶æ—¶å¯åˆ‡æ¢
- [ ] é£é™©æç¤ºæ˜¾ç¤ºæ­£ç¡®
- [ ] åˆ‡æ¢åçŠ¶æ€æ­£ç¡®
```

#### åœºæ™¯3: ä¿¡å·é›·è¾¾ç›‘æ§

```
æ­¥éª¤:
1. è¿›å…¥ Trading é¡µé¢
2. æŸ¥çœ‹ä¿¡å·é›·è¾¾é¢æ¿
3. ç¡®è®¤ä¹°å…¥/å–å‡ºä¿¡å·æ˜¾ç¤º
4. ä½¿ç”¨ç­›é€‰åŠŸèƒ½
5. æœç´¢ç‰¹å®šè‚¡ç¥¨
6. æŸ¥çœ‹ä¿¡å·è¯¦æƒ…

éªŒæ”¶æ ‡å‡†:
- [ ] ä¿¡å·åˆ—è¡¨æ­£ç¡®æ˜¾ç¤º
- [ ] ä¹°å…¥/å–å‡ºåŒºåˆ†æ˜ç¡®
- [ ] ç­›é€‰åŠŸèƒ½æ­£å¸¸
- [ ] æœç´¢åŠŸèƒ½æ­£å¸¸
```

#### åœºæ™¯4: PDTè§„åˆ™éªŒè¯

```
æ­¥éª¤:
1. æŸ¥çœ‹PDTçŠ¶æ€é¢æ¿
2. ç¡®è®¤å‰©ä½™æ¬¡æ•°æ˜¾ç¤º
3. æ¨¡æ‹Ÿæ¥è¿‘é™åˆ¶ (å‰©ä½™1æ¬¡)
4. ç¡®è®¤é»„è‰²è­¦å‘Šæ˜¾ç¤º
5. æ¨¡æ‹Ÿè¾¾åˆ°é™åˆ¶ (å‰©ä½™0æ¬¡)
6. ç¡®è®¤çº¢è‰²è­¦å‘Š + ç¦æ­¢äº¤æ˜“

éªŒæ”¶æ ‡å‡†:
- [ ] å‰©ä½™æ¬¡æ•°æ­£ç¡®
- [ ] è­¦å‘Šçº§åˆ«æ­£ç¡®
- [ ] é™åˆ¶æ—¶ç¦æ­¢æ—¥å†…äº¤æ˜“
```

#### åœºæ™¯5: AIè¿æ¥çŠ¶æ€

```
æ­¥éª¤:
1. æŸ¥çœ‹AIçŠ¶æ€æŒ‡ç¤ºå™¨
2. ç¡®è®¤æ­£å¸¸è¿æ¥çŠ¶æ€
3. æ¨¡æ‹Ÿæ–­å¼€è¿æ¥
4. ç¡®è®¤æ–­å¼€çŠ¶æ€æ˜¾ç¤º
5. ç‚¹å‡»é‡æ–°è¿æ¥
6. ç¡®è®¤é‡è¿æˆåŠŸ

éªŒæ”¶æ ‡å‡†:
- [ ] è¿æ¥çŠ¶æ€æ­£ç¡®
- [ ] æ–­å¼€æ—¶æ˜¾ç¤ºé”™è¯¯
- [ ] é‡è¿æŒ‰é’®å¯ç”¨
- [ ] é‡è¿æˆåŠŸ
```

#### åœºæ™¯6: é£é™©é¢„è­¦è§¦å‘ ğŸ†•

```
æ­¥éª¤:
1. é…ç½®é¢„è­¦é˜ˆå€¼ (å•æ—¥äºæŸ3%)
2. æ¨¡æ‹Ÿè§¦å‘æ¡ä»¶ (äºæŸè¾¾åˆ°3%)
3. ç¡®è®¤é¢„è­¦åˆ›å»º
4. ç¡®è®¤é‚®ä»¶å‘é€
5. åœ¨ç•Œé¢æŸ¥çœ‹é¢„è­¦
6. æ ‡è®°é¢„è­¦ä¸ºå·²è¯»

éªŒæ”¶æ ‡å‡†:
- [ ] é¢„è­¦è§¦å‘æ­£ç¡®
- [ ] é‚®ä»¶å‘é€æˆåŠŸ
- [ ] é¢„è­¦åˆ—è¡¨æ˜¾ç¤ºæ­£ç¡®
- [ ] å·²è¯»æ ‡è®°æ­£ç¡®
```

---

### Task 4.2: Bugä¿®å¤æ¸…å•

#### é«˜ä¼˜å…ˆçº§

| Bugæè¿° | é¢„æœŸè¡Œä¸º | çŠ¶æ€ |
|---------|----------|:----:|
| ç­–ç•¥åˆ—è¡¨åŠ è½½å¤±è´¥æ— é”™è¯¯æç¤º | æ˜¾ç¤ºå‹å¥½é”™è¯¯ä¿¡æ¯ | â¬œ |
| éƒ¨ç½²å‘å¯¼å…³é—­åæ•°æ®æœªæ¸…ç©º | é‡æ–°æ‰“å¼€æ—¶æ•°æ®é‡ç½® | â¬œ |
| ç¯å¢ƒåˆ‡æ¢åçŠ¶æ€æœªæ›´æ–° | ç«‹å³åˆ·æ–°çŠ¶æ€ | â¬œ |
| PDTå€’è®¡æ—¶ä¸å‡†ç¡® | ç§’çº§ç²¾ç¡®å€’è®¡æ—¶ | â¬œ |
| é¢„è­¦é‚®ä»¶å‘é€å¤±è´¥æ— é‡è¯• | å¤±è´¥åè‡ªåŠ¨é‡è¯•3æ¬¡ | â¬œ |

#### ä¸­ä¼˜å…ˆçº§

| Bugæè¿° | é¢„æœŸè¡Œä¸º | çŠ¶æ€ |
|---------|----------|:----:|
| ä¿¡å·é›·è¾¾è‡ªåŠ¨åˆ·æ–°è¿‡äºé¢‘ç¹ | 30ç§’åˆ·æ–°ä¸€æ¬¡ | â¬œ |
| ç­–ç•¥å¡ç‰‡hoveræ•ˆæœç¼ºå¤± | æ·»åŠ hoveré˜´å½± | â¬œ |
| AIçŠ¶æ€å»¶è¿Ÿæ˜¾ç¤ºä¸ç¨³å®š | å¹³æ»‘æ›´æ–°å»¶è¿Ÿå€¼ | â¬œ |
| é¢„è­¦é“ƒé“›æ•°é‡æ›´æ–°å»¶è¿Ÿ | å®æ—¶æ›´æ–° | â¬œ |

#### ä½ä¼˜å…ˆçº§

| Bugæè¿° | é¢„æœŸè¡Œä¸º | çŠ¶æ€ |
|---------|----------|:----:|
| è¡¨æ ¼åˆ†é¡µæ ·å¼ä¸ç»Ÿä¸€ | ç»Ÿä¸€åˆ†é¡µæ ·å¼ | â¬œ |
| éƒ¨åˆ†å›¾æ ‡å¤§å°ä¸ä¸€è‡´ | ç»Ÿä¸€å›¾æ ‡å°ºå¯¸ | â¬œ |

---

### Task 4.3: æ€§èƒ½ä¼˜åŒ–

#### å‰ç«¯ä¼˜åŒ–

```
ä¼˜åŒ–é¡¹:
1. ç­–ç•¥åˆ—è¡¨æ‡’åŠ è½½
2. ä¿¡å·é›·è¾¾è™šæ‹Ÿæ»šåŠ¨ (å¤§é‡æ•°æ®æ—¶)
3. ç»„ä»¶æŒ‰éœ€åŠ è½½
4. é¢„è­¦åˆ—è¡¨åˆ†é¡µåŠ è½½

æ£€æŸ¥é¡¹:
- [ ] é¦–é¡µåŠ è½½æ—¶é—´ < 2ç§’
- [ ] ç­–ç•¥åˆ—è¡¨æ¸²æŸ“ < 500ms
- [ ] ä¿¡å·é›·è¾¾æ›´æ–°æ— å¡é¡¿
- [ ] é¢„è­¦åˆ—è¡¨æ»šåŠ¨æµç•…
```

#### åç«¯ä¼˜åŒ–

```
ä¼˜åŒ–é¡¹:
1. æ•°æ®åº“æŸ¥è¯¢ç´¢å¼•
2. APIå“åº”ç¼“å­˜
3. å¹¶å‘å¤„ç†ä¼˜åŒ–
4. é‚®ä»¶å‘é€é˜Ÿåˆ—

æ£€æŸ¥é¡¹:
- [ ] APIå“åº”æ—¶é—´ < 200ms
- [ ] å¹¶å‘100ç”¨æˆ·æ— é”™è¯¯
- [ ] é‚®ä»¶å‘é€ä¸é˜»å¡ä¸»æµç¨‹
```

---

### Task 4.4: æ–‡æ¡£æ›´æ–°

| æ–‡æ¡£ | æ›´æ–°å†…å®¹ | çŠ¶æ€ |
|------|----------|:----:|
| APIæ–‡æ¡£ | æ–°å¢é¢„è­¦ç«¯ç‚¹è¯´æ˜ | â¬œ |
| ç”¨æˆ·æ‰‹å†Œ | æ–°åŠŸèƒ½ä½¿ç”¨è¯´æ˜ | â¬œ |
| éƒ¨ç½²æ–‡æ¡£ | é‚®ä»¶æœåŠ¡é…ç½® | â¬œ |

---

### Task 4.5: ä»£ç å®¡æŸ¥

- [ ] ä»£ç é£æ ¼ä¸€è‡´æ€§
- [ ] é”™è¯¯å¤„ç†å®Œæ•´æ€§
- [ ] ç±»å‹å®šä¹‰å‡†ç¡®æ€§
- [ ] å®‰å…¨æ€§æ£€æŸ¥
- [ ] æ€§èƒ½è€ƒè™‘

---

## Part B: ç­–ç•¥æ¼‚ç§»ç›‘æ§ (3å¤©) ğŸ†•

### Task 4.6: æ¼‚ç§»ç›‘æ§Schema (åç«¯)

**æ–‡ä»¶**: `backend/app/schemas/drift.py`

```python
from pydantic import BaseModel
from typing import Optional, Literal
from datetime import datetime, date
from enum import Enum

class DriftMetricType(str, Enum):
    """æ¼‚ç§»æŒ‡æ ‡ç±»å‹"""
    RETURN = "return"           # æ”¶ç›Šå·®å¼‚
    WIN_RATE = "win_rate"       # èƒœç‡å·®å¼‚
    TURNOVER = "turnover"       # æ¢æ‰‹ç‡å·®å¼‚
    SLIPPAGE = "slippage"       # æ»‘ç‚¹å·®å¼‚
    MAX_DRAWDOWN = "max_drawdown"  # æœ€å¤§å›æ’¤å·®å¼‚
    HOLD_PERIOD = "hold_period"    # æŒä»“æ—¶é—´å·®å¼‚

class DriftSeverity(str, Enum):
    """æ¼‚ç§»ä¸¥é‡ç¨‹åº¦"""
    NORMAL = "normal"      # æ­£å¸¸èŒƒå›´
    WARNING = "warning"    # é»„è‰²é¢„è­¦
    CRITICAL = "critical"  # çº¢è‰²ä¸¥é‡

class DriftMetric(BaseModel):
    """å•ä¸ªæ¼‚ç§»æŒ‡æ ‡"""
    metric_type: DriftMetricType
    backtest_value: float      # å›æµ‹å€¼
    live_value: float          # å®ç›˜å€¼
    difference: float          # å·®å¼‚ (ç»å¯¹å€¼)
    difference_pct: float      # å·®å¼‚ç™¾åˆ†æ¯”
    warning_threshold: float   # é»„è‰²é¢„è­¦é˜ˆå€¼
    critical_threshold: float  # çº¢è‰²ä¸¥é‡é˜ˆå€¼
    severity: DriftSeverity
    description: str

class StrategyDriftReport(BaseModel):
    """ç­–ç•¥æ¼‚ç§»æŠ¥å‘Š"""
    report_id: str
    strategy_id: str
    strategy_name: str
    deployment_id: str
    environment: Literal["paper", "live"]
    
    # æ—¶é—´èŒƒå›´
    period_start: date
    period_end: date
    days_compared: int
    
    # æ•´ä½“çŠ¶æ€
    overall_severity: DriftSeverity
    drift_score: float  # 0-100, è¶Šé«˜è¶Šåç¦»
    
    # å„æŒ‡æ ‡è¯¦æƒ…
    metrics: list[DriftMetric]
    
    # å»ºè®®
    recommendations: list[str]
    should_pause: bool  # æ˜¯å¦å»ºè®®æš‚åœç­–ç•¥
    
    # å…ƒæ•°æ®
    created_at: datetime
    is_acknowledged: bool = False  # ç”¨æˆ·æ˜¯å¦å·²ç¡®è®¤

class DriftThresholds(BaseModel):
    """æ¼‚ç§»é˜ˆå€¼é…ç½® (PRD é™„å½•C)"""
    # é»„è‰²é¢„è­¦é˜ˆå€¼
    return_warning: float = 0.10       # æ”¶ç›Šå·®å¼‚ > 10%
    win_rate_warning: float = 0.05     # èƒœç‡å·®å¼‚ > 5%
    turnover_warning: float = 0.20     # æ¢æ‰‹ç‡å·®å¼‚ > 20%
    slippage_warning: float = 0.30     # æ»‘ç‚¹å·®å¼‚ > 30%
    max_drawdown_warning: float = 0.15 # æœ€å¤§å›æ’¤å·®å¼‚ > 15%
    hold_period_warning: float = 0.25  # æŒä»“æ—¶é—´å·®å¼‚ > 25%
    
    # çº¢è‰²ä¸¥é‡é˜ˆå€¼
    return_critical: float = 0.20      # æ”¶ç›Šå·®å¼‚ > 20%
    win_rate_critical: float = 0.10    # èƒœç‡å·®å¼‚ > 10%
    turnover_critical: float = 0.35    # æ¢æ‰‹ç‡å·®å¼‚ > 35%
    slippage_critical: float = 0.50    # æ»‘ç‚¹å·®å¼‚ > 50%
    max_drawdown_critical: float = 0.25 # æœ€å¤§å›æ’¤å·®å¼‚ > 25%
    hold_period_critical: float = 0.40  # æŒä»“æ—¶é—´å·®å¼‚ > 40%

class DriftCheckRequest(BaseModel):
    """æ¼‚ç§»æ£€æŸ¥è¯·æ±‚"""
    strategy_id: str
    deployment_id: str
    period_days: int = 30  # é»˜è®¤æ¯”è¾ƒæœ€è¿‘30å¤©
```

---

### Task 4.7: æ¼‚ç§»ç›‘æ§æœåŠ¡ (åç«¯)

**æ–‡ä»¶**: `backend/app/services/drift_service.py`

```python
from datetime import datetime, date, timedelta
from typing import Optional
from app.schemas.drift import (
    StrategyDriftReport, DriftMetric, DriftMetricType,
    DriftSeverity, DriftThresholds
)
from app.services.alert_service import AlertService
from app.schemas.alert import AlertType, AlertSeverity
import uuid

class StrategyDriftService:
    """ç­–ç•¥æ¼‚ç§»ç›‘æ§æœåŠ¡"""
    
    # PRD é™„å½•C å®šä¹‰çš„é˜ˆå€¼
    DEFAULT_THRESHOLDS = DriftThresholds()
    
    def __init__(self, db_session, alert_service: AlertService):
        self.db = db_session
        self.alert_service = alert_service
    
    async def check_drift(
        self,
        strategy_id: str,
        deployment_id: str,
        period_days: int = 30
    ) -> StrategyDriftReport:
        """æ£€æŸ¥ç­–ç•¥æ¼‚ç§»"""
        
        # 1. è·å–å›æµ‹æ•°æ®
        backtest_stats = await self._get_backtest_stats(strategy_id)
        
        # 2. è·å–å®ç›˜/æ¨¡æ‹Ÿç›˜æ•°æ®
        live_stats = await self._get_live_stats(deployment_id, period_days)
        
        # 3. è®¡ç®—å„æŒ‡æ ‡æ¼‚ç§»
        metrics = self._calculate_drift_metrics(backtest_stats, live_stats)
        
        # 4. è®¡ç®—æ•´ä½“æ¼‚ç§»è¯„åˆ†
        overall_severity, drift_score = self._calculate_overall_drift(metrics)
        
        # 5. ç”Ÿæˆå»ºè®®
        recommendations, should_pause = self._generate_recommendations(
            metrics, overall_severity
        )
        
        # 6. åˆ›å»ºæŠ¥å‘Š
        report = StrategyDriftReport(
            report_id=str(uuid.uuid4()),
            strategy_id=strategy_id,
            strategy_name=await self._get_strategy_name(strategy_id),
            deployment_id=deployment_id,
            environment=live_stats.environment,
            period_start=date.today() - timedelta(days=period_days),
            period_end=date.today(),
            days_compared=period_days,
            overall_severity=overall_severity,
            drift_score=drift_score,
            metrics=metrics,
            recommendations=recommendations,
            should_pause=should_pause,
            created_at=datetime.now()
        )
        
        # 7. ä¿å­˜æŠ¥å‘Š
        await self._save_report(report)
        
        # 8. è§¦å‘é¢„è­¦ (å¦‚æœä¸¥é‡)
        if overall_severity in [DriftSeverity.WARNING, DriftSeverity.CRITICAL]:
            await self._trigger_drift_alert(report)
        
        return report
    
    def _calculate_drift_metrics(
        self,
        backtest: dict,
        live: dict
    ) -> list[DriftMetric]:
        """è®¡ç®—å„æŒ‡æ ‡æ¼‚ç§»"""
        
        thresholds = self.DEFAULT_THRESHOLDS
        metrics = []
        
        # å®šä¹‰æŒ‡æ ‡æ˜ å°„
        metric_configs = [
            (DriftMetricType.RETURN, "total_return", "æ”¶ç›Šç‡",
             thresholds.return_warning, thresholds.return_critical),
            (DriftMetricType.WIN_RATE, "win_rate", "èƒœç‡",
             thresholds.win_rate_warning, thresholds.win_rate_critical),
            (DriftMetricType.TURNOVER, "turnover_rate", "æ¢æ‰‹ç‡",
             thresholds.turnover_warning, thresholds.turnover_critical),
            (DriftMetricType.SLIPPAGE, "avg_slippage", "å¹³å‡æ»‘ç‚¹",
             thresholds.slippage_warning, thresholds.slippage_critical),
            (DriftMetricType.MAX_DRAWDOWN, "max_drawdown", "æœ€å¤§å›æ’¤",
             thresholds.max_drawdown_warning, thresholds.max_drawdown_critical),
            (DriftMetricType.HOLD_PERIOD, "avg_hold_days", "å¹³å‡æŒä»“å¤©æ•°",
             thresholds.hold_period_warning, thresholds.hold_period_critical),
        ]
        
        for metric_type, key, name, warn_thresh, crit_thresh in metric_configs:
            bt_value = backtest.get(key, 0)
            live_value = live.get(key, 0)
            
            # è®¡ç®—å·®å¼‚
            if bt_value != 0:
                diff_pct = abs(live_value - bt_value) / abs(bt_value)
            else:
                diff_pct = 0 if live_value == 0 else 1.0
            
            # åˆ¤æ–­ä¸¥é‡ç¨‹åº¦
            if diff_pct >= crit_thresh:
                severity = DriftSeverity.CRITICAL
            elif diff_pct >= warn_thresh:
                severity = DriftSeverity.WARNING
            else:
                severity = DriftSeverity.NORMAL
            
            # ç”Ÿæˆæè¿°
            description = self._generate_metric_description(
                name, bt_value, live_value, diff_pct, severity
            )
            
            metrics.append(DriftMetric(
                metric_type=metric_type,
                backtest_value=bt_value,
                live_value=live_value,
                difference=abs(live_value - bt_value),
                difference_pct=diff_pct,
                warning_threshold=warn_thresh,
                critical_threshold=crit_thresh,
                severity=severity,
                description=description
            ))
        
        return metrics
    
    def _calculate_overall_drift(
        self,
        metrics: list[DriftMetric]
    ) -> tuple[DriftSeverity, float]:
        """è®¡ç®—æ•´ä½“æ¼‚ç§»ç¨‹åº¦"""
        
        # ç»Ÿè®¡å„çº§åˆ«æ•°é‡
        critical_count = sum(1 for m in metrics if m.severity == DriftSeverity.CRITICAL)
        warning_count = sum(1 for m in metrics if m.severity == DriftSeverity.WARNING)
        
        # è®¡ç®—æ¼‚ç§»è¯„åˆ† (0-100)
        # æƒé‡: æ”¶ç›Šæœ€é‡è¦, å…¶æ¬¡æ˜¯èƒœç‡å’Œå›æ’¤
        weights = {
            DriftMetricType.RETURN: 0.30,
            DriftMetricType.WIN_RATE: 0.20,
            DriftMetricType.MAX_DRAWDOWN: 0.20,
            DriftMetricType.TURNOVER: 0.10,
            DriftMetricType.SLIPPAGE: 0.10,
            DriftMetricType.HOLD_PERIOD: 0.10,
        }
        
        drift_score = 0
        for metric in metrics:
            weight = weights.get(metric.metric_type, 0.1)
            # ç›¸å¯¹äºcriticalé˜ˆå€¼çš„æ¯”ä¾‹
            relative = metric.difference_pct / metric.critical_threshold
            drift_score += min(relative, 2.0) * weight * 50  # æœ€é«˜100åˆ†
        
        # ç¡®å®šæ•´ä½“ä¸¥é‡ç¨‹åº¦
        if critical_count >= 2 or drift_score >= 70:
            overall = DriftSeverity.CRITICAL
        elif critical_count >= 1 or warning_count >= 3 or drift_score >= 40:
            overall = DriftSeverity.WARNING
        else:
            overall = DriftSeverity.NORMAL
        
        return overall, min(drift_score, 100)
    
    def _generate_recommendations(
        self,
        metrics: list[DriftMetric],
        overall: DriftSeverity
    ) -> tuple[list[str], bool]:
        """ç”Ÿæˆå»ºè®®"""
        
        recommendations = []
        should_pause = False
        
        for metric in metrics:
            if metric.severity == DriftSeverity.CRITICAL:
                if metric.metric_type == DriftMetricType.RETURN:
                    recommendations.append(
                        "æ”¶ç›Šå·®å¼‚ä¸¥é‡ï¼Œå»ºè®®æ£€æŸ¥å› å­æœ‰æ•ˆæ€§æ˜¯å¦å‘ç”Ÿå˜åŒ–"
                    )
                elif metric.metric_type == DriftMetricType.SLIPPAGE:
                    recommendations.append(
                        "æ»‘ç‚¹å·®å¼‚è¿‡å¤§ï¼Œè€ƒè™‘è°ƒæ•´äº¤æ˜“é¢‘ç‡æˆ–é€‰æ‹©æµåŠ¨æ€§æ›´å¥½çš„è‚¡ç¥¨"
                    )
                elif metric.metric_type == DriftMetricType.MAX_DRAWDOWN:
                    recommendations.append(
                        "å®ç›˜å›æ’¤æ˜¾è‘—é«˜äºå›æµ‹ï¼Œå»ºè®®æ£€æŸ¥é£æ§å‚æ•°æ˜¯å¦åˆç†"
                    )
        
        if overall == DriftSeverity.CRITICAL:
            recommendations.insert(0, "âš ï¸ ç­–ç•¥å®ç›˜è¡¨ç°ä¸å›æµ‹å·®å¼‚è¿‡å¤§ï¼Œå¼ºçƒˆå»ºè®®æš‚åœç­–ç•¥å¹¶è¿›è¡Œæ·±å…¥åˆ†æ")
            should_pause = True
        elif overall == DriftSeverity.WARNING:
            recommendations.insert(0, "ç­–ç•¥å‡ºç°æ¼‚ç§»è¿¹è±¡ï¼Œå»ºè®®å¯†åˆ‡å…³æ³¨å¹¶è€ƒè™‘è°ƒæ•´")
        
        if not recommendations:
            recommendations.append("ç­–ç•¥è¿è¡Œæ­£å¸¸ï¼Œå®ç›˜è¡¨ç°ä¸å›æµ‹åŸºæœ¬ä¸€è‡´")
        
        return recommendations, should_pause
    
    def _generate_metric_description(
        self,
        name: str,
        bt_value: float,
        live_value: float,
        diff_pct: float,
        severity: DriftSeverity
    ) -> str:
        """ç”ŸæˆæŒ‡æ ‡æè¿°"""
        
        direction = "é«˜äº" if live_value > bt_value else "ä½äº"
        
        # æ ¼å¼åŒ–æ•°å€¼
        if name in ["æ”¶ç›Šç‡", "èƒœç‡", "æ¢æ‰‹ç‡", "æœ€å¤§å›æ’¤", "å¹³å‡æ»‘ç‚¹"]:
            bt_str = f"{bt_value*100:.1f}%"
            live_str = f"{live_value*100:.1f}%"
        else:
            bt_str = f"{bt_value:.1f}"
            live_str = f"{live_value:.1f}"
        
        status = {
            DriftSeverity.NORMAL: "æ­£å¸¸",
            DriftSeverity.WARNING: "éœ€å…³æ³¨",
            DriftSeverity.CRITICAL: "å¼‚å¸¸"
        }[severity]
        
        return f"{name}: å®ç›˜{live_str} {direction}å›æµ‹{bt_str}, å·®å¼‚{diff_pct*100:.1f}% [{status}]"
    
    async def _trigger_drift_alert(self, report: StrategyDriftReport):
        """è§¦å‘æ¼‚ç§»é¢„è­¦"""
        
        severity = AlertSeverity.CRITICAL if report.overall_severity == DriftSeverity.CRITICAL else AlertSeverity.WARNING
        
        title = f"ç­–ç•¥æ¼‚ç§»é¢„è­¦: {report.strategy_name}"
        message = f"ç­–ç•¥'{report.strategy_name}'å®ç›˜è¡¨ç°ä¸å›æµ‹å·®å¼‚è¾¾åˆ°{report.drift_score:.0f}åˆ†ã€‚\n"
        message += "\n".join(report.recommendations[:3])
        
        await self.alert_service.create_manual_alert(
            user_id=await self._get_strategy_owner(report.strategy_id),
            alert_type=AlertType.SYSTEM_ERROR,  # ä½¿ç”¨ç³»ç»Ÿé¢„è­¦ç±»å‹
            severity=severity,
            title=title,
            message=message,
            strategy_id=report.strategy_id,
            details={
                "drift_score": report.drift_score,
                "period_days": report.days_compared,
                "should_pause": report.should_pause,
                "report_id": report.report_id
            }
        )
    
    async def get_drift_history(
        self,
        strategy_id: str,
        limit: int = 10
    ) -> list[StrategyDriftReport]:
        """è·å–æ¼‚ç§»å†å²æŠ¥å‘Š"""
        # æ•°æ®åº“æŸ¥è¯¢å®ç°
        pass
    
    async def acknowledge_report(
        self,
        report_id: str,
        user_id: str
    ) -> bool:
        """ç¡®è®¤æ¼‚ç§»æŠ¥å‘Š"""
        # æ ‡è®°ä¸ºå·²ç¡®è®¤
        pass
```

---

### Task 4.8: æ¼‚ç§»ç›‘æ§API (åç«¯)

**æ–‡ä»¶**: `backend/app/api/v1/drift.py`

```python
from fastapi import APIRouter, Depends, HTTPException, Query, BackgroundTasks
from typing import Optional
from app.services.drift_service import StrategyDriftService
from app.schemas.drift import (
    StrategyDriftReport, DriftCheckRequest, DriftThresholds
)
from app.core.deps import get_current_user, get_drift_service

router = APIRouter(prefix="/drift", tags=["Drift Monitoring"])

@router.post("/check", response_model=StrategyDriftReport)
async def check_strategy_drift(
    request: DriftCheckRequest,
    current_user = Depends(get_current_user),
    drift_service: StrategyDriftService = Depends(get_drift_service)
):
    """æ£€æŸ¥ç­–ç•¥æ¼‚ç§»"""
    
    # éªŒè¯ç”¨æˆ·å¯¹ç­–ç•¥çš„è®¿é—®æƒé™
    # ...
    
    return await drift_service.check_drift(
        strategy_id=request.strategy_id,
        deployment_id=request.deployment_id,
        period_days=request.period_days
    )

@router.get("/reports/{strategy_id}", response_model=list[StrategyDriftReport])
async def get_drift_reports(
    strategy_id: str,
    limit: int = Query(10, le=50),
    current_user = Depends(get_current_user),
    drift_service: StrategyDriftService = Depends(get_drift_service)
):
    """è·å–ç­–ç•¥çš„æ¼‚ç§»æŠ¥å‘Šå†å²"""
    return await drift_service.get_drift_history(strategy_id, limit)

@router.get("/reports/{strategy_id}/latest", response_model=Optional[StrategyDriftReport])
async def get_latest_drift_report(
    strategy_id: str,
    current_user = Depends(get_current_user),
    drift_service: StrategyDriftService = Depends(get_drift_service)
):
    """è·å–ç­–ç•¥æœ€æ–°çš„æ¼‚ç§»æŠ¥å‘Š"""
    reports = await drift_service.get_drift_history(strategy_id, limit=1)
    return reports[0] if reports else None

@router.post("/reports/{report_id}/acknowledge")
async def acknowledge_drift_report(
    report_id: str,
    current_user = Depends(get_current_user),
    drift_service: StrategyDriftService = Depends(get_drift_service)
):
    """ç¡®è®¤æ¼‚ç§»æŠ¥å‘Š (è¡¨ç¤ºå·²é˜…è¯»å¹¶é‡‡å–æªæ–½)"""
    success = await drift_service.acknowledge_report(report_id, current_user.id)
    if not success:
        raise HTTPException(404, "æŠ¥å‘Šä¸å­˜åœ¨")
    return {"success": True}

@router.get("/thresholds", response_model=DriftThresholds)
async def get_drift_thresholds():
    """è·å–æ¼‚ç§»ç›‘æ§é˜ˆå€¼é…ç½®"""
    return DriftThresholds()

@router.post("/schedule-check")
async def schedule_drift_check(
    strategy_id: str,
    background_tasks: BackgroundTasks,
    current_user = Depends(get_current_user),
    drift_service: StrategyDriftService = Depends(get_drift_service)
):
    """å®‰æ’åå°æ¼‚ç§»æ£€æŸ¥"""
    # å°†ä»»åŠ¡æ·»åŠ åˆ°åå°é˜Ÿåˆ—
    background_tasks.add_task(
        drift_service.check_all_deployments,
        strategy_id
    )
    return {"success": True, "message": "æ¼‚ç§»æ£€æŸ¥å·²å®‰æ’"}
```

**ç«¯ç‚¹**:
```
POST /api/v1/drift/check                    - ç«‹å³æ£€æŸ¥ç­–ç•¥æ¼‚ç§»
GET  /api/v1/drift/reports/{strategyId}     - è·å–æ¼‚ç§»æŠ¥å‘Šå†å²
GET  /api/v1/drift/reports/{strategyId}/latest - è·å–æœ€æ–°æ¼‚ç§»æŠ¥å‘Š
POST /api/v1/drift/reports/{reportId}/acknowledge - ç¡®è®¤æŠ¥å‘Š
GET  /api/v1/drift/thresholds               - è·å–é˜ˆå€¼é…ç½®
POST /api/v1/drift/schedule-check           - å®‰æ’åå°æ£€æŸ¥
```

---

### Task 4.9: æ¼‚ç§»ç›‘æ§å‰ç«¯ç±»å‹

**æ–‡ä»¶**: `frontend/src/types/drift.ts`

```typescript
export type DriftMetricType = 
  | 'return'
  | 'win_rate'
  | 'turnover'
  | 'slippage'
  | 'max_drawdown'
  | 'hold_period';

export type DriftSeverity = 'normal' | 'warning' | 'critical';

export interface DriftMetric {
  metricType: DriftMetricType;
  backtestValue: number;
  liveValue: number;
  difference: number;
  differencePct: number;
  warningThreshold: number;
  criticalThreshold: number;
  severity: DriftSeverity;
  description: string;
}

export interface StrategyDriftReport {
  reportId: string;
  strategyId: string;
  strategyName: string;
  deploymentId: string;
  environment: 'paper' | 'live';
  periodStart: string;
  periodEnd: string;
  daysCompared: number;
  overallSeverity: DriftSeverity;
  driftScore: number;
  metrics: DriftMetric[];
  recommendations: string[];
  shouldPause: boolean;
  createdAt: string;
  isAcknowledged: boolean;
}

export const DRIFT_METRIC_LABELS: Record<DriftMetricType, string> = {
  return: 'æ”¶ç›Šç‡',
  win_rate: 'èƒœç‡',
  turnover: 'æ¢æ‰‹ç‡',
  slippage: 'æ»‘ç‚¹',
  max_drawdown: 'æœ€å¤§å›æ’¤',
  hold_period: 'æŒä»“æ—¶é—´',
};

export const DRIFT_SEVERITY_CONFIG = {
  normal: { icon: 'âœ…', color: '#22c55e', text: 'æ­£å¸¸' },
  warning: { icon: 'âš ï¸', color: '#eab308', text: 'éœ€å…³æ³¨' },
  critical: { icon: 'ğŸ”´', color: '#ef4444', text: 'å¼‚å¸¸' },
};
```

---

### Task 4.10: æ¼‚ç§»ç›‘æ§ç»„ä»¶

**æ–‡ä»¶**: `frontend/src/components/Drift/DriftReportPanel.tsx`

```tsx
import React from 'react';
import {
  StrategyDriftReport,
  DriftMetric,
  DRIFT_METRIC_LABELS,
  DRIFT_SEVERITY_CONFIG
} from '@/types/drift';

interface Props {
  report: StrategyDriftReport;
  onAcknowledge?: () => void;
  onPauseStrategy?: () => void;
}

export const DriftReportPanel: React.FC<Props> = ({
  report,
  onAcknowledge,
  onPauseStrategy
}) => {
  const severityConfig = DRIFT_SEVERITY_CONFIG[report.overallSeverity];
  
  return (
    <div className="drift-report-panel">
      {/* å¤´éƒ¨ */}
      <div className="drift-header" style={{ borderColor: severityConfig.color }}>
        <div className="drift-title">
          <span className="drift-icon">{severityConfig.icon}</span>
          <h3>ç­–ç•¥æ¼‚ç§»æŠ¥å‘Š</h3>
          <span 
            className="drift-severity-badge"
            style={{ backgroundColor: severityConfig.color }}
          >
            {severityConfig.text}
          </span>
        </div>
        <div className="drift-meta">
          <span>ç­–ç•¥: {report.strategyName}</span>
          <span>ç¯å¢ƒ: {report.environment === 'live' ? 'å®ç›˜' : 'æ¨¡æ‹Ÿç›˜'}</span>
          <span>åˆ†æå‘¨æœŸ: {report.daysCompared}å¤©</span>
        </div>
      </div>
      
      {/* æ¼‚ç§»è¯„åˆ† */}
      <div className="drift-score-section">
        <div className="drift-score">
          <div className="score-value">{report.driftScore.toFixed(0)}</div>
          <div className="score-label">æ¼‚ç§»è¯„åˆ†</div>
        </div>
        <div className="drift-score-bar">
          <div 
            className="drift-score-fill"
            style={{ 
              width: `${report.driftScore}%`,
              backgroundColor: severityConfig.color
            }}
          />
        </div>
        <div className="drift-score-scale">
          <span>0 æ­£å¸¸</span>
          <span>40 å…³æ³¨</span>
          <span>70 å¼‚å¸¸</span>
          <span>100</span>
        </div>
      </div>
      
      {/* æŒ‡æ ‡è¯¦æƒ… */}
      <div className="drift-metrics">
        <h4>æŒ‡æ ‡å¯¹æ¯”</h4>
        <table className="drift-metrics-table">
          <thead>
            <tr>
              <th>æŒ‡æ ‡</th>
              <th>å›æµ‹</th>
              <th>å®ç›˜</th>
              <th>å·®å¼‚</th>
              <th>çŠ¶æ€</th>
            </tr>
          </thead>
          <tbody>
            {report.metrics.map(metric => (
              <DriftMetricRow key={metric.metricType} metric={metric} />
            ))}
          </tbody>
        </table>
      </div>
      
      {/* å»ºè®® */}
      <div className="drift-recommendations">
        <h4>å»ºè®®</h4>
        <ul>
          {report.recommendations.map((rec, i) => (
            <li key={i}>{rec}</li>
          ))}
        </ul>
      </div>
      
      {/* æ“ä½œæŒ‰é’® */}
      <div className="drift-actions">
        {report.shouldPause && onPauseStrategy && (
          <button 
            className="btn btn-danger"
            onClick={onPauseStrategy}
          >
            æš‚åœç­–ç•¥
          </button>
        )}
        {!report.isAcknowledged && onAcknowledge && (
          <button 
            className="btn btn-secondary"
            onClick={onAcknowledge}
          >
            æˆ‘å·²çŸ¥æ™“
          </button>
        )}
      </div>
    </div>
  );
};

const DriftMetricRow: React.FC<{ metric: DriftMetric }> = ({ metric }) => {
  const config = DRIFT_SEVERITY_CONFIG[metric.severity];
  
  const formatValue = (value: number, type: string) => {
    if (['return', 'win_rate', 'turnover', 'max_drawdown', 'slippage'].includes(type)) {
      return `${(value * 100).toFixed(1)}%`;
    }
    return value.toFixed(1);
  };
  
  return (
    <tr className={`drift-row drift-row-${metric.severity}`}>
      <td>{DRIFT_METRIC_LABELS[metric.metricType]}</td>
      <td>{formatValue(metric.backtestValue, metric.metricType)}</td>
      <td>{formatValue(metric.liveValue, metric.metricType)}</td>
      <td>{(metric.differencePct * 100).toFixed(1)}%</td>
      <td>
        <span 
          className="drift-status"
          style={{ color: config.color }}
        >
          {config.icon} {config.text}
        </span>
      </td>
    </tr>
  );
};
```

**æ–‡ä»¶**: `frontend/src/components/Drift/DriftIndicator.tsx`

```tsx
import React from 'react';
import { DriftSeverity, DRIFT_SEVERITY_CONFIG } from '@/types/drift';

interface Props {
  severity: DriftSeverity;
  score: number;
  onClick?: () => void;
}

export const DriftIndicator: React.FC<Props> = ({ severity, score, onClick }) => {
  const config = DRIFT_SEVERITY_CONFIG[severity];
  
  if (severity === 'normal') {
    return null; // æ­£å¸¸æ—¶ä¸æ˜¾ç¤º
  }
  
  return (
    <div 
      className="drift-indicator"
      style={{ backgroundColor: config.color }}
      onClick={onClick}
      title={`æ¼‚ç§»è¯„åˆ†: ${score.toFixed(0)}`}
    >
      {config.icon} æ¼‚ç§»{config.text}
    </div>
  );
};
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ¼‚ç§»æŠ¥å‘Šé¢æ¿æ˜¾ç¤ºæ­£ç¡®
- [ ] å„æŒ‡æ ‡å¯¹æ¯”æ¸…æ™°
- [ ] ä¸¥é‡ç¨‹åº¦é¢œè‰²åŒºåˆ†æ˜ç¡®
- [ ] å»ºè®®ä¿¡æ¯æœ‰ç”¨

---

### Task 4.11: ç­–ç•¥å¡ç‰‡é›†æˆæ¼‚ç§»æŒ‡ç¤ºå™¨

**ä¿®æ”¹æ–‡ä»¶**: `frontend/src/components/Strategy/StrategyCard.tsx`

```tsx
// åœ¨ç­–ç•¥å¡ç‰‡ä¸­æ·»åŠ æ¼‚ç§»æŒ‡ç¤ºå™¨
<div className="strategy-card">
  <div className="strategy-header">
    <h3>{strategy.name}</h3>
    <StrategyStatusBadge status={strategy.status} />
    {latestDriftReport && (
      <DriftIndicator 
        severity={latestDriftReport.overallSeverity}
        score={latestDriftReport.driftScore}
        onClick={() => setShowDriftReport(true)}
      />
    )}
  </div>
  {/* ... å…¶ä»–å†…å®¹ */}
</div>
```

---

## Sprint 4 å®Œæˆæ£€æŸ¥æ¸…å•

### Part A: æ•´åˆæµ‹è¯•
- [ ] åœºæ™¯1: ç­–ç•¥åˆ›å»ºåˆ°éƒ¨ç½² âœ“
- [ ] åœºæ™¯2: æ¨¡æ‹Ÿç›˜åˆ°å®ç›˜åˆ‡æ¢ âœ“
- [ ] åœºæ™¯3: ä¿¡å·é›·è¾¾ç›‘æ§ âœ“
- [ ] åœºæ™¯4: PDTè§„åˆ™éªŒè¯ âœ“
- [ ] åœºæ™¯5: AIè¿æ¥çŠ¶æ€ âœ“
- [ ] åœºæ™¯6: é£é™©é¢„è­¦è§¦å‘ âœ“

### Part B: ç­–ç•¥æ¼‚ç§»ç›‘æ§ ğŸ†•
- [ ] drift.py Schemaå®Œæ•´
- [ ] drift_service.py æœåŠ¡å®Œæ•´
- [ ] drift.py APIå¯è°ƒç”¨
- [ ] drift.ts ç±»å‹å®šä¹‰å®Œæ•´
- [ ] DriftReportPanel.tsx æŠ¥å‘Šé¢æ¿æ­£å¸¸
- [ ] DriftIndicator.tsx æŒ‡ç¤ºå™¨æ­£å¸¸
- [ ] ç­–ç•¥å¡ç‰‡é›†æˆæŒ‡ç¤ºå™¨

### Bugä¿®å¤
- [ ] é«˜ä¼˜å…ˆçº§Bugå…¨éƒ¨ä¿®å¤
- [ ] ä¸­ä¼˜å…ˆçº§Bugå¤§éƒ¨åˆ†ä¿®å¤

### å…¶ä»–
- [ ] æ€§èƒ½ä¼˜åŒ–å®Œæˆ
- [ ] æ–‡æ¡£å·²æ›´æ–°
- [ ] ä»£ç å·²å®¡æŸ¥

---

## Phase 1 å‘å¸ƒæ£€æŸ¥

| åŠŸèƒ½ | Sprint | çŠ¶æ€ |
|------|:------:|:----:|
| æˆ‘çš„ç­–ç•¥åˆ—è¡¨ | 1 | â¬œ |
| 4æ­¥éƒ¨ç½²å‘å¯¼ | 1 | â¬œ |
| ä¿¡å·é›·è¾¾é¢æ¿ | 2 | â¬œ |
| ç¯å¢ƒåˆ‡æ¢å™¨ | 2 | â¬œ |
| PDTçŠ¶æ€ç®¡ç† | 3 | â¬œ |
| AIè¿æ¥çŠ¶æ€ | 3 | â¬œ |
| é£é™©é¢„è­¦é€šçŸ¥ | 3 | â¬œ |
| ç­–ç•¥æ¼‚ç§»ç›‘æ§ | 4 | â¬œ |

---

## æ–°å¢APIç«¯ç‚¹

```
# æ¼‚ç§»ç›‘æ§ ğŸ†•
POST /api/v1/drift/check                      - ç«‹å³æ£€æŸ¥ç­–ç•¥æ¼‚ç§»
GET  /api/v1/drift/reports/{strategyId}       - è·å–æ¼‚ç§»æŠ¥å‘Šå†å²
GET  /api/v1/drift/reports/{strategyId}/latest - è·å–æœ€æ–°æ¼‚ç§»æŠ¥å‘Š
POST /api/v1/drift/reports/{reportId}/acknowledge - ç¡®è®¤æŠ¥å‘Š
GET  /api/v1/drift/thresholds                 - è·å–é˜ˆå€¼é…ç½®
POST /api/v1/drift/schedule-check             - å®‰æ’åå°æ£€æŸ¥
```

---

## æ–°å¢æ–‡ä»¶æ¸…å•

### åç«¯
```
backend/app/
â”œâ”€â”€ schemas/
â”‚   â””â”€â”€ drift.py           ğŸ†•
â”œâ”€â”€ services/
â”‚   â””â”€â”€ drift_service.py   ğŸ†•
â””â”€â”€ api/v1/
    â””â”€â”€ drift.py           ğŸ†•
```

### å‰ç«¯
```
frontend/src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ drift.ts           ğŸ†•
â””â”€â”€ components/
    â””â”€â”€ Drift/             ğŸ†•
        â”œâ”€â”€ DriftReportPanel.tsx
        â””â”€â”€ DriftIndicator.tsx
```

---

## ä¸‹ä¸€æ­¥

å®Œæˆåè¿›å…¥ **Sprint 5: å› å­+å½’å› +å†²çª**

---

**é¢„è®¡å®Œæˆæ—¶é—´**: 6å¤© (åŸ3å¤© + æ–°å¢3å¤©)
