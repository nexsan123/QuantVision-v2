# Phase 12: æ‰§è¡Œå±‚å‡çº§ - å®æ–½æŠ¥å‘Š

## 1. æ¦‚è¿°

Phase 12 å®ç°äº†å®Œæ•´çš„æ‰§è¡Œå±‚å‡çº§ï¼ŒåŒ…æ‹¬ï¼š
- **åˆ¸å•†APIå¯¹æ¥**ï¼šAlpacaï¼ˆé¦–é€‰ï¼‰+ Paper Trading
- **Almgren-Chriss æ»‘ç‚¹æ¨¡å‹**ï¼šç²¾ç¡®çš„å¸‚åœºå†²å‡»æ¨¡å‹
- **è®¢å•ç®¡ç†ç³»ç»Ÿ**ï¼šç»Ÿä¸€çš„è®¢å•ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **äº¤æ˜“ç›‘æ§UI**ï¼šå®æ—¶äº¤æ˜“çŠ¶æ€å’ŒæŒä»“ç›‘æ§

---

## 2. æŠ€æœ¯æ¶æ„

### 2.1 åˆ¸å•†å¯¹æ¥æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åˆ¸å•†å¯¹æ¥æ¶æ„                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      BrokerInterface                             â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  + get_account() â†’ BrokerAccount                                â”‚   â”‚
â”‚  â”‚  + get_positions() â†’ BrokerPosition[]                           â”‚   â”‚
â”‚  â”‚  + submit_order(order) â†’ OrderResponse                          â”‚   â”‚
â”‚  â”‚  + cancel_order(order_id) â†’ bool                                â”‚   â”‚
â”‚  â”‚  + get_order(order_id) â†’ OrderResponse                          â”‚   â”‚
â”‚  â”‚  + get_orders(status, limit) â†’ OrderResponse[]                  â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â–²           â–²                                    â”‚
â”‚                        â”‚           â”‚                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚              â”‚AlpacaBroker â”‚ â”‚  PaperBroker  â”‚                         â”‚
â”‚              â”‚             â”‚ â”‚               â”‚                         â”‚
â”‚              â”‚ â€¢ REST API  â”‚ â”‚ â€¢ æœ¬åœ°æ¨¡æ‹Ÿ    â”‚                         â”‚
â”‚              â”‚ â€¢ 0 ä½£é‡‘    â”‚ â”‚ â€¢ æ— éœ€é…ç½®    â”‚                         â”‚
â”‚              â”‚ â€¢ Paperæ”¯æŒ â”‚ â”‚ â€¢ å³æ—¶æˆäº¤    â”‚                         â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                         â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                      â”‚  BrokerManager   â”‚                              â”‚
â”‚                      â”‚                  â”‚                              â”‚
â”‚                      â”‚ â€¢ å¤šåˆ¸å•†ç®¡ç†     â”‚                              â”‚
â”‚                      â”‚ â€¢ è‡ªåŠ¨æ•…éšœè½¬ç§»   â”‚                              â”‚
â”‚                      â”‚ â€¢ ç»Ÿä¸€æ¥å£       â”‚                              â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ–‡ä»¶ç»“æ„

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â””â”€â”€ trading.py              # Pydantic æ¨¡å‹ (~350 è¡Œ)
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ broker_service.py       # åˆ¸å•†æœåŠ¡ (~550 è¡Œ)
â”‚   â”‚   â””â”€â”€ slippage_model.py       # æ»‘ç‚¹æ¨¡å‹ (~450 è¡Œ)
â”‚   â””â”€â”€ api/v1/
â”‚       â””â”€â”€ trading.py              # API ç«¯ç‚¹ (~350 è¡Œ)

frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ trading.ts              # TypeScript ç±»å‹ (æ‰©å±• ~250 è¡Œ)
â”‚   â””â”€â”€ components/TradingCenter/
â”‚       â”œâ”€â”€ BrokerPanel.tsx         # åˆ¸å•†è¿æ¥é¢æ¿ (~200 è¡Œ)
â”‚       â”œâ”€â”€ OrderPanel.tsx          # è®¢å•é¢æ¿ (~350 è¡Œ)
â”‚       â”œâ”€â”€ PositionsTable.tsx      # æŒä»“è¡¨æ ¼ (~200 è¡Œ)
â”‚       â””â”€â”€ index.ts
```

---

## 3. åˆ¸å•†æ”¯æŒ

### 3.1 æ”¯æŒçš„åˆ¸å•†

| åˆ¸å•† | çŠ¶æ€ | è´¹ç”¨ | ç‰¹ç‚¹ |
|------|:----:|------|------|
| Alpaca | âœ… å¯ç”¨ | å…è´¹ | 0ä½£é‡‘, REST+WebSocket, Paper Trading |
| Interactive Brokers | ğŸ”œ è®¡åˆ’ | ä½è´¹ç”¨ | ä¸“ä¸šçº§, å…¨çƒå¸‚åœº |
| Paper Trading | âœ… å¯ç”¨ | å…è´¹ | æœ¬åœ°æ¨¡æ‹Ÿ, æ— éœ€é…ç½® |

### 3.2 Alpaca æ¥å£

```python
class AlpacaBroker(BaseBroker):
    """Alpaca åˆ¸å•†å®ç°"""

    LIVE_BASE_URL = "https://api.alpaca.markets"
    PAPER_BASE_URL = "https://paper-api.alpaca.markets"

    async def connect() -> bool
    async def get_account() -> BrokerAccount
    async def get_positions() -> list[BrokerPosition]
    async def submit_order(order) -> OrderResponse
    async def cancel_order(order_id) -> bool
    async def get_orders(status, limit) -> list[OrderResponse]
```

---

## 4. Almgren-Chriss æ»‘ç‚¹æ¨¡å‹

### 4.1 æ¨¡å‹å…¬å¼

```
æ€»æ»‘ç‚¹ = å›ºå®šæˆæœ¬ + ä¸´æ—¶å†²å‡» + æ°¸ä¹…å†²å‡»

Impact = spread/2 + Î· * Ïƒ * (Q/V)^0.5 + Î³ * (Q/V)

å…¶ä¸­:
- spread  : ä¹°å–ä»·å·®
- Î·       : ä¸´æ—¶å†²å‡»ç³»æ•° (é€šå¸¸ 0.1-0.5)
- Î³       : æ°¸ä¹…å†²å‡»ç³»æ•° (é€šå¸¸ 0.01-0.05)
- Ïƒ       : æ—¥æ³¢åŠ¨ç‡
- Q       : è®¢å•å¤§å° (è‚¡æ•°)
- V       : æ—¥å‡æˆäº¤é‡ (è‚¡æ•°)
```

### 4.2 ç¤ºä¾‹è®¡ç®—

```
è‚¡ç¥¨: AAPL
ä»·æ ¼: $180
æ—¥å‡æˆäº¤é‡: 50M è‚¡
è®¢å•å¤§å°: 10,000 è‚¡ (å  0.02%)
æ—¥æ³¢åŠ¨ç‡: 2%
ä»·å·®: 1 åŸºç‚¹

æ»‘ç‚¹ = 0.5bp + 0.3 * 2% * sqrt(0.02%) + 0.03 * 0.02%
     = 0.5bp + 0.85bp + 0.06bp
     â‰ˆ 1.4 åŸºç‚¹
     â‰ˆ $0.025 per share
```

### 4.3 æ”¯æŒçš„æ¨¡å‹

| æ¨¡å‹ | æè¿° | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| Fixed | å›ºå®šæ¯”ä¾‹ | å¿«é€Ÿä¼°ç®— |
| VolumeBased | æˆäº¤é‡ç›¸å…³ | ä¸­ç­‰è§„æ¨¡è®¢å• |
| Sqrt | å¹³æ–¹æ ¹æ¨¡å‹ | è¾ƒå‡†ç¡® |
| Almgren-Chriss | ç²¾ç¡®å†²å‡»æ¨¡å‹ | æ¨èä½¿ç”¨ |

---

## 5. API ç«¯ç‚¹

### 5.1 åˆ¸å•†ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ |
|------|------|------|
| GET | `/api/v1/trading/brokers` | è·å–æ”¯æŒçš„åˆ¸å•†åˆ—è¡¨ |
| GET | `/api/v1/trading/status` | è·å–äº¤æ˜“çŠ¶æ€æ‘˜è¦ |
| POST | `/api/v1/trading/connect/{broker}` | è¿æ¥åˆ¸å•† |

### 5.2 è´¦æˆ·ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ |
|------|------|------|
| GET | `/api/v1/trading/account` | è·å–è´¦æˆ·ä¿¡æ¯ |
| GET | `/api/v1/trading/positions` | è·å–æŒä»“ |

### 5.3 è®¢å•ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ |
|------|------|------|
| POST | `/api/v1/trading/orders` | æäº¤è®¢å• |
| GET | `/api/v1/trading/orders` | è·å–è®¢å•åˆ—è¡¨ |
| GET | `/api/v1/trading/orders/{id}` | è·å–å•ä¸ªè®¢å• |
| DELETE | `/api/v1/trading/orders/{id}` | å–æ¶ˆè®¢å• |

### 5.4 æ»‘ç‚¹ä¼°ç®—

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ |
|------|------|------|
| GET | `/api/v1/trading/slippage/models` | è·å–å¯ç”¨æ¨¡å‹ |
| POST | `/api/v1/trading/slippage/estimate` | ä¼°ç®—æ»‘ç‚¹ |
| POST | `/api/v1/trading/slippage/batch` | æ‰¹é‡ä¼°ç®— |

### 5.5 Paper Trading

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ |
|------|------|------|
| POST | `/api/v1/trading/paper/enable` | å¯ç”¨æ¨¡æ‹Ÿç›˜ |
| POST | `/api/v1/trading/paper/disable` | ç¦ç”¨æ¨¡æ‹Ÿç›˜ |
| GET | `/api/v1/trading/paper/state` | è·å–æ¨¡æ‹Ÿç›˜çŠ¶æ€ |

---

## 6. å‰ç«¯ç»„ä»¶

### 6.1 BrokerPanel

```typescript
// åˆ¸å•†è¿æ¥é¢æ¿
interface Features {
  - åˆ¸å•†è¿æ¥çŠ¶æ€æ˜¾ç¤º
  - Paper Trading å¼€å…³
  - å¸‚åœºçŠ¶æ€æŒ‡ç¤º
  - è´¦æˆ·æ¦‚è§ˆ (å‡€å€¼ã€è´­ä¹°åŠ›ã€ç°é‡‘ã€æ—¥ç›ˆäº)
}
```

### 6.2 OrderPanel

```typescript
// è®¢å•é¢æ¿
interface Features {
  - è®¢å•è¡¨å• (è‚¡ç¥¨ã€æ–¹å‘ã€æ•°é‡ã€ç±»å‹ã€ä»·æ ¼)
  - å®æ—¶æ»‘ç‚¹ä¼°ç®—
  - è®¢å•åˆ—è¡¨
  - è®¢å•å–æ¶ˆ
}
```

### 6.3 PositionsTable

```typescript
// æŒä»“è¡¨æ ¼
interface Features {
  - æŒä»“æ˜ç»†
  - æœªå®ç°ç›ˆäº
  - æŒä»“å æ¯”
  - æ€»å¸‚å€¼ç»Ÿè®¡
}
```

---

## 7. ä½¿ç”¨ç¤ºä¾‹

### 7.1 æäº¤è®¢å•

```typescript
// æäº¤å¸‚ä»·å•
const response = await fetch('/api/v1/trading/orders', {
  method: 'POST',
  body: JSON.stringify({
    symbol: 'AAPL',
    side: 'buy',
    quantity: 100,
    order_type: 'market',
  }),
})

// å“åº”åŒ…å«è®¢å•ä¿¡æ¯å’Œæ»‘ç‚¹ä¼°ç®—
const { order, estimated_slippage } = await response.json()
```

### 7.2 ä¼°ç®—æ»‘ç‚¹

```typescript
// ä¼°ç®—äº¤æ˜“æ»‘ç‚¹
const slippage = await fetch('/api/v1/trading/slippage/estimate', {
  method: 'POST',
  body: JSON.stringify({
    symbol: 'AAPL',
    side: 'buy',
    quantity: 1000,
    price: 180.0,
    daily_volume: 50000000,
    volatility: 0.02,
  }),
})

// è¿”å›è¯¦ç»†æ»‘ç‚¹åˆ†è§£
// {
//   total_slippage: 0.025,
//   fixed_cost: 0.009,
//   temporary_impact: 0.015,
//   permanent_impact: 0.001,
//   slippage_bps: 1.4,
// }
```

### 7.3 åˆ‡æ¢ Paper Trading

```typescript
// å¯ç”¨ Paper Trading
await fetch('/api/v1/trading/paper/enable', { method: 'POST' })

// ç¦ç”¨ Paper Trading (åˆ‡æ¢åˆ°å®ç›˜)
await fetch('/api/v1/trading/paper/disable', { method: 'POST' })
```

---

## 8. é…ç½®

### 8.1 ç¯å¢ƒå˜é‡

```bash
# Alpaca API
ALPACA_API_KEY=your_api_key
ALPACA_SECRET_KEY=your_secret_key

# Paper Trading é»˜è®¤å¯ç”¨
ALPACA_PAPER_TRADING=true
```

### 8.2 é»˜è®¤æ»‘ç‚¹å‚æ•°

```python
DEFAULT_PARAMS = AlmgrenChrissParams(
    eta=0.3,        # ä¸´æ—¶å†²å‡»ç³»æ•°
    gamma=0.03,     # æ°¸ä¹…å†²å‡»ç³»æ•°
    sigma=0.02,     # æ—¥æ³¢åŠ¨ç‡ 2%
    spread_bps=5.0, # ä¹°å–ä»·å·® 5 åŸºç‚¹
)
```

---

## 9. å®‰å…¨è€ƒè™‘

### 9.1 Paper Trading ä¼˜å…ˆ

- é»˜è®¤ä½¿ç”¨ Paper Trading æ¨¡å¼
- å®ç›˜äº¤æ˜“éœ€è¦æ˜ç¡®åˆ‡æ¢
- UI æ˜æ˜¾åŒºåˆ†æ¨¡æ‹Ÿ/å®ç›˜æ¨¡å¼

### 9.2 è®¢å•éªŒè¯

- æ•°é‡å¿…é¡»å¤§äº 0
- é™ä»·å•å¿…é¡»æŒ‡å®šä»·æ ¼
- æ­¢æŸå•å¿…é¡»æŒ‡å®šæ­¢æŸä»·
- èµ„é‡‘éªŒè¯ (Paper Trading)

---

## 10. æ€»ç»“

Phase 12 æˆåŠŸå®ç°äº†ï¼š

- âœ… åˆ¸å•† API å¯¹æ¥ (Alpaca + Paper Trading)
- âœ… ç»Ÿä¸€çš„åˆ¸å•†æ¥å£æŠ½è±¡
- âœ… Almgren-Chriss ç²¾ç¡®æ»‘ç‚¹æ¨¡å‹
- âœ… å®Œæ•´çš„è®¢å•ç®¡ç†ç³»ç»Ÿ
- âœ… äº¤æ˜“ API ç«¯ç‚¹ (15+ ç«¯ç‚¹)
- âœ… å‰ç«¯äº¤æ˜“ä¸­å¿ƒç»„ä»¶

**ä»£ç ç»Ÿè®¡**ï¼š
- åç«¯æ–°å¢ï¼š~1,700 è¡Œ
- å‰ç«¯æ–°å¢ï¼š~1,000 è¡Œ
- æ€»è®¡ï¼š~2,700 è¡Œ

**Phase 12 å®Œæˆï¼**
