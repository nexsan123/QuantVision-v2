# QuantVision 量化交易系统 - 完整设计文档

> **版本**: 3.0  
> **日期**: 2025-01-01  
> **定位**: 量化投资学习平台 → 私人机构级交易系统  
> **路线**: Phase 8-14 完整升级路径

---

## 目录

**第一部分：产品定位与架构**
1. [产品定位与演进路线](#1-产品定位与演进路线)
2. [系统架构设计](#2-系统架构设计)

**第二部分：核心功能设计**
3. [7步策略构建流程](#3-7步策略构建流程)
4. [策略构建器（双模式）](#4-策略构建器双模式)
5. [因子实验室设计](#5-因子实验室设计)
6. [AI助手系统](#6-ai助手系统)

**第三部分：机构级升级**
7. [机构级系统差距分析](#7-机构级系统差距分析)
8. [Phase 9: 回测引擎升级](#8-phase-9-回测引擎升级)
9. [Phase 10: 风险系统升级](#9-phase-10-风险系统升级)
10. [Phase 11: 数据层升级](#10-phase-11-数据层升级)
11. [Phase 12: 执行层升级](#11-phase-12-执行层升级)
12. [Phase 13: 归因与报表](#12-phase-13-归因与报表)
13. [Phase 14: 生产部署](#13-phase-14-生产部署)

**第四部分：数据结构与API**
14. [数据结构定义](#14-数据结构定义)
15. [API端点设计](#15-api端点设计)

**第五部分：实施计划**
16. [页面修改清单](#16-页面修改清单)
17. [完整实施路线图](#17-完整实施路线图)
18. [成本与资源估算](#18-成本与资源估算)

**附录**
- [附录A: 日内交易模块设计](#附录a-日内交易模块设计)
- [附录B: 算子完整列表](#附录b-算子完整列表)
- [附录C: Agent提示词模板](#附录c-agent提示词模板)

---

# 第一部分：产品定位与架构

## 1. 产品定位与演进路线

### 1.1 产品演进阶段

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      QuantVision 产品演进路线                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  阶段 1: 学习平台 (当前 → Phase 8)                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  目标用户: 量化新手、理性投资者                                  │   │
│  │  核心价值: 学习量化思维、验证投资想法                            │   │
│  │  功能重点: 7步流程、因子测试、基础回测、AI辅助学习               │   │
│  │  交易能力: 无（仅回测）                                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                    ↓                                    │
│  阶段 2: 研究系统 (Phase 9-10)                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  目标用户: 进阶投资者、独立研究员                                │   │
│  │  核心价值: 专业级策略研究、可信的回测结果                        │   │
│  │  功能重点: Walk-Forward、过拟合检测、风险模型、压力测试          │   │
│  │  交易能力: 无（研究为主）                                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                    ↓                                    │
│  阶段 3: 交易系统 (Phase 11-12)                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  目标用户: 私人量化交易者                                        │   │
│  │  核心价值: 实盘交易能力、精确成本控制                            │   │
│  │  功能重点: 券商对接、分钟数据、滑点模型、实时监控                │   │
│  │  交易能力: 完整（模拟盘+实盘）                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                    ↓                                    │
│  阶段 4: 机构级系统 (Phase 13-14)                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  目标用户: 私人基金、家族办公室                                  │   │
│  │  核心价值: 专业归因、合规报表、生产级稳定性                      │   │
│  │  功能重点: 归因分析、TCA、高可用部署、安全审计                   │   │
│  │  交易能力: 机构级                                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 核心价值主张

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     QuantVision 教会用户四件事                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   1️⃣  系统化思考投资                                                    │
│       不是凭感觉买卖，而是有清晰的投资逻辑和流程                         │
│                                                                         │
│   2️⃣  用数据验证想法                                                    │
│       任何投资想法都应该先用历史数据验证，而不是直接真金白银             │
│                                                                         │
│   3️⃣  风险比收益更重要                                                  │
│       控制风险是长期盈利的前提，先学会不亏钱                             │
│                                                                         │
│   4️⃣  成本决定成败                                                      │
│       交易成本、滑点、冲击成本会吃掉大部分利润                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.3 与竞品定位对比

| 平台 | 定位 | 优势 | 劣势 | QuantVision差异 |
|------|------|------|------|-----------------|
| QuantConnect | 专业量化 | 功能全面 | 学习曲线陡峭 | AI辅助降低门槛 |
| TradingView | 图表分析 | 易用性好 | 无策略框架 | 完整策略流程 |
| Zipline | 回测框架 | 开源灵活 | 无UI | 可视化+教育 |
| 聚宽/米筐 | 中国市场 | 数据全 | 仅A股 | 美股+教育 |

---

## 2. 系统架构设计

### 2.1 整体架构（机构级完整版）

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          QuantVision 机构级架构                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         前端层 (React + TypeScript)                      │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │   │
│  │  │ 策略    │ │ 因子    │ │ 回测    │ │ 交易    │ │ 风险    │          │   │
│  │  │ 构建器  │ │ 实验室  │ │ 中心    │ │ 中心    │ │ 中心    │          │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘          │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │   │
│  │  │                    AI 助手组件 (贯穿全流程)                       │  │   │
│  │  └─────────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                       ↓ WebSocket / REST                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         API 网关 (Kong/Nginx)                            │   │
│  │                    认证 | 限流 | 负载均衡 | 日志                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                       ↓                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         后端服务层 (FastAPI + Python)                    │   │
│  │                                                                         │   │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │   │
│  │  │                        核心引擎                                   │  │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │  │   │
│  │  │  │  因子   │ │  策略   │ │  回测   │ │  风险   │ │  执行   │   │  │   │
│  │  │  │  引擎   │ │  引擎   │ │  引擎   │ │  引擎   │ │  引擎   │   │  │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │  │   │
│  │  └──────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                         │   │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │   │
│  │  │                     机构级增强模块 (Phase 9-13)                   │  │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │  │   │
│  │  │  │Walk-Fwd │ │ 过拟合  │ │ 压力    │ │  归因   │ │  TCA    │   │  │   │
│  │  │  │ 验证    │ │ 检测    │ │ 测试    │ │  分析   │ │  分析   │   │  │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │  │   │
│  │  └──────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                         │   │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │   │
│  │  │                        AI 引擎 (Claude API)                       │  │   │
│  │  │         策略助手 | 因子助手 | 风险助手 | 学习助手                 │  │   │
│  │  └──────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                       ↓                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                              数据层                                      │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │   │
│  │  │PostgreSQL│ │Timescale│ │  Redis  │ │ ClickHse│ │   S3    │          │   │
│  │  │ 策略配置 │ │ 时序数据 │ │  缓存   │ │ 分析日志│ │ 文件存储│          │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                       ↓                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                           外部服务层                                     │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │   │
│  │  │ 行情API │ │ 券商API │ │Claude AI│ │ 新闻API │ │ 邮件/SMS│          │   │
│  │  │Polygon  │ │Alpaca/IB│ │         │ │         │ │         │          │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 模块依赖关系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          模块依赖关系图                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                        ┌─────────────┐                                  │
│                        │   数据层    │                                  │
│                        │ (行情/财务) │                                  │
│                        └──────┬──────┘                                  │
│                               │                                         │
│              ┌────────────────┼────────────────┐                        │
│              ▼                ▼                ▼                        │
│       ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │
│       │  因子引擎   │  │  风险引擎   │  │  执行引擎   │                │
│       │             │  │             │  │             │                │
│       │ • 因子计算  │  │ • VaR计算   │  │ • 滑点模型  │                │
│       │ • IC分析    │  │ • 压力测试  │  │ • 算法交易  │                │
│       │ • 因子库    │  │ • 风险模型  │  │ • TCA分析   │                │
│       └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                │
│              │                │                │                        │
│              └────────────────┼────────────────┘                        │
│                               ▼                                         │
│                        ┌─────────────┐                                  │
│                        │  策略引擎   │                                  │
│                        │             │                                  │
│                        │ • 信号生成  │                                  │
│                        │ • 组合优化  │                                  │
│                        │ • 策略配置  │                                  │
│                        └──────┬──────┘                                  │
│                               │                                         │
│                               ▼                                         │
│                        ┌─────────────┐                                  │
│                        │  回测引擎   │                                  │
│                        │             │                                  │
│                        │ • 事件驱动  │                                  │
│                        │ • Walk-Fwd  │                                  │
│                        │ • 归因分析  │                                  │
│                        └──────┬──────┘                                  │
│                               │                                         │
│              ┌────────────────┼────────────────┐                        │
│              ▼                ▼                ▼                        │
│       ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │
│       │  模拟交易   │  │  实盘交易   │  │  监控系统   │                │
│       └─────────────┘  └─────────────┘  └─────────────┘                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

# 第二部分：核心功能设计

## 3. 7步策略构建流程

### 3.1 流程概览

```
┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐
│  1  │──▶│  2  │──▶│  3  │──▶│  4  │──▶│  5  │──▶│  6  │──▶│  7  │
└──┬──┘   └──┬──┘   └──┬──┘   └──┬──┘   └──┬──┘   └──┬──┘   └──┬──┘
   │         │         │         │         │         │         │
投资池     因子层     信号层     风险层     组合层     执行层    监控层
Universe   Alpha     Signal     Risk    Portfolio Execution  Monitor

   │         │         │         │         │         │         │
   ▼         ▼         ▼         ▼         ▼         ▼         ▼
 选股范围   选股逻辑   买卖规则   风险控制   仓位分配   交易执行   持续监控
```

### 3.2 为什么是7步？

这是量化策略开发的**行业标准流程**，Two Sigma、Citadel、DE Shaw 等顶级机构都使用类似框架：

| 步骤 | 机构术语 | 核心问题 | 为什么重要 |
|:----:|----------|----------|-----------|
| 1 | Universe Selection | 在哪里选股？ | 排除不可投资的股票 |
| 2 | Alpha Generation | 用什么选股？ | 产生超额收益的来源 |
| 3 | Signal Construction | 何时买卖？ | 因子→交易信号的转化 |
| 4 | Risk Management | 能承受多少风险？ | 控制最大亏损 |
| 5 | Portfolio Optimization | 每只买多少？ | 仓位分配和权重 |
| 6 | Execution | 如何执行？ | 降低交易成本 |
| 7 | Monitoring | 持续监控什么？ | 风险预警和调整 |

### 3.3 Step 1: 投资池 (Universe)

**目的**: 定义策略可交易的股票范围  
**教育目标**: 让用户理解"不是所有股票都适合交易"

#### 配置项

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| basePool | enum | RUSSELL1000 | 基础股票池 |
| marketCap | range | 10亿+ | 市值筛选 |
| avgVolume | number | 500万 | 日均成交额下限 |
| listingAge | number | 1年 | 最短上市时间 |
| excludeIndustries | string[] | [] | 排除行业 |

#### UI设计要点

- 每个选项配有教育提示
- 显示筛选后的股票数量预览
- AI助手可回答"为什么要设这个条件"

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: 投资池配置                                    [?帮助]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 💡 为什么要选择投资池？                                 │   │
│  │                                                         │   │
│  │ 专业投资者不会随便买股票。他们首先确定一个"可投资范围"， │   │
│  │ 排除流动性差、市值太小、或自己不了解的股票。            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  基础股票池: [Russell 1000 ▼]                                   │
│                                                                 │
│  市值范围:   [10] 亿 ~ [不限] 亿美元                            │
│              💡 市值越大越稳定，但增长空间可能有限              │
│                                                                 │
│  日均成交额: ≥ [500] 万美元                                     │
│              ⚠️ 低于100万的股票可能难以买卖                     │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  📊 预估结果: 487 只股票符合条件                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.4 Step 2: 因子层 (Alpha)

**目的**: 选择和配置用于生成信号的因子  
**教育目标**: 让用户理解"投资需要有逻辑，而不是凭感觉"

#### 配置项

| 配置项 | 类型 | 说明 |
|--------|------|------|
| factors | FactorSelection[] | 已选因子列表 |
| combineMethod | enum | 因子组合方式 |
| normalize | enum | 标准化方式 |
| neutralize | string[] | 中性化处理 |

#### 因子选择方式

```
┌─────────────────────────────────────────────────────────────────┐
│  三种因子选择方式                                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ 🤖 AI推荐   │  │ 📋 从模板   │  │ 🔧 手动选择 │             │
│  │             │  │             │  │             │             │
│  │ 告诉AI你的  │  │ 使用预设的  │  │ 自己选择    │             │
│  │ 投资风格    │  │ 因子组合    │  │ 因子组合    │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                 │
│  AI对话示例:                                                    │
│  用户: "我想做趋势跟踪"                                         │
│  AI: "趋势跟踪适合动量类因子，推荐:                             │
│       • momentum_20d (20日动量)                                 │
│       • trend_strength (趋势强度)                               │
│       这两个因子组合IC可达0.05，IR约0.9"                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.5 Step 3: 信号层 (Signal) ⭐ 新增

**目的**: 定义入场和出场的具体规则  
**教育目标**: 让用户理解"有了选股逻辑，还需要明确买卖规则"

#### 为什么需要信号层？

```
之前的设计缺陷:
因子得分 (0.85) → ??? → 交易信号 (买入AAPL)
                  ↑
             这一步缺失了！

正确流程:
因子得分 (0.85) → 信号规则 (排名前10买入) → 交易信号 (买入AAPL)
```

#### 配置项

| 配置项 | 类型 | 说明 |
|--------|------|------|
| signalType | enum | long_only / long_short |
| entryRules | SignalRule[] | 入场规则 (AND逻辑) |
| exitRules | SignalRule[] | 出场规则 (OR逻辑) |
| targetPositions | number | 目标持仓数 |

#### 常用规则模板

| 规则类型 | 示例 | 说明 |
|----------|------|------|
| 排名规则 | 因子排名 ≤ 20 | 买入前20名 |
| 阈值规则 | 因子得分 > 0.5 | 得分高于阈值 |
| 止损规则 | 持仓亏损 > 15% | **必填** |
| 止盈规则 | 持仓盈利 > 50% | 可选 |
| 持仓期限 | 持仓天数 > 60 | 定期检视 |

### 3.6 Step 4: 风险层 (Risk) ⭐ 新增

**目的**: 设置风险约束和暴露限制  
**教育目标**: 让用户理解"风险控制是长期盈利的前提"

#### 散户 vs 机构的核心区别

```
散户思维: "选好股票就行了"
机构思维: "风险控制决定生死"

机构的风险约束:
• 单股最大 2-5%（不是 10-20%）
• 行业暴露严格限制
• 每日 VaR 监控
• 回撤达到阈值强制减仓
```

#### 配置项

| 配置项 | 类型 | 默认值 | 是否必填 |
|--------|------|--------|:--------:|
| maxSinglePosition | number | 5% | ✅ |
| maxIndustryPosition | number | 20% | ✅ |
| maxDrawdown | number | 15% | ✅ |
| maxVolatility | number | 25% | 可选 |
| maxVaR | number | 3% | 可选 |

#### 熔断规则（不可关闭）

| 级别 | 触发条件 | 动作 |
|:----:|----------|------|
| Level 1 | 日亏损 > 3% | 发送通知 |
| Level 2 | 日亏损 > 5% | 暂停开新仓 |
| Level 3 | 回撤 > 15% | 策略暂停，需人工确认 |

### 3.7 Step 5-7: 组合层、执行层、监控层

（详细设计见完整UI设计稿）

---

## 4. 策略构建器（双模式）

### 4.1 模式切换设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      策略构建器 - 双模式设计                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│    ┌─────────────────────┐    ←── 切换 ──→    ┌─────────────────────┐  │
│    │     向导模式        │                    │     工作流模式      │  │
│    │  (Wizard Mode)      │                    │  (Workflow Mode)    │  │
│    │                     │                    │                     │  │
│    │  • 7步引导流程      │                    │  • 节点拖拽         │  │
│    │  • AI全程陪伴       │                    │  • 自由连接         │  │
│    │  • 适合新手         │                    │  • 可视化展示       │  │
│    │  • 简单策略         │                    │  • 适合进阶用户     │  │
│    └─────────────────────┘                    └─────────────────────┘  │
│                                                                         │
│                    ↓ 底层数据结构完全相同 ↓                              │
│                                                                         │
│                   ┌─────────────────────┐                              │
│                   │   StrategyConfig    │                              │
│                   │   统一策略配置       │                              │
│                   └─────────────────────┘                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 向导模式布局

```
┌─────────────────────────────────────────────────────────────────────────┐
│  QuantVision          策略构建                    [向导] [工作流]  保存  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─ 步骤导航 ─────────────────────────────────────────────────────────┐ │
│  │  ①投资池 → ②因子 → ③信号 → ④风险 → ⑤组合 → ⑥执行 → ⑦监控      │ │
│  │     ✓        ✓       ●                                            │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌─ 主内容区 ──────────────────────────────────────┬─ AI助手 ────────┐ │
│  │                                                 │                  │ │
│  │  Step 3: 信号配置                               │  🤖 策略助手    │ │
│  │                                                 │                  │ │
│  │  [当前步骤的配置界面]                           │  这一步是定义    │ │
│  │                                                 │  什么时候买入    │ │
│  │                                                 │  和卖出。        │ │
│  │                                                 │                  │ │
│  │                                                 │  💡 建议:        │ │
│  │                                                 │  一定要设置止损  │ │
│  │                                                 │  规则！          │ │
│  │                                                 │                  │ │
│  │                    [上一步] [下一步]            │  [问AI...]      │ │
│  │                                                 │                  │ │
│  └─────────────────────────────────────────────────┴──────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.3 工作流模式布局

```
┌─────────────────────────────────────────────────────────────────────────┐
│  QuantVision          策略构建                    [向导] [工作流]  保存  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─ 节点工具箱 ─┬─ 工作流画布 ────────────────────┬─ AI助手 ────────┐ │
│  │              │                                  │                  │ │
│  │ ┌──────────┐│    ┌────────┐                    │  🤖 策略助手    │ │
│  │ │📊 投资池 ││    │ SP500  │──┐                 │                  │ │
│  │ └──────────┘│    └────────┘  │                 │  当前工作流      │ │
│  │ ┌──────────┐│                │  ┌────────┐     │  分析:           │ │
│  │ │📈 因子   ││    ┌────────┐  ├─▶│ 因子   │     │                  │ │
│  │ └──────────┘│    │ 动量   │──┤  │ 组合   │──┐  │  ✓ 投资池OK     │ │
│  │ ┌──────────┐│    └────────┘  │  └────────┘  │  │  ✓ 因子合理     │ │
│  │ │📍 信号   ││    ┌────────┐  │               │  │  ⚠️ 缺少止损   │ │
│  │ └──────────┘│    │ 价值   │──┘               │  │                  │ │
│  │ ┌──────────┐│    └────────┘      ┌────────┐ │  │  [自动修复]     │ │
│  │ │⚠️ 风险   ││                    │  信号  │◀┘  │                  │ │
│  │ └──────────┘│                    │  生成  │     │                  │ │
│  │ ┌──────────┐│                    └────────┘     │                  │ │
│  │ │🤖 Agent  ││                                  │                  │ │
│  │ └──────────┘│                                  │                  │ │
│  │              │                                  │                  │ │
│  └──────────────┴──────────────────────────────────┴──────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 因子实验室设计

### 5.1 三种因子创建方式

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      因子实验室 - 三种创建方式                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │
│   │                 │  │                 │  │                 │        │
│   │  🤖 AI 对话     │  │  📋 因子模板    │  │  ✏️ 自由创建    │        │
│   │                 │  │                 │  │                 │        │
│   │  告诉AI你的目标 │  │  从预置模板选择 │  │  自己写表达式   │        │
│   │  AI帮你推荐因子 │  │  一键使用       │  │  适合专业用户   │        │
│   │  AI解释因子原理 │  │                 │  │                 │        │
│   │                 │  │                 │  │                 │        │
│   │   [开始对话]    │  │   [浏览模板]    │  │   [打开编辑器]  │        │
│   │                 │  │                 │  │                 │        │
│   └─────────────────┘  └─────────────────┘  └─────────────────┘        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 AI对话创建因子流程

```
┌─────────────────────────────────────────────────────────────────┐
│  🤖 因子助手                                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  👤 用户: 我想找一个能捕捉股票上涨趋势的因子                      │
│                                                                 │
│  🤖 AI: 明白了，你想要趋势类因子。让我帮你分析几个选择：         │
│                                                                 │
│      推荐因子 1: momentum_20d                                   │
│      ┌───────────────────────────────────────────────────────┐ │
│      │ 📈 20日动量因子                                        │ │
│      │ 表达式: close / delay(close, 20) - 1                  │ │
│      │ IC均值: 0.045 | IR: 0.82 | 夏普: 1.23                 │ │
│      │                                                       │ │
│      │ 💡 这个因子测量过去20天的涨跌幅，适合捕捉中短期趋势    │ │
│      │                                                       │ │
│      │ [查看详情] [使用此因子] [调整参数]                     │ │
│      └───────────────────────────────────────────────────────┘ │
│                                                                 │
│  👤 用户: 第一个不错，但我想要更短期的，比如5天                  │
│                                                                 │
│  🤖 AI: 好的，我帮你调整为5日动量因子：                         │
│                                                                 │
│      ⚠️ 提示: 更短周期的因子通常:                              │
│         • 换手率更高 (交易成本增加)                             │
│         • 噪音更大 (信号不稳定)                                │
│         • 适合日内或短线交易                                   │
│                                                                 │
│      需要我帮你测试这个因子的效果吗？                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 AI助手的边界

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      AI助手能做什么 vs 不能做什么                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ✅ AI能做的:                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  • 解释已有因子的原理和适用场景                                  │   │
│  │  • 帮助理解因子参数的含义                                        │   │
│  │  • 推荐因子组合方式                                              │   │
│  │  • 分析因子测试结果                                              │   │
│  │  • 回答量化投资的基础概念                                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ❌ AI不能做的 (需要管理用户预期):                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  • 发现新的有效因子 (有效因子是稀缺资源)                         │   │
│  │  • 保证因子未来有效 (过去表现不代表未来)                         │   │
│  │  • 预测市场走势                                                  │   │
│  │  • 提供投资建议                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  📢 产品定位:                                                           │
│  "AI帮你理解投资，而不是替你做投资决策"                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. AI助手系统

### 6.1 AI助手角色体系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        AI助手角色体系                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  创建阶段 (Strategy Creation)                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  🤖 策略助手                                                    │   │
│  │     • 引导用户完成7步策略配置                                    │   │
│  │     • 解释每个选项的含义和影响                                   │   │
│  │     • 根据用户目标推荐配置                                       │   │
│  │     • 提示潜在风险和注意事项                                     │   │
│  │                                                                 │   │
│  │  🤖 因子助手                                                    │   │
│  │     • 根据用户描述推荐因子                                       │   │
│  │     • 解释因子的原理和适用场景                                   │   │
│  │     • 帮助调整因子参数                                           │   │
│  │     • 分析因子测试结果                                           │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  运行阶段 (Strategy Running) - 辅助分析，非自动决策                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  🤖 风险助手      - 分析风险状况，解释风险指标                   │   │
│  │  🤖 市场助手      - 分析市场环境，解释市场状态                   │   │
│  │  🤖 学习助手      - 回答量化投资问题，提供学习资源               │   │
│  │                                                                 │   │
│  │  ⚠️ 注意: 这些助手提供分析和解释，不做投资建议                  │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 AI助手调用架构

```typescript
// AI助手API设计
interface AIAssistantRequest {
  assistantType: 'strategy' | 'factor' | 'risk' | 'market' | 'learning';
  context: {
    currentStep?: number;           // 当前步骤
    strategyConfig?: StrategyConfig; // 策略配置
    userQuestion: string;           // 用户问题
  };
}

interface AIAssistantResponse {
  answer: string;                   // AI回答
  suggestions?: Suggestion[];       // 建议操作
  educationalContent?: string;      // 教育内容
  disclaimer?: string;              // 免责声明
}
```

---

# 第三部分：机构级升级

## 7. 机构级系统差距分析

### 7.1 完整差距对比

| 模块 | 机构级要求 | 当前状态 | 差距 | Phase |
|:----:|-----------|:--------:|:----:|:-----:|
| **数据层** |||||
| 日线行情 | ✓ | ✅ 有 | - | - |
| 分钟/Tick数据 | ✓ | ❌ 无 | 需要 | 11 |
| Level 2 订单簿 | ✓ | ❌ 无 | 可选 | 11+ |
| Point-in-Time财务 | ✓ | ⚠️ 部分 | 完善 | 11 |
| **研究层** |||||
| 因子引擎 | ✓ | ✅ 有 | - | - |
| IC/IR分析 | ✓ | ✅ 有 | - | - |
| Walk-Forward | ✓ | ❌ 无 | **关键** | 9 |
| 过拟合检测 | ✓ | ❌ 无 | **关键** | 9 |
| 多重检验校正 | ✓ | ❌ 无 | 需要 | 9 |
| **风险层** |||||
| VaR计算 | ✓ | ⚠️ 基础 | 加强 | 10 |
| 风险因子模型 | ✓ | ❌ 无 | 需要 | 10 |
| 压力测试 | ✓ | ❌ 无 | 需要 | 10 |
| 实时监控 | ✓ | ⚠️ 部分 | 完善 | 10 |
| **执行层** |||||
| 算法交易 | ✓ | ✅ TWAP/VWAP | 够用 | - |
| 滑点建模 | ✓ | ⚠️ 简单 | **精确** | 12 |
| 券商API对接 | ✓ | ❌ 无 | **关键** | 12 |
| TCA分析 | ✓ | ❌ 无 | 需要 | 13 |
| **归因分析** |||||
| Brinson归因 | ✓ | ❌ 无 | 需要 | 13 |
| 因子归因 | ✓ | ❌ 无 | 需要 | 13 |

### 7.2 优先级排序

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        优先级排序 (投入产出比)                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  🔴 P0 - 必须立即做 (影响策略真实性)                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  1. Walk-Forward 验证      → 避免过拟合，反映真实表现            │   │
│  │  2. 过拟合检测             → 识别虚假策略                        │   │
│  │  3. 精确滑点模型           → 回测结果才可信                      │   │
│  │  4. 前视偏差检测增强       → 确保回测公平                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  🟡 P1 - 尽快做 (影响策略有效性)                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  5. 风险因子模型           → 理解风险来源                        │   │
│  │  6. 压力测试               → 极端情况下的表现                    │   │
│  │  7. 券商API对接            → 能实际交易                          │   │
│  │  8. 分钟级数据             → 支持日内策略                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  🟢 P2 - 可以延后 (锦上添花)                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  9. 归因分析               → 理解收益来源                        │   │
│  │  10. TCA分析               → 优化执行                            │   │
│  │  11. Level 2数据           → 高频/订单流策略                     │   │
│  │  12. 另类数据              → 差异化Alpha                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Phase 9: 回测引擎升级

### 8.1 Walk-Forward 验证

#### 什么是Walk-Forward？

```
传统回测的问题:
┌────────────────────────────────────────────────────────────────────┐
│                     全部历史数据                                    │
│  ══════════════════════════════════════════════════════════════   │
│                           ↓                                        │
│                    优化参数 + 测试                                  │
│                           ↓                                        │
│                    "年化收益50%！"                                  │
│                           ↓                                        │
│                    实际上是过拟合                                   │
└────────────────────────────────────────────────────────────────────┘

Walk-Forward 验证:
┌────────────────────────────────────────────────────────────────────┐
│  第1轮:                                                            │
│  │ 训练期 (2015-2017) │ 测试期1 (2018) │                          │
│  ══════════════════════●════════════════                           │
│                                                                    │
│  第2轮:                                                            │
│       │ 训练期 (2016-2018) │ 测试期2 (2019) │                     │
│       ══════════════════════●════════════════                      │
│                                                                    │
│  第3轮:                                                            │
│            │ 训练期 (2017-2019) │ 测试期3 (2020) │                │
│            ══════════════════════●════════════════                 │
│                                                                    │
│  最终结果 = 测试期1 + 测试期2 + 测试期3 的累计表现                 │
│  这才是真实的策略表现！                                            │
└────────────────────────────────────────────────────────────────────┘
```

#### 实现设计

```typescript
interface WalkForwardConfig {
  // 窗口设置
  trainPeriod: number;      // 训练期长度 (月)
  testPeriod: number;       // 测试期长度 (月)
  stepSize: number;         // 滚动步长 (月)
  
  // 优化设置
  optimizeTarget: 'sharpe' | 'returns' | 'calmar';
  parameterRanges: Record<string, [number, number, number]>;  // [min, max, step]
  
  // 约束
  minTrainSamples: number;  // 最小训练样本数
}

interface WalkForwardResult {
  rounds: WalkForwardRound[];
  aggregatedMetrics: {
    oosSharpe: number;      // 样本外夏普
    oosReturns: number;     // 样本外收益
    oosMaxDrawdown: number; // 样本外最大回撤
    stabilityRatio: number; // 稳定性比率 (OOS/IS)
  };
  overfitProbability: number; // 过拟合概率
}

interface WalkForwardRound {
  trainStart: Date;
  trainEnd: Date;
  testStart: Date;
  testEnd: Date;
  optimizedParams: Record<string, number>;
  inSampleMetrics: BacktestMetrics;
  outOfSampleMetrics: BacktestMetrics;
}
```

#### UI设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Walk-Forward 验证配置                                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 💡 什么是Walk-Forward验证？                                      │   │
│  │                                                                 │   │
│  │ 传统回测用全部数据优化参数，容易过拟合。                         │   │
│  │ Walk-Forward模拟真实投资：用过去数据训练，用未来数据测试。       │   │
│  │ 只有样本外表现才能反映策略的真实能力。                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  窗口配置                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  训练期长度:  [36] 个月                                         │   │
│  │  测试期长度:  [12] 个月                                         │   │
│  │  滚动步长:    [12] 个月                                         │   │
│  │                                                                 │   │
│  │  预计验证轮数: 5 轮                                              │   │
│  │  覆盖时间范围: 2015-01 至 2024-12                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  参数优化范围                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  因子回望周期:  [10] ~ [60] 天，步长 [10]                       │   │
│  │  持仓数量:      [10] ~ [50] 只，步长 [10]                       │   │
│  │  止损阈值:      [5%] ~ [20%]，步长 [5%]                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│                                              [取消] [开始验证]          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 8.2 过拟合检测

#### 检测方法

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        过拟合检测方法                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  方法1: 参数敏感性分析                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  如果参数微调后收益剧变 → 过拟合                                │   │
│  │                                                                 │   │
│  │  好的策略:                 过拟合策略:                          │   │
│  │  ┌─────────────┐           ┌─────────────┐                      │   │
│  │  │  ▁▂▃▄▅▆▇█   │           │  ▁▁▁█▁▁▁▁   │                      │   │
│  │  │  参数变化   │           │  参数变化   │                      │   │
│  │  │  收益平滑   │           │  只有一点好 │                      │   │
│  │  └─────────────┘           └─────────────┘                      │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  方法2: 样本内外差异                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  稳定性比率 = 样本外夏普 / 样本内夏普                           │   │
│  │                                                                 │   │
│  │  > 0.7  → 稳健                                                  │   │
│  │  0.5-0.7 → 一般                                                 │   │
│  │  < 0.5  → 可能过拟合                                            │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  方法3: Deflated Sharpe Ratio (DSR)                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  调整多重检验偏差的夏普比率                                      │   │
│  │                                                                 │   │
│  │  DSR = SR * adjustment_factor(试验次数, 相关性)                 │   │
│  │                                                                 │   │
│  │  如果测试了100个策略，"最好"的那个可能只是运气好                │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  方法4: 夏普比率上限检验                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  经验法则:                                                       │   │
│  │  • 夏普 > 3   → 几乎肯定过拟合                                  │   │
│  │  • 夏普 > 2   → 很可能过拟合，需要仔细检查                      │   │
│  │  • 夏普 1-2   → 合理范围                                        │   │
│  │  • 夏普 < 1   → 可能不够好，但不一定是过拟合                    │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 实现设计

```typescript
interface OverfitDetectionResult {
  // 参数敏感性
  parameterSensitivity: {
    parameter: string;
    sensitivityScore: number;  // 0-1, 越高越敏感
    optimalRange: [number, number];
    chart: { param: number; sharpe: number }[];
  }[];
  
  // 样本内外对比
  inOutSampleComparison: {
    inSampleSharpe: number;
    outSampleSharpe: number;
    stabilityRatio: number;
    verdict: 'robust' | 'moderate' | 'likely_overfit';
  };
  
  // DSR
  deflatedSharpeRatio: {
    originalSharpe: number;
    deflatedSharpe: number;
    trialsCount: number;
    adjustmentFactor: number;
  };
  
  // 综合评估
  overallAssessment: {
    overfitProbability: number;  // 0-100%
    confidence: 'high' | 'medium' | 'low';
    recommendations: string[];
  };
}
```

### 8.3 前视偏差检测增强

```typescript
interface BiasDetectionResult {
  // 前视偏差
  lookaheadBias: {
    detected: boolean;
    issues: {
      field: string;
      description: string;
      severity: 'high' | 'medium' | 'low';
    }[];
  };
  
  // 幸存者偏差
  survivorshipBias: {
    detected: boolean;
    delistedStocksUsed: string[];
    impactEstimate: number;  // 对收益的影响估计
  };
  
  // 数据窥探偏差
  dataSnoopingBias: {
    trialsCount: number;      // 测试过的策略数量
    adjustedPValue: number;   // 调整后的p值
  };
}
```

### 8.4 Phase 9 实施计划

| 任务 | 估时 | 优先级 | 依赖 |
|------|:----:|:------:|------|
| Walk-Forward引擎核心 | 5天 | P0 | - |
| Walk-Forward UI | 3天 | P0 | 核心 |
| 参数敏感性分析 | 3天 | P0 | - |
| DSR计算 | 2天 | P1 | - |
| 前视偏差检测增强 | 3天 | P0 | - |
| 幸存者偏差检测 | 2天 | P1 | - |
| 综合过拟合报告UI | 3天 | P1 | 以上全部 |
| 测试和优化 | 3天 | - | 全部 |
| **总计** | **24天** |||

---

## 9. Phase 10: 风险系统升级

### 9.1 风险因子模型（简化版Barra）

#### 模型结构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      简化版风险因子模型                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  股票收益 = 市场因子 + 风格因子 + 行业因子 + 特质收益                   │
│                                                                         │
│  Ri = β_mkt * R_mkt + Σ(β_style * R_style) + Σ(β_ind * R_ind) + ε_i    │
│                                                                         │
│  风格因子 (8个):                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  • Size       市值因子     ln(市值)                             │   │
│  │  • Value      价值因子     BP, EP                               │   │
│  │  • Momentum   动量因子     12-1个月收益率                       │   │
│  │  • Volatility 波动因子     252日波动率                          │   │
│  │  • Quality    质量因子     ROE, 资产周转率                      │   │
│  │  • Growth     成长因子     营收增长率                           │   │
│  │  • Liquidity  流动因子     换手率                               │   │
│  │  • Leverage   杠杆因子     资产负债率                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  行业因子 (11个 GICS一级行业):                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  通讯服务 | 非必需消费 | 必需消费 | 能源 | 金融                  │   │
│  │  医疗 | 工业 | 信息技术 | 材料 | 房地产 | 公用事业              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 风险分解

```typescript
interface RiskDecomposition {
  totalRisk: number;           // 总风险 (年化波动率)
  
  // 风险来源分解
  riskContributions: {
    market: number;            // 市场风险贡献
    style: {
      size: number;
      value: number;
      momentum: number;
      volatility: number;
      quality: number;
      growth: number;
      liquidity: number;
      leverage: number;
    };
    industry: Record<string, number>;  // 行业风险贡献
    specific: number;          // 特质风险
  };
  
  // 因子暴露
  factorExposures: {
    market: number;            // 市场Beta
    style: Record<string, number>;
    industry: Record<string, number>;
  };
}
```

### 9.2 压力测试

#### 历史情景

| 情景 | 时间 | SPY回撤 | 特点 |
|------|------|:-------:|------|
| 2008金融危机 | 2008.09-2009.03 | -50% | 系统性风险 |
| 2011欧债危机 | 2011.07-2011.10 | -19% | 市场恐慌 |
| 2015中国股灾 | 2015.08 | -12% | 外部冲击 |
| 2018年末下跌 | 2018.10-2018.12 | -20% | 加息恐慌 |
| 2020 COVID | 2020.02-2020.03 | -34% | 黑天鹅 |
| 2022加息周期 | 2022.01-2022.10 | -25% | 利率上升 |

#### 假设情景

```typescript
interface StressScenario {
  name: string;
  description: string;
  shocks: {
    marketReturn?: number;      // 市场收益冲击
    volatilityMultiplier?: number; // 波动率乘数
    sectorShocks?: Record<string, number>; // 行业冲击
    factorShocks?: Record<string, number>; // 因子冲击
    liquidityShock?: number;    // 流动性冲击 (滑点乘数)
  };
}

// 预置情景
const PRESET_SCENARIOS: StressScenario[] = [
  {
    name: '市场下跌20%',
    shocks: { marketReturn: -0.20 }
  },
  {
    name: '市场下跌30% + 波动率翻倍',
    shocks: { marketReturn: -0.30, volatilityMultiplier: 2.0 }
  },
  {
    name: '科技股崩盘',
    shocks: { 
      marketReturn: -0.15,
      sectorShocks: { 'Information Technology': -0.40 }
    }
  },
  {
    name: '流动性危机',
    shocks: { 
      marketReturn: -0.10,
      liquidityShock: 5.0  // 滑点增加5倍
    }
  }
];
```

#### 压力测试结果

```typescript
interface StressTestResult {
  scenario: StressScenario;
  portfolioImpact: {
    expectedLoss: number;       // 预期亏损
    expectedLossPercent: number;
    varImpact: number;          // VaR变化
    liquidationRisk: boolean;   // 是否触发强平
  };
  positionImpacts: {
    symbol: string;
    currentWeight: number;
    expectedLoss: number;
    contribution: number;       // 对组合亏损的贡献
  }[];
  recommendations: string[];
}
```

### 9.3 实时风险监控增强

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        实时风险监控面板                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─ 风险概览 ──────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │   当前回撤        VaR (95%)       波动率         因子暴露       │   │
│  │   ┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐      │   │
│  │   │ -5.2%  │     │  2.1%  │     │ 18.5%  │     │  正常   │      │   │
│  │   │ ██████░│     │ ████░░░│     │ █████░░│     │ ███████│      │   │
│  │   │ /15%   │     │ /3%    │     │ /25%   │     │        │      │   │
│  │   └────────┘     └────────┘     └────────┘     └────────┘      │   │
│  │      34%            70%            74%           OK             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─ 风险分解 ──────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │   市场风险    45%  ████████████████░░░░░░░░░░░░░░░░░░░░░░       │   │
│  │   行业风险    25%  █████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░       │   │
│  │   风格风险    15%  █████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░       │   │
│  │   特质风险    15%  █████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░       │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─ 告警 ──────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │   ⚠️ 科技行业暴露达到18%，接近20%上限                           │   │
│  │   ⚠️ 动量因子暴露较高 (0.4)，注意动量反转风险                   │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 9.4 Phase 10 实施计划

| 任务 | 估时 | 优先级 | 依赖 |
|------|:----:|:------:|------|
| 风险因子计算 | 5天 | P1 | 数据 |
| 因子协方差矩阵 | 3天 | P1 | 因子 |
| 风险分解计算 | 3天 | P1 | 协方差 |
| 压力测试引擎 | 4天 | P1 | 风险模型 |
| 预置情景配置 | 2天 | P1 | 引擎 |
| 实时监控后端 | 3天 | P1 | 风险模型 |
| 风险监控UI | 4天 | P1 | 后端 |
| 测试和优化 | 3天 | - | 全部 |
| **总计** | **27天** |||

---

## 10. Phase 11: 数据层升级

### 10.1 分钟级数据架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        分钟级数据架构                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  数据源                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  • Polygon.io    $200/月   1分钟数据，历史+实时                  │   │
│  │  • Alpaca        免费       5分钟数据，有限制                    │   │
│  │  • IEX Cloud     $50/月    分钟数据，延迟15分钟                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  存储架构                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │                    ┌─────────────┐                              │   │
│  │   实时数据 ───────▶│   Redis     │ (最近1小时)                  │   │
│  │                    └──────┬──────┘                              │   │
│  │                           │                                     │   │
│  │                           ▼                                     │   │
│  │                    ┌─────────────┐                              │   │
│  │   分钟数据 ───────▶│ TimescaleDB │ (最近1年)                    │   │
│  │                    └──────┬──────┘                              │   │
│  │                           │                                     │   │
│  │                           ▼                                     │   │
│  │                    ┌─────────────┐                              │   │
│  │   历史数据 ───────▶│    S3       │ (归档)                       │   │
│  │                    └─────────────┘                              │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  数据量估算 (1年，4000只股票):                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  • 1分钟数据: 4000 × 390min × 252天 × 6字段 ≈ 2.4B 行           │   │
│  │  • 存储空间: 约 200-500 GB (压缩后)                              │   │
│  │  • 日增量: 约 10M 行 / 1GB                                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 10.2 日内因子计算

```typescript
// 日内因子示例
const intradayFactors = {
  // 相对成交量
  relative_volume: {
    expression: 'volume_10min / avg(volume_10min, 20)',
    description: '当前10分钟成交量 / 过去20天同时段平均成交量',
    interpretation: '>2.0 显著放量, <0.5 显著缩量'
  },
  
  // VWAP偏离
  vwap_deviation: {
    expression: '(close - vwap) / vwap',
    description: '当前价格相对VWAP的偏离程度',
    interpretation: '>0 买压强, <0 卖压强'
  },
  
  // 买卖压力
  buy_pressure: {
    expression: 'buy_volume / (buy_volume + sell_volume)',
    description: '主动买入量占比',
    interpretation: '>0.6 买压强, <0.4 卖压强'
  },
  
  // 价格动量
  price_momentum_5min: {
    expression: 'close / delay(close, 5) - 1',
    description: '5分钟价格动量'
  }
};
```

### 10.3 Phase 11 实施计划

| 任务 | 估时 | 优先级 | 依赖 |
|------|:----:|:------:|------|
| 数据源对接 (Polygon) | 3天 | P1 | - |
| TimescaleDB架构 | 3天 | P1 | - |
| 数据ETL流程 | 4天 | P1 | 数据源 |
| 日内因子引擎 | 5天 | P1 | 数据 |
| PIT财务数据完善 | 3天 | P0 | - |
| 数据质量监控 | 2天 | P2 | ETL |
| 测试和优化 | 3天 | - | 全部 |
| **总计** | **23天** |||

---

## 11. Phase 12: 执行层升级

### 11.1 券商API对接

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        券商API对接架构                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  支持券商                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  首选: Alpaca                                                   │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  • 免费API，0佣金                                        │   │   │
│  │  │  • Paper Trading 支持                                    │   │   │
│  │  │  • REST + WebSocket                                      │   │   │
│  │  │  • 适合入门和测试                                        │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │                                                                 │   │
│  │  备选: Interactive Brokers (IB)                                 │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  • 专业级，费用低                                        │   │   │
│  │  │  • API完善，功能全面                                     │   │   │
│  │  │  • 需要最低资金要求                                      │   │   │
│  │  │  • 适合正式交易                                          │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  统一接口设计                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │   ┌─────────────────────────────────────────────────────────┐  │   │
│  │   │                  BrokerInterface                         │  │   │
│  │   │                                                         │  │   │
│  │   │  + get_account() → AccountInfo                          │  │   │
│  │   │  + get_positions() → Position[]                         │  │   │
│  │   │  + submit_order(order) → OrderResult                    │  │   │
│  │   │  + cancel_order(order_id) → bool                        │  │   │
│  │   │  + get_order_status(order_id) → OrderStatus             │  │   │
│  │   │  + subscribe_updates(callback)                          │  │   │
│  │   │                                                         │  │   │
│  │   └─────────────────────────────────────────────────────────┘  │   │
│  │                        ▲           ▲                           │   │
│  │                        │           │                           │   │
│  │              ┌─────────┴───┐ ┌─────┴─────────┐                 │   │
│  │              │AlpacaBroker │ │    IBBroker   │                 │   │
│  │              └─────────────┘ └───────────────┘                 │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 11.2 精确滑点模型

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Almgren-Chriss 滑点模型                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  总滑点 = 固定成本 + 临时冲击 + 永久冲击                                 │
│                                                                         │
│  Impact = spread/2 + η * σ * (Q/V)^0.5 + γ * (Q/V)                      │
│                                                                         │
│  其中:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  • spread  : 买卖价差                                           │   │
│  │  • η       : 临时冲击系数 (通常 0.1-0.5)                        │   │
│  │  • γ       : 永久冲击系数 (通常 0.01-0.05)                      │   │
│  │  • σ       : 日波动率                                           │   │
│  │  • Q       : 订单大小 (股数)                                    │   │
│  │  • V       : 日均成交量 (股数)                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  示例计算:                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  股票: AAPL                                                     │   │
│  │  价格: $180                                                     │   │
│  │  日均成交量: 50M 股                                             │   │
│  │  订单大小: 10,000 股 (占0.02%)                                  │   │
│  │  日波动率: 2%                                                   │   │
│  │  价差: $0.02 (0.01%)                                            │   │
│  │                                                                 │   │
│  │  滑点 = 0.01% + 0.3 * 2% * sqrt(0.02%) + 0.03 * 0.02%           │   │
│  │       = 0.01% + 0.008% + 0.0006%                                │   │
│  │       ≈ 0.019%                                                   │   │
│  │                                                                 │   │
│  │  对于流动性差的小盘股，滑点可能达到 0.3-1%                      │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 11.3 Phase 12 实施计划

| 任务 | 估时 | 优先级 | 依赖 |
|------|:----:|:------:|------|
| Alpaca API封装 | 4天 | P1 | - |
| 订单管理系统 | 4天 | P1 | API |
| Paper Trading流程 | 3天 | P1 | 订单 |
| 滑点模型实现 | 3天 | P0 | - |
| 滑点参数校准 | 2天 | P1 | 模型 |
| 实时交易监控UI | 4天 | P1 | 全部 |
| IB对接 (可选) | 5天 | P2 | - |
| 测试和优化 | 3天 | - | 全部 |
| **总计** | **28天** |||

---

## 12. Phase 13: 归因与报表

### 12.1 Brinson归因

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Brinson 归因模型                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  总超额收益 = 配置效应 + 选股效应 + 交互效应                            │
│                                                                         │
│  配置效应 (Allocation):                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  由于行业配置不同于基准带来的收益                                │   │
│  │  = Σ (w_p - w_b) × R_b                                          │   │
│  │                                                                 │   │
│  │  例如: 超配科技 10%，科技涨 20%                                  │   │
│  │  配置效应 = 10% × 20% = 2%                                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  选股效应 (Selection):                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  由于行业内选股不同于基准带来的收益                              │   │
│  │  = Σ w_b × (R_p - R_b)                                          │   │
│  │                                                                 │   │
│  │  例如: 科技行业选股跑赢基准 5%                                   │   │
│  │  选股效应 = 20%(基准权重) × 5% = 1%                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  交互效应 (Interaction):                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  配置和选股的交叉影响                                           │   │
│  │  = Σ (w_p - w_b) × (R_p - R_b)                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 12.2 因子归因

```typescript
interface FactorAttribution {
  period: { start: Date; end: Date };
  
  totalReturn: number;
  benchmarkReturn: number;
  activeReturn: number;  // 超额收益
  
  // 因子归因分解
  factorContributions: {
    market: number;
    size: number;
    value: number;
    momentum: number;
    quality: number;
    volatility: number;
    // ... 其他因子
  };
  
  specificReturn: number;  // 特质收益 (选股能力)
  
  // 信息比率
  informationRatio: number;
  trackingError: number;
}
```

### 12.3 归因报告UI

```
┌─────────────────────────────────────────────────────────────────────────┐
│  收益归因分析                                    2024-01 至 2024-12     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  收益概览                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │   组合收益        基准收益        超额收益        信息比率       │   │
│  │   ┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐      │   │
│  │   │ +18.5% │     │ +12.3% │     │  +6.2% │     │  1.25  │      │   │
│  │   └────────┘     └────────┘     └────────┘     └────────┘      │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Brinson 归因                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │   超额收益 +6.2%                                                │   │
│  │   ═══════════════════════════════════════════════════════════   │   │
│  │                                                                 │   │
│  │   配置效应    +2.1%  ████████████░░░░░░░░░░░░░░░░░░░░░░░░░      │   │
│  │   选股效应    +3.5%  ██████████████████████░░░░░░░░░░░░░░░      │   │
│  │   交互效应    +0.6%  ███░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░      │   │
│  │                                                                 │   │
│  │   💡 解读: 超额收益主要来自选股能力 (56%)，其次是行业配置 (34%) │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  因子归因                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │   市场因子     +8.2%   ████████████████████████████████████     │   │
│  │   动量因子     +3.1%   ███████████████░░░░░░░░░░░░░░░░░░░░     │   │
│  │   价值因子     -0.8%   ████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░     │   │
│  │   质量因子     +1.5%   ████████░░░░░░░░░░░░░░░░░░░░░░░░░░░     │   │
│  │   规模因子     -0.5%   ███░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░     │   │
│  │   特质收益     +7.0%   ██████████████████████████████████░     │   │
│  │                                                                 │   │
│  │   💡 解读: 特质收益占比 38%，说明选股能力强                      │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 12.4 Phase 13 实施计划

| 任务 | 估时 | 优先级 | 依赖 |
|------|:----:|:------:|------|
| Brinson归因计算 | 3天 | P2 | - |
| 因子归因计算 | 4天 | P2 | 风险模型 |
| TCA分析模块 | 4天 | P2 | 交易数据 |
| 归因报告UI | 4天 | P2 | 计算 |
| PDF报表导出 | 2天 | P2 | UI |
| 测试和优化 | 2天 | - | 全部 |
| **总计** | **19天** |||

---

## 13. Phase 14: 生产部署

### 13.1 部署架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        生产部署架构 (AWS)                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         用户访问                                 │   │
│  │                            │                                    │   │
│  │                            ▼                                    │   │
│  │                    ┌───────────────┐                            │   │
│  │                    │  CloudFront   │  CDN                       │   │
│  │                    └───────┬───────┘                            │   │
│  │                            │                                    │   │
│  │                            ▼                                    │   │
│  │                    ┌───────────────┐                            │   │
│  │                    │     ALB       │  负载均衡                   │   │
│  │                    └───────┬───────┘                            │   │
│  │                            │                                    │   │
│  │              ┌─────────────┼─────────────┐                      │   │
│  │              ▼             ▼             ▼                      │   │
│  │         ┌────────┐   ┌────────┐   ┌────────┐                   │   │
│  │         │  ECS   │   │  ECS   │   │  ECS   │  容器集群          │   │
│  │         │ API-1  │   │ API-2  │   │ Worker │                   │   │
│  │         └────────┘   └────────┘   └────────┘                   │   │
│  │              │             │             │                      │   │
│  │              └─────────────┼─────────────┘                      │   │
│  │                            │                                    │   │
│  │              ┌─────────────┼─────────────┐                      │   │
│  │              ▼             ▼             ▼                      │   │
│  │         ┌────────┐   ┌────────┐   ┌────────┐                   │   │
│  │         │  RDS   │   │Elastic │   │   S3   │                   │   │
│  │         │Postgres│   │ Cache  │   │        │                   │   │
│  │         └────────┘   └────────┘   └────────┘                   │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  监控告警                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  CloudWatch → SNS → PagerDuty/Slack                             │   │
│  │                                                                 │   │
│  │  监控指标:                                                       │   │
│  │  • API响应时间 < 500ms                                          │   │
│  │  • 错误率 < 0.1%                                                │   │
│  │  • CPU使用率 < 70%                                              │   │
│  │  • 数据库连接数 < 80%                                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 13.2 安全措施

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           安全措施清单                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  认证与授权                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  • JWT Token 认证                                               │   │
│  │  • 2FA 双因素认证 (交易操作)                                    │   │
│  │  • API Key 管理                                                 │   │
│  │  • 角色权限控制 (RBAC)                                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  数据安全                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  • 数据库加密 (AES-256)                                         │   │
│  │  • 传输加密 (TLS 1.3)                                           │   │
│  │  • 敏感数据脱敏                                                 │   │
│  │  • 定期备份 (日备/周备)                                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  券商API安全                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  • API Key 加密存储 (KMS)                                       │   │
│  │  • IP 白名单                                                    │   │
│  │  • 交易限额控制                                                 │   │
│  │  • 操作日志审计                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 13.3 Phase 14 实施计划

| 任务 | 估时 | 优先级 | 依赖 |
|------|:----:|:------:|------|
| Docker容器化 | 3天 | P1 | - |
| AWS基础设施 | 4天 | P1 | Docker |
| CI/CD流水线 | 3天 | P1 | AWS |
| 监控告警配置 | 2天 | P1 | 部署 |
| 安全加固 | 3天 | P1 | 部署 |
| 灾备方案 | 2天 | P2 | 部署 |
| 性能测试 | 2天 | P1 | 全部 |
| 文档完善 | 2天 | P2 | 全部 |
| **总计** | **21天** |||

---

# 第四部分：数据结构与API

## 14. 数据结构定义

### 14.1 完整策略配置

```typescript
interface StrategyConfig {
  // 元信息
  id: string;
  name: string;
  description?: string;
  version: number;
  status: StrategyStatus;
  createdAt: string;
  updatedAt: string;
  
  // Step 1: 投资池
  universe: UniverseConfig;
  
  // Step 2: 因子层
  alpha: AlphaConfig;
  
  // Step 3: 信号层
  signal: SignalConfig;
  
  // Step 4: 风险层
  risk: RiskConfig;
  
  // Step 5: 组合层
  portfolio: PortfolioConfig;
  
  // Step 6: 执行层
  execution: ExecutionConfig;
  
  // Step 7: 监控层
  monitor: MonitorConfig;
  
  // 工作流定义 (可选)
  workflow?: WorkflowDefinition;
}

type StrategyStatus = 
  | 'draft'       // 草稿
  | 'backtesting' // 回测中
  | 'validated'   // 已验证
  | 'paper'       // 模拟盘
  | 'live'        // 实盘
  | 'paused'      // 暂停
  | 'archived';   // 归档
```

### 14.2 各层配置详细定义

```typescript
// Step 1: 投资池
interface UniverseConfig {
  basePool: 'SP500' | 'NASDAQ100' | 'RUSSELL1000' | 'RUSSELL3000' | 'ALL' | 'CUSTOM';
  customSymbols?: string[];
  filters: {
    marketCap?: { min?: number; max?: number };
    avgVolume?: { min?: number };
    listingAge?: { min?: number };
    excludeIndustries?: string[];
  };
}

// Step 2: 因子层
interface AlphaConfig {
  factors: FactorSelection[];
  combineMethod: 'equal' | 'ic_weighted' | 'optimized' | 'custom';
  customWeights?: Record<string, number>;
  normalize: 'zscore' | 'rank' | 'minmax';
  neutralize: ('industry' | 'size' | 'beta')[];
}

// Step 3: 信号层
interface SignalConfig {
  signalType: 'long_only' | 'long_short' | 'market_neutral';
  entryRules: SignalRule[];
  exitRules: SignalRule[];
  targetPositions: number;
  signalDelay: number;
  rankBuffer: number;
}

// Step 4: 风险层
interface RiskConfig {
  positionLimits: {
    maxSinglePosition: number;
    maxIndustryPosition: number;
    maxPositions: number;
  };
  riskLimits: {
    maxDrawdown: number;
    maxVolatility?: number;
    maxVaR?: number;
  };
  circuitBreakers: CircuitBreaker[];
}

// Step 5: 组合层
interface PortfolioConfig {
  optimizer: 'equal' | 'max_sharpe' | 'min_variance' | 'risk_parity';
  turnoverLimits: {
    maxSingleTurnover: number;
    maxAnnualTurnover: number;
  };
  tradingCosts: {
    commission: number;
    slippage: number;
    marketImpact: number;
  };
  cashReserve: number;
}

// Step 6: 执行层
interface ExecutionConfig {
  frequency: 'daily' | 'weekly' | 'monthly' | 'quarterly' | 'custom';
  customFrequency?: number;
  executionTime: 'close' | 'open' | 'distributed';
  algorithm: 'market' | 'twap' | 'vwap' | 'pov';
  algorithmParams?: {
    window?: number;
    participationRate?: number;
  };
}

// Step 7: 监控层
interface MonitorConfig {
  alerts: AlertConfig[];
  notifications: {
    email?: string[];
    webhook?: string;
    inApp: boolean;
  };
}
```

### 14.3 回测结果结构

```typescript
interface BacktestResult {
  id: string;
  strategyId: string;
  config: StrategyConfig;
  
  period: { start: string; end: string };
  
  // 基础指标
  metrics: {
    totalReturn: number;
    annualReturn: number;
    sharpeRatio: number;
    sortinoRatio: number;
    maxDrawdown: number;
    calmarRatio: number;
    winRate: number;
    profitFactor: number;
    avgTurnover: number;
  };
  
  // 成本分析
  costAnalysis: {
    grossReturn: number;      // 扣除成本前
    netReturn: number;        // 扣除成本后
    totalCosts: number;
    breakdown: {
      commission: number;
      slippage: number;
      marketImpact: number;
    };
  };
  
  // Walk-Forward结果 (Phase 9)
  walkForward?: WalkForwardResult;
  
  // 过拟合检测 (Phase 9)
  overfitDetection?: OverfitDetectionResult;
  
  // 归因分析 (Phase 13)
  attribution?: AttributionResult;
  
  // 时序数据
  timeSeries: {
    dates: string[];
    values: number[];
    benchmark: number[];
    drawdown: number[];
  };
  
  trades: Trade[];
  createdAt: string;
}
```

---

## 15. API端点设计

### 15.1 策略API

```
# 策略 CRUD
POST   /api/v1/strategies                    # 创建策略
GET    /api/v1/strategies                    # 列出策略
GET    /api/v1/strategies/{id}               # 获取策略详情
PUT    /api/v1/strategies/{id}               # 更新策略
DELETE /api/v1/strategies/{id}               # 删除策略

# 策略各层配置
PUT    /api/v1/strategies/{id}/universe      # 更新投资池
PUT    /api/v1/strategies/{id}/alpha         # 更新因子层
PUT    /api/v1/strategies/{id}/signal        # 更新信号层
PUT    /api/v1/strategies/{id}/risk          # 更新风险层
PUT    /api/v1/strategies/{id}/portfolio     # 更新组合层
PUT    /api/v1/strategies/{id}/execution     # 更新执行层
PUT    /api/v1/strategies/{id}/monitor       # 更新监控层

# 策略状态
POST   /api/v1/strategies/{id}/validate      # 验证策略
POST   /api/v1/strategies/{id}/deploy        # 部署策略
POST   /api/v1/strategies/{id}/pause         # 暂停策略
```

### 15.2 回测API

```
# 基础回测
POST   /api/v1/backtests                     # 提交回测
GET    /api/v1/backtests/{id}                # 获取回测结果

# 高级回测 (Phase 9)
POST   /api/v1/backtests/walk-forward        # Walk-Forward验证
POST   /api/v1/backtests/sensitivity         # 参数敏感性分析
POST   /api/v1/backtests/overfit-detection   # 过拟合检测
```

### 15.3 风险API (Phase 10)

```
# 风险分析
GET    /api/v1/risk/decomposition/{portfolio_id}  # 风险分解
POST   /api/v1/risk/stress-test              # 压力测试
GET    /api/v1/risk/var/{portfolio_id}       # VaR计算
GET    /api/v1/risk/factor-exposure/{portfolio_id} # 因子暴露
```

### 15.4 交易API (Phase 12)

```
# 账户
GET    /api/v1/trading/account               # 账户信息
GET    /api/v1/trading/positions             # 持仓查询

# 订单
POST   /api/v1/trading/orders                # 提交订单
GET    /api/v1/trading/orders/{id}           # 订单状态
DELETE /api/v1/trading/orders/{id}           # 撤销订单

# Paper Trading
POST   /api/v1/trading/paper/enable          # 启用模拟盘
POST   /api/v1/trading/paper/disable         # 关闭模拟盘
```

### 15.5 AI助手API

```
# AI助手
POST   /api/v1/assistant/chat                # 对话
POST   /api/v1/assistant/factor-recommend    # 因子推荐
POST   /api/v1/assistant/strategy-review     # 策略审查
POST   /api/v1/assistant/explain             # 概念解释
```

---

# 第五部分：实施计划

## 16. 页面修改清单

### 16.1 需要修改的页面

| 页面 | 路由 | 修改内容 | Phase |
|------|------|----------|:-----:|
| **策略构建器** | /strategy-builder | 5步→7步，双模式 | 8 |
| **因子实验室** | /factor-lab | AI对话，三种创建方式 | 8 |
| **回测中心** | /backtest | Walk-Forward，过拟合检测 | 9 |
| **风险中心** | /risk | 风险分解，压力测试 | 10 |
| **交易中心** | /trading | 券商对接，实时监控 | 12 |
| 仪表盘 | /dashboard | 归因概览 | 13 |

### 16.2 新增页面

| 页面 | 路由 | 功能 | Phase |
|------|------|------|:-----:|
| 压力测试 | /risk/stress-test | 情景分析 | 10 |
| 归因分析 | /analysis/attribution | Brinson/因子归因 | 13 |
| TCA分析 | /analysis/tca | 交易成本分析 | 13 |

---

## 17. 完整实施路线图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      完整实施路线图 (6-9个月)                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  2025 Q1                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  Phase 8: 策略构建增强 (3周)           1月                      │   │
│  │  ├── 7步流程UI                                                  │   │
│  │  ├── 信号层/风险层                                              │   │
│  │  ├── AI助手集成                                                 │   │
│  │  └── 双模式切换                                                 │   │
│  │                                                                 │   │
│  │  Phase 9: 回测引擎升级 (4周)           2月                      │   │
│  │  ├── Walk-Forward验证                                           │   │
│  │  ├── 过拟合检测                                                 │   │
│  │  └── 偏差检测增强                                               │   │
│  │                                                                 │   │
│  │  Phase 10: 风险系统升级 (4周)          3月                      │   │
│  │  ├── 风险因子模型                                               │   │
│  │  ├── 压力测试                                                   │   │
│  │  └── 实时监控                                                   │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  2025 Q2                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  Phase 11: 数据层升级 (4周)            4月                      │   │
│  │  ├── 分钟级数据                                                 │   │
│  │  ├── TimescaleDB                                                │   │
│  │  └── 日内因子                                                   │   │
│  │                                                                 │   │
│  │  Phase 12: 执行层升级 (4周)            5月                      │   │
│  │  ├── 券商API对接                                                │   │
│  │  ├── 滑点模型                                                   │   │
│  │  └── Paper Trading                                              │   │
│  │                                                                 │   │
│  │  Phase 13: 归因与报表 (3周)            6月                      │   │
│  │  ├── Brinson归因                                                │   │
│  │  ├── 因子归因                                                   │   │
│  │  └── TCA分析                                                    │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  2025 Q3                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │  Phase 14: 生产部署 (3周)              7月                      │   │
│  │  ├── 云部署                                                     │   │
│  │  ├── 安全加固                                                   │   │
│  │  └── 监控告警                                                   │   │
│  │                                                                 │   │
│  │  优化与稳定 (4周)                       8-9月                   │   │
│  │  ├── 性能优化                                                   │   │
│  │  ├── Bug修复                                                    │   │
│  │  └── 用户反馈迭代                                               │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 17.1 各Phase工时汇总

| Phase | 名称 | 预计工时 | 累计 |
|:-----:|------|:--------:|:----:|
| 8 | 策略构建增强 | 21天 | 21天 |
| 9 | 回测引擎升级 | 24天 | 45天 |
| 10 | 风险系统升级 | 27天 | 72天 |
| 11 | 数据层升级 | 23天 | 95天 |
| 12 | 执行层升级 | 28天 | 123天 |
| 13 | 归因与报表 | 19天 | 142天 |
| 14 | 生产部署 | 21天 | 163天 |
| **总计** || **163天** | **~8个月** |

---

## 18. 成本与资源估算

### 18.1 数据成本

| 项目 | 月成本 | 年成本 | 说明 |
|------|:------:|:------:|------|
| 日线数据 | $0-50 | $0-600 | Yahoo/Alpaca免费 |
| 分钟数据 | $200-500 | $2,400-6,000 | Polygon.io |
| PIT财务数据 | $50 | $500 | Sharadar |
| **数据小计** | **$250-600** | **$2,900-7,100** ||

### 18.2 基础设施成本

| 项目 | 月成本 | 年成本 | 说明 |
|------|:------:|:------:|------|
| 云服务器 | $200-500 | $2,400-6,000 | AWS ECS |
| 数据库 | $100-200 | $1,200-2,400 | RDS + TimescaleDB |
| 缓存 | $50-100 | $600-1,200 | ElastiCache |
| 存储 | $50-100 | $600-1,200 | S3 |
| **基础设施小计** | **$400-900** | **$4,800-10,800** ||

### 18.3 服务成本

| 项目 | 月成本 | 年成本 | 说明 |
|------|:------:|:------:|------|
| Claude API | $50-200 | $600-2,400 | AI助手 |
| 券商 | $0 | $0 | Alpaca免费 |
| 监控告警 | $20-50 | $240-600 | CloudWatch |
| **服务小计** | **$70-250** | **$840-3,000** ||

### 18.4 总成本汇总

| 类别 | 月成本范围 | 年成本范围 |
|------|:----------:|:----------:|
| 数据 | $250-600 | $2,900-7,100 |
| 基础设施 | $400-900 | $4,800-10,800 |
| 服务 | $70-250 | $840-3,000 |
| **总计** | **$720-1,750** | **$8,540-20,900** |

---

# 附录

## 附录A: 日内交易模块设计

> **状态**: 待实施 (Phase 15+)  
> **优先级**: P3

### A.1 日内交易 vs 日频策略

| 维度 | 日频策略 | 日内交易 |
|------|----------|----------|
| 数据频率 | 日线 | 分钟/Tick |
| 持仓时间 | 天~月 | 分钟~小时 |
| 核心指标 | 因子IC、夏普 | 胜率、盈亏比 |
| 主要成本 | 换手率×成本 | 滑点+点差 |
| 容量 | 大 | 小 |
| 关注点 | 因子有效性 | 订单流+微观结构 |

### A.2 日内核心指标

```typescript
const intradayIndicators = {
  // 量价指标
  relative_volume: '相对成交量 = 当前量/历史同时段均量',
  vwap_deviation: 'VWAP偏离 = (价格-VWAP)/VWAP',
  volume_momentum: '成交量动量 = 近N分钟量/前N分钟量',
  
  // 买卖压力
  buy_pressure: '买压 = 主买量/(主买+主卖)',
  order_imbalance: '订单不平衡 = (买深度-卖深度)/总深度',
  large_order_ratio: '大单比例 = 大单量/总成交量',
  
  // 技术指标 (分钟级)
  rsi_5min: '5分钟RSI',
  macd_1min: '1分钟MACD',
};
```

### A.3 日内交易挑战

| 挑战 | 说明 | 解决方案 |
|------|------|----------|
| 数据成本 | Tick数据$1000+/月 | 先用分钟数据 |
| 滑点 | 可达0.5-1%/次 | 精确建模 |
| 过拟合 | 分钟数据噪音大 | Walk-Forward |
| 执行延迟 | 毫秒级影响 | Co-location |
| 容量 | 日内策略容量有限 | 分散品种 |

---

## 附录B: 算子完整列表

### B.1 L0 核心工具算子 (17个)

```
rd(x, n)           # 保留n位小数
sign(x)            # 符号函数
abs_(x)            # 绝对值
ref(x, n)          # 引用n期前的值
diff(x, n)         # n期差分
delay(x, n)        # 滞后n期
delta(x, n)        # 变化量
std(x, n)          # n期标准差
sum_(x, n)         # n期求和
hhv(x, n)          # n期最高值
llv(x, n)          # n期最低值
ma(x, n)           # 简单移动平均
ema(x, n)          # 指数移动平均
sma(x, n, m)       # 平滑移动平均
wma(x, n)          # 加权移动平均
slope(x, n)        # 线性回归斜率
forcast(x, n)      # n期线性预测
```

### B.2 L1 时间序列算子 (19个)

```
ts_rank(x, n)      # n期时序排名
ts_min(x, n)       # n期最小值
ts_max(x, n)       # n期最大值
ts_argmax(x, n)    # n期最大值位置
ts_argmin(x, n)    # n期最小值位置
ts_mean(x, n)      # n期均值
decay_linear(x, n) # 线性衰减加权
decay_exp(x, n)    # 指数衰减加权
correlation(x,y,n) # n期相关系数
covariance(x,y,n)  # n期协方差
returns(x, n)      # n期收益率
product(x, n)      # n期连乘
stddev(x, n)       # 标准差
adv(x, n)          # n期平均成交量
count(cond, n)     # n期条件计数
sumif(x, cond, n)  # n期条件求和
barslast(cond)     # 距上次满足条件
cross(x, y)        # 金叉/死叉
future_returns(x,n)# n期未来收益 (仅回测)
```

### B.3 L2 横截面算子 (10个)

```
rank(x)            # 横截面排名
cs_rank(x)         # 横截面排名 (同上)
percentile(x, p)   # 横截面分位数
zscore(x)          # 横截面标准化
cs_zscore(x)       # 横截面标准化 (同上)
scale(x)           # 缩放到[-1,1]
winsorize(x, l, u) # 缩尾处理
industry_neutralize(x, ind) # 行业中性化
min_(a, b)         # 取较小值
max_(a, b)         # 取较大值
if_(cond, a, b)    # 条件选择
signedpower(x, e)  # 带符号的幂
```

### B.4 L3 技术指标算子 (11个)

```
rsi(x, n)          # 相对强弱指数
macd(x, f, s, sig) # MACD
boll(x, n, std)    # 布林带
atr(h, l, c, n)    # 平均真实波幅
kdj(h, l, c, n, m) # KDJ指标
emv(h, l, v, n)    # 简易波动
mass(h, l, n, m)   # 梅斯线
dpo(c, n)          # 区间震荡
ktn(c, h, l, n, m) # 肯特纳通道
brar(o, h, l, c, n)# 情绪指标
dfma(c, s, l)      # 平行线差
```

---

## 附录C: Agent提示词模板

### C.1 策略助手

```
你是 QuantVision 的策略助手。你的职责是：

1. 引导用户完成7步策略配置
2. 解释每个选项的含义和影响
3. 根据用户目标推荐配置
4. 提示潜在风险和注意事项

重要原则：
- 你是教育者和助手，不是投资顾问
- 不要预测市场，不要做投资建议
- 强调风险，鼓励用户理解而非盲目跟随
- 解释"为什么"比告诉"怎么做"更重要

输出格式：
{
  "explanation": "解释内容",
  "suggestions": ["建议1", "建议2"],
  "warnings": ["注意事项"],
  "educationalNote": "学习要点"
}
```

### C.2 因子助手

```
你是 QuantVision 的因子助手。你的职责是：

1. 根据用户描述推荐合适的因子
2. 解释因子的原理和适用场景
3. 帮助用户理解因子参数
4. 分析因子测试结果

重要原则：
- 推荐已有的、经过验证的因子
- 不要承诺因子未来一定有效
- 解释因子背后的投资逻辑
- 提醒过拟合风险

输出格式：
{
  "recommendedFactors": [
    {
      "name": "因子名",
      "expression": "表达式",
      "rationale": "推荐理由",
      "risks": ["风险点"]
    }
  ],
  "explanation": "解释内容"
}
```

---

**文档版本**: 3.0  
**最后更新**: 2025-01-01  
**作者**: QuantVision Team
